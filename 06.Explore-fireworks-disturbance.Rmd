# (PART) Fireworks disturbance {-}

# Exploring fireworks disturbance

We have so far:

1. Pre-processed the radar data, by removing clutter and applying the range-bias correction [@kranstauber2020].
2. Annotated the PPIs with land use classes, distance to urban areas and (human) population density.
3. Annotated the PPIs with corresponding count locations for the Sovon data.
4. Connected the Sovon count data with life-history characteristics for the species contained within.

With the annotated PPIs and the processed Sovon counts, we can start to explore the relation between fireworks disturbance and the birds measured aloft during NYE 2017-2018.

The following parameters we assume are important predictors for measured bird densities aloft:

1. The number of birds on the ground.
2. The average mass of the birds on the ground.
3. The take-off habitat of these birds
4. The population density in the vicinity of birds, corrected for the distance to urban areas.

## Setting-up the environment

Load the required packages.

```{r setup_exploration_environment}
library(mgcv)
library(ggplot2)
library(dplyr)
library(tidyr)
library(ggdark)
library(bioRad)
library(raster)
```

And the files we have generated so far.

```{r load_prepared_ppis_and_sovon_counts}
ppi_hrw <- readRDS("data/processed/corrected-ppis-lu-sovon/corrected_ppi_hrw_lu_sovon.RDS")
ppi_dhl <- readRDS("data/processed/corrected-ppis-lu-sovon/corrected_ppi_dhl_lu_sovon.RDS")

ptt_raw <- readRDS("data/processed/sovon/ptt.RDS")
wb_raw <- readRDS("data/processed/sovon/wb.RDS")
```

## Calculating bird parameters

We need to calculate the number of birds on the ground and average mass of these birds

```{r calculate_birds_parameters}
wb_raw %>%
  mutate(area_nr = as.character(area_nr)) %>%
  filter(year == 2018) %>%
  group_by(area_nr) %>%
  summarise(nr_birds = sum(number),
            avg_mass = weighted.mean(mean_weight, number)) %>%
  ungroup() %>%
  group_by(area_nr) %>%
  summarise(nr_birds = mean(nr_birds),
            avg_mass = mean(avg_mass)) -> wb

ptt_raw %>%
  filter(year == 2017) %>%
  group_by(route) %>%
  summarise(nr_birds = sum(number),
            avg_mass = weighted.mean(mean_weight, number)) %>%
  ungroup() %>%
  group_by(route) %>%
  summarise(nr_birds = mean(nr_birds),
            avg_mass = mean(avg_mass)) -> ptt
```

Ideally, both the `wb` and `ptt` datasets cover somewhat different species compositions. We can easily see this if we visualise the distributions of `mean_weight` for these datasets.

```{r compare_distributions_of_avg_mass}
bind_rows(dplyr::select(wb, nr_birds, avg_mass), dplyr::select(ptt, nr_birds, avg_mass), .id = "source") %>%
  mutate(source = case_when(
    source == 1 ~ "WB",
    source == 2 ~ "PTT"
  )) %>%
  ggplot(aes(x = avg_mass)) +
  geom_density(aes(group = source, color = source)) +
  labs(title = "Distribution of average mass in PTT and Waterbird counts")
```

And indeed, the distributions of `avg_mass` for PTT counts is shifted considerably to lower average weights.

## Connecting Sovon counts with the PPIs

Now that we have calculated the necessary 'bird parameters', we can attach these to the PPIs using a few simple `left_join`s. Subsequently, we will recalculate the `avg_mass` as the mean of average masses in the PTT and waterbird counts, and `nr_birds` by adding the numbers of birds in the PTT and waterbird counts together. The former is probably not particularly useful, so probably best to throw out at some point.

```{r link_counts_with_PPIs, results='hold'}
ppi_hrw$data@data %>%
  left_join(dplyr::select(wb, area_nr, nr_birds, avg_mass), by = c("wb_area_nr" = "area_nr")) %>%
  rename(wb_nr_birds = nr_birds, wb_avg_mass = avg_mass) %>%
  group_by(wb_area_nr) %>%
  mutate(wb_nr_birds = wb_nr_birds / n()) %>%
  ungroup() %>%
  left_join(dplyr::select(ptt, route, nr_birds, avg_mass), by = c("ptt_route" = "route")) %>%
  rename(ptt_nr_birds = nr_birds, ptt_avg_mass = avg_mass) %>%
  group_by(ptt_route) %>%
  mutate(ptt_nr_birds = ptt_nr_birds / n()) %>%
  ungroup() %>%
  mutate(nr_birds = wb_nr_birds + ptt_nr_birds,
         avg_mass = mean(c(wb_avg_mass, ptt_avg_mass), na.rm = TRUE)) -> ppi_hrw$data@data

ppi_dhl$data@data %>%
  left_join(dplyr::select(wb, area_nr, nr_birds, avg_mass), by = c("wb_area_nr" = "area_nr")) %>%
  rename(wb_nr_birds = nr_birds, wb_avg_mass = avg_mass) %>%
  group_by(wb_area_nr) %>%
  mutate(wb_nr_birds = wb_nr_birds / n()) %>%
  ungroup() %>%
  left_join(dplyr::select(ptt, route, nr_birds, avg_mass), by = c("ptt_route" = "route")) %>%
  rename(ptt_nr_birds = nr_birds, ptt_avg_mass = avg_mass) %>%
  group_by(ptt_route) %>%
  mutate(ptt_nr_birds = ptt_nr_birds / n()) %>%
  ungroup() %>%
  mutate(nr_birds = wb_nr_birds + ptt_nr_birds,
         avg_mass = mean(c(wb_avg_mass, ptt_avg_mass), na.rm = TRUE)) -> ppi_dhl$data@data
```

## Correcting for dispersion

As birds can cross substantial distances within 5 minutes (the period a single scan takes), we somehow have to take this into account during the modelling. A simple approach is to 'smooth' out the numbers of birds in space, by averaging the bird numbers within a given window around a focal cell. We will create a simple function to do that

```{r smooth_bird_numbers_in_space}
smooth_ppi <- function(ppi, var, gridsize = c(3, 3)) {
  weights <- matrix(1, nrow = gridsize[1], ncol = gridsize[2])
  
  smooth_raster <- raster(ppi$data[var])
  smooth_nonan <- smooth_raster
  smooth_nonan[is.na(smooth_nonan)] <- 0
  smooth_raster <- focal(smooth_nonan, w = weights, fun = mean, pad = TRUE, padValue = 0)
  
  return(unlist(as.data.frame(as(smooth_raster, "Raster"))))
}

ppi_hrw$data$birds_smooth_9 <- smooth_ppi(ppi_hrw, "wb_nr_birds")
ppi_hrw$data$birds_smooth_15 <- smooth_ppi(ppi_hrw, "wb_nr_birds", gridsize = c(5, 5))
```

```{r plot_PPIs, results='hold'}
plot(ppi_hrw, param = "ptt_nr_birds", zlim = c(min(ppi_hrw$data@data$ptt_nr_birds, na.rm = TRUE), quantile(ppi_hrw$data@data$ptt_nr_birds, 0.95, na.rm = TRUE)))
plot(ppi_hrw, param = "wb_nr_birds", zlim = c(min(ppi_hrw$data@data$wb_nr_birds, na.rm = TRUE), quantile(ppi_hrw$data@data$wb_nr_birds, 0.95, na.rm = TRUE)))
plot(ppi_hrw, param = "VIR", zlim = c(min(ppi_hrw$data$VIR), quantile(ppi_hrw$data$VIR, 0.99)))
```







```{r gam_model_sample, results='hold'}
ppi_hrw_mass <- ppi_hrw$data@data

ppi_hrw_mass %>%
  filter(VIR > 50 & wb_nr_birds > 0 & type == "rural" & VIR < quantile(ppi_hrw_mass$VIR, 0.99, na.rm = TRUE)) %>%
  # filter(birds_smooth_9 < quantile(ppi_hrw_mass$birds_smooth_9, 0.99, na.rm = TRUE)) %>%
  mutate(vid_new = VIR / wb_avg_mass,
         # pop_eff = pop / (dist_urban / 1000),
         pop_eff = pop * (1 / dist_urban),
         birds_smooth_log = log(birds_smooth_9)) %>%
  group_by(pop_eff) %>%
  mutate(avg_mass_pop = mean(wb_avg_mass),
         avg_birds_pop = mean(birds_smooth_9),
         sum_birds_pop = sum(birds_smooth_9),
         sum_vid_pop = sum(vid_new),
         birds = mean(c(birds_smooth_9, wb_nr_birds), drop.na = TRUE)) %>%
  ungroup() %>%
  mutate(sum_birds_pop = scale(sum_birds_pop, scale = TRUE, center = TRUE) * 10 + 10,
         sum_vid_pop = scale(sum_vid_pop, scale = TRUE, center = TRUE) * 10 + 10) %>%
  group_by(vid_new) %>%
  mutate(avg_mass_pop_vid = mean(wb_avg_mass),
         avg_birds_pop_vid = mean(birds_smooth_9)) %>%
  ungroup() %>%
  mutate(landuse_overall = 
           case_when(
             (landuse >= 100 & landuse < 200) ~ "Urban",
             (landuse >= 200 & landuse < 300) ~ "Agricultural areas",
             (landuse >= 300 & landuse < 500) ~ "Natural areas",
             (landuse >= 500 & landuse < 999) ~ "Water bodies"
           )) %>%
  dplyr::select(VIR, wb_nr_birds, birds_smooth_9, birds_smooth_15, pop, dist_urban, pop_eff, landuse_overall) %>%
  drop_na() -> ppi_mdl
  # drop_na() -> ppi_mdl
# ppi_hrw$data@data %>%
#   filter(VIR > 0 & VIR < quantile(ppi_hrw$data@data$VIR, 0.99, na.rm = TRUE)) %>%
#   filter(birds_smooth_9 > 0 & birds_smooth_9 < quantile(ppi_hrw$data@data$VIR, 0.99, na.rm = TRUE)) %>%
#   filter(type == "rural") %>%
#   mutate(landuse_overall = case_when(
#              (landuse >= 100 & landuse < 200) ~ "Urban",
#              (landuse >= 200 & landuse < 300) ~ "Agriculture",
#              (landuse >= 300 & landuse < 500) ~ "Nature",
#              (landuse >= 500 & landuse < 999) ~ "Water bodies"
#            )) %>%
#   drop_na() -> ppi_mdl

# m1 <- glm(VIR ~ wb_nr_birds + pop + dist_urban + landuse_overall, data = ppi_mdl, family = Gamma(link = "log"))
m1 <- gam(VIR ~ s(wb_nr_birds) + s(pop) + s(dist_urban, k = 20) + landuse_overall,
data = ppi_mdl, method = "REML", family = Gamma(link = "log"))
# gam(vid_new ~ s(birds_smooth_9, k = 20) + s(pop) + s(dist_urban) + s(pop_eff) + landuse_overall, data = ppi_mdl, method = "REML", family = Gamma(link = "log")) -> m1
summary(m1)
plot(m1)
gam.check(m1)
# with(summary(m1), 1 - deviance/null.deviance)
```
