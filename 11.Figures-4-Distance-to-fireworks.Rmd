# Figure 4: Distance to fireworks

Finally, we also want to visualize how far away from fireworks birds are located. As we calculate them from a raster, when birds are close to fireworks, distances are increasing in discrete steps, whereas when they're further away it becomes more continuous (more possible distances with more grid points). As this makes for an ugly plot, we stick to a good ol' donutchart to visualize the changing distributions of birds relative to fireworks.

## Processing environment

```{r processing_environment_distance_to_fireworks, warning=FALSE, message=FALSE}
library(ggplot2)
library(dplyr)
library(tidyr)
library(tibble)
library(ggpubr)
library(forcats)
library(stringr)
library(broom)
library(patchwork)
library(ggridges)
library(ggpointdensity)
```

```{r}
data_cleaned <- readRDS("data/models/data_cleaned.RDS")
baseline_ppis <- readRDS("data/processed/baseline_ppis.RDS")
baseline_all <- bind_rows(baseline_ppis)

data_all <- readRDS("data/processed/composite-ppis/500m/201712312305.RDS")$data@data %>%
  dplyr::select("pixel", "wb_area_nr", "ptt_route", "wb_total_birds", "ptt_total_birds", "total_birds", "weighted_mean_crs") %>%
  rename(mean_rcs = weighted_mean_crs)

data_cleaned %>%
  left_join(data_all, by = "pixel") -> data_cleaned

wb_props <- readRDS("data/processed/sovon/wb_props.RDS") %>%
  dplyr::select("area_nr", "Geese", "Ducks", "Crows", "Pigeons", "Waders", "Thrushes", "Finches", "Tits")

ptt_props <- readRDS("data/processed/sovon/ptt_props.RDS") %>%
  dplyr::select("route", "Geese", "Ducks", "Crows", "Pigeons", "Waders", "Thrushes", "Finches", "Tits")

data_cleaned %>%
  left_join(wb_props, by = c("wb_area_nr" = "area_nr")) %>%
  left_join(ptt_props, by = c("ptt_route" = "route")) %>%
  rowwise() %>%
  mutate(Geese = mean(c(Geese.x, Geese.y), na.rm = TRUE),
         Ducks = mean(c(Ducks.x, Ducks.y), na.rm = TRUE),
         Crows = mean(c(Crows.x, Crows.y), na.rm = TRUE),
         Pigeons = mean(c(Pigeons.x, Pigeons.y), na.rm = TRUE),
         Waders = mean(c(Waders.x, Waders.y), na.rm = TRUE),
         Thrushes = mean(c(Thrushes.x, Thrushes.y), na.rm = TRUE),
         Finches = mean(c(Finches.x, Finches.y), na.rm = TRUE),
         Tits = mean(c(Tits.x, Tits.y), na.rm = TRUE)) %>%
  ungroup() %>%
  mutate(VIDc = (10^VIR) / mean_rcs,
         VIDc = if_else(VIDc > 10000000, 1e-6, VIDc, 1e-6)) %>%
  dplyr::select(-c("Geese.x", "Geese.y", "Ducks.x", "Ducks.y", "Crows.x", "Crows.y", "Pigeons.x", "Pigeons.y",
                   "Waders.x", "Waders.y", "Thrushes.x", "Thrushes.y", "Finches.x", "Finches.y", "Tits.x", "Tits.y")) -> data_cleaned

prop_classes <- c("Geese", "Ducks", "Crows", "Pigeons", "Waders", "Thrushes", "Finches", "Tits")
data_cleaned["domprop"] <- names(data_cleaned)[which(names(data_cleaned) %in% prop_classes)][max.col(data_cleaned[prop_classes], "first")]

landuse_classes <- c("agricultural", "semiopen", "forests", "wetlands", "waterbodies")
data_cleaned["domclass"] <- names(data_cleaned)[which(names(data_cleaned) %in% landuse_classes)][max.col(data_cleaned[landuse_classes], "first")]

data_cleaned$VIR[data_cleaned$VIR < -1] <- -1

baseline_all %>%
  mutate(VIR = 10^VIR,
         prop_flight = VIR / total_rcs,
         VIR = log10(VIR)) %>%
  identity() -> baseline_all
```

```{r}
wb <- readRDS("data/processed/sovon/wb_props.RDS") %>%
  dplyr::select(total_birds, area_nr, Geese, Ducks, Crows, Pigeons, Waders, Thrushes, Finches, Tits) %>%
  pivot_longer(cols = Geese:Tits, names_to = "family", values_to = "prop_family") %>%
  mutate(birds = round(total_birds * prop_family),
         family = fct_relevel(as.factor(family), rev(prop_classes))) %>%
  filter(birds > 0) %>%
  left_join(dplyr::select(data_cleaned, wb_area_nr, dist_urban), by = c("area_nr" = "wb_area_nr")) %>%
  drop_na() %>%
  distinct(area_nr, family, dist_urban, .keep_all = TRUE) %>%
  uncount(birds) %>%
  slice_sample(n = 1000000) %>%
  dplyr::select(family, dist_urban) %>%
  identity()

ptt <- readRDS("data/processed/sovon/ptt_props.RDS") %>%
  dplyr::select(total_birds, route, Geese, Ducks, Crows, Pigeons, Waders, Thrushes, Finches, Tits) %>%
  pivot_longer(cols = Geese:Tits, names_to = "family", values_to = "prop_family") %>%
  mutate(birds = round(total_birds * prop_family),
         # family = as.factor(family),
         family = fct_relevel(as.factor(family), rev(prop_classes))) %>%
  filter(birds > 0) %>%
  left_join(dplyr::select(data_cleaned, ptt_route, dist_urban), by = c("route" = "ptt_route")) %>%
  drop_na() %>%
  distinct(route, family, dist_urban, .keep_all = TRUE) %>%
  uncount(birds) %>%
  slice_sample(n = 1000000) %>%
  dplyr::select(family, dist_urban) %>%
  identity()

wb %>%
  bind_rows(ptt) %>%
  ggplot() +
  geom_density_ridges(aes(x = dist_urban, y = family, fill = family), scale = 2.5, bandwidth = 275, rel_min_height = 0.005, color = "#ffffff") +
  scale_x_continuous(limits = c(0, max(data_cleaned$dist_urban)), breaks = c(0, 5000, 10000, 15000)) +
  scale_y_discrete(position = "left") +
  coord_cartesian(expand = FALSE) +
  theme_bw() +
  theme(legend.position = "none") +
  labs(x = "Distance to residential area (m)", y = "Rel. occurrence.") %>%
  identity() -> p_bird_families

p_bird_families
```

```{r}
data_cleaned %>%
  dplyr::select(agricultural:urban, domclass, dist_urban) %>%
  pivot_longer(cols = -c(domclass, dist_urban)) %>%
  filter(domclass == name) %>%
  ggplot(aes(x = dist_urban, y = fct_reorder(domclass, dist_urban, .fun = median, .desc = TRUE),
             fill = domclass)) +
  geom_density_ridges(scale = 4, rel_min_height = .005, color = "#ffffff") +
  scale_fill_manual(values = c("#73AF48", "#0F8554", "#EDAD08", "#1D6996", "#38A6A5")) +
  scale_color_manual(values = c("#73AF48", "#0F8554", "#EDAD08", "#1D6996", "#38A6A5")) +
  scale_x_continuous(limits = c(0, max(data_cleaned$dist_urban)), breaks = c(0, 5000, 10000, 15000)) +
  scale_y_discrete(position = "left") +
  coord_cartesian(expand = FALSE) +
  theme_bw() +
  theme(legend.position = "none") + 
  labs(x = "Distance to residential area (m)", y = "Rel. Occurrence") -> p_landuse

p_landuse
```


```{r}
disturbance_baseline <- readRDS("data/processed/disturbance_baseline.RDS")

min_VID <- 0.01

bppi <- lapply(baseline_ppis, function(x) {
  x %>%
    mutate(VIDc = if_else(VIDc < min_VID, min_VID, VIDc, min_VID))
})

db <- bind_rows(bppi)

disturbance_baseline <- mean(bind_rows(bppi)$VIDc, trim = 0.05)

alpha_baseline <- 0.5
alpha_ribbon <- 0.3
# set.seed(2)

data_cleaned %>%
  mutate(VIDc = if_else(VIDc < min_VID, min_VID, VIDc, min_VID)) %>%
  identity() %>%
  ggplot() +
  geom_pointdensity(aes(x = dist_urban, y = VIDc, size = total_rcs), alpha = 0.05, adjust = 2.5, method = "default") +
  # geom_pointdensity(aes(x = dist_urban, y = VIR, size = total_rcs), alpha = 0.05) +
  # geom_point(aes(x = dist_urban, y = VIR, size = total_rcs), color = "gray80", shape = 20, alpha = 0.2,
  #            data = data_cleaned %>% slice_sample(n = 10000)) +
  # geom_point(aes(x = dist_urban, y = VIR, size = total_rcs), color = "indianred2", alpha = 0.05,
  #            data = data_cleaned %>% slice_sample(n = 10000)) +
  # stat_density_2d(aes(x = dist_urban, y = VIR, color = after_stat(density)), geom = "point",
  #                 contour = FALSE, data = data_cleaned, n = 100) +
  # geom_density_2d(aes(x = dist_urban, y = VIR, color = domclass), data = data_cleaned) +
  # geom_density_2d_filled(aes(x = dist_urban, y = VIR), data = data_cleaned) +
  
  # Horizontal lines
  # geom_hline(yintercept = disturbance_baseline, color = "blue", linetype = "dashed") +
  # geom_hline(yintercept = mean(data_cleaned$VIDc, trim = 0.25), color = "red", linetype = "dashed") +
  # Smooths Undisturbed
  geom_ribbon(aes(x = dist_urban, y = VIDc), data = bppi[[1]], method = "gam", stat = "smooth",
              fill = "lightblue", alpha = alpha_ribbon) +
  geom_line(aes(x = dist_urban, y = VIDc), data = bppi[[1]], method = "gam", stat = "smooth", color = "blue", alpha = alpha_baseline) +
  geom_ribbon(aes(x = dist_urban, y = VIDc), data = bppi[[2]], method = "gam", stat = "smooth",
              fill = "lightblue", alpha = alpha_ribbon) +
  geom_line(aes(x = dist_urban, y = VIDc), data = bppi[[2]], method = "gam", stat = "smooth", color = "blue", alpha = alpha_baseline) +
  geom_ribbon(aes(x = dist_urban, y = VIDc), data = bppi[[3]], method = "gam", stat = "smooth",
              fill = "lightblue", alpha = alpha_ribbon) +
  geom_line(aes(x = dist_urban, y = VIDc), data = bppi[[3]], method = "gam", stat = "smooth", color = "blue", alpha = alpha_baseline) +
  geom_ribbon(aes(x = dist_urban, y = VIDc), data = bppi[[4]], method = "gam", stat = "smooth",
              fill = "lightblue", alpha = alpha_ribbon) +
  geom_line(aes(x = dist_urban, y = VIDc), data = bppi[[4]], method = "gam", stat = "smooth", color = "blue", alpha = alpha_baseline) +
  geom_ribbon(aes(x = dist_urban, y = VIDc), data = bppi[[5]], method = "gam", stat = "smooth",
              fill = "lightblue", alpha = alpha_ribbon) +
  geom_line(aes(x = dist_urban, y = VIDc), data = bppi[[5]], method = "gam", stat = "smooth", color = "blue", alpha = alpha_baseline) +
  # annotate("text", x = 14500, y = disturbance_baseline - 0.4, label = "Normal nights", hjust = 1, color = "blue", fontface = "bold") +
  # Smooths disturbed
  geom_ribbon(aes(x = dist_urban, y = VIDc), method = "gam", stat = "smooth", fill = "red", alpha = 0.2, color = "white") +
  geom_line(aes(x = dist_urban, y = VIDc), method = "gam", stat = "smooth", color = "red", alpha = 1) +
  # annotate("text", x = 15500, y = mean(data_cleaned$VIDc) + 0.4, label = "NYE", hjust = 1, color = "red", fontface = "bold") +
  scale_color_viridis_c(option = "inferno") +
  scale_y_continuous(trans = "log10", breaks = c(0.1, 1, 10, 100, 1000, 10000), 
                     labels = c("0.1", "1", "10", "100", "1000", "10000")) +
  # scale_y_continuous(trans = scales::pseudo_log_trans(base = 10), labels = function(x) {10^x}, breaks = c(-1, 0, 1, 2, 3, 4, 5, 6)) +
  # scale_y_continuous(labels = function(x) {10^x}, breaks = c(-1, 0, 1, 2, 3, 4, 5, 6)) +
  scale_x_continuous(breaks = c(0, 5000, 10000, 15000)) +
  theme_bw() +
  labs(x = "Distance to residential area (m)", y = "Nr. of birds in flight") +
  guides(color = guide_colorbar("Density"),
         size = guide_legend("Total RCS (cm2)")) +
  coord_cartesian(expand = FALSE, ylim = c(0.90e-2, 1e4)) +
  theme(legend.position = "bottom") -> p_response

p_response
```


















```{r}
alpha_baseline <- 0.5
alpha_ribbon <- 0.3

data_cleaned %>%
  identity() %>%
  ggplot(aes(x = dist_urban, y = VIR, size = total_rcs, alpha = after_stat(density))) +
  # Scatterplot
  geom_pointdensity()

  # # geom_pointdensity(aes(x = dist_urban, y = VIR, size = total_rcs), alpha = 0.05) +
  # # Horizontal lines
  # geom_hline(yintercept = mean(baseline_all$VIR), color = "blue", linetype = "dashed") +
  # geom_hline(yintercept = mean(data_cleaned$VIR), color = "red", linetype = "dashed") +
  # # Smooths Undisturbed
  # geom_ribbon(aes(x = dist_urban, y = VIR, group = dt), data = baseline_all, method = "gam", stat = "smooth", formula = y ~ s(x, bs = "cs"),
  #             fill = "lightblue", alpha = alpha_ribbon) +
  # geom_line(aes(x = dist_urban, y = VIR, group = dt), data = baseline_all, method = "gam", stat = "smooth", formula = y ~ s(x, bs = "cs"),
  #           color = "blue", alpha = alpha_baseline) +
  # # Smooths disturbed
  # geom_ribbon(aes(x = dist_urban, y = VIR), method = "gam", stat = "smooth", fill = "red", alpha = 0.2, formula = y ~ s(x, bs = "cs")) +
  # geom_line(aes(x = dist_urban, y = VIR), method = "gam", stat = "smooth", color = "red", alpha = 1, formula = y ~ s(x, bs = "cs")) +
  # # Annotations
  # annotate("text", x = 15500, y = mean(baseline_all$VIR) - 0.25, label = "Normal nights", hjust = 1, color = "blue", fontface = "bold") +
  # annotate("text", x = 15500, y = mean(data_cleaned$VIR) + 0.25, label = "NYE", hjust = 1, color = "red", fontface = "bold") +
  # # Theme & Styling
  # scale_color_viridis_c(option = "inferno") +
  # scale_y_continuous(labels = function(x) {10^x}, breaks = c(-1, 0, 1, 2, 3, 4, 5, 6)) +
  # scale_x_continuous(breaks = c(0, 5000, 10000, 15000)) +
  # theme_bw() +
  # labs(x = "Distance to residential area (m)", y = "VIR") +
  # guides(color = guide_colorbar("Density"),
  #        size = guide_legend("Total RCS (cm2)")) +
  # coord_cartesian(expand = FALSE, ylim = c(-1, 6)) -> p_response

# data_cleaned %>%
#   identity() %>%
#   ggplot() +
#   # Scatterplot
#   stat_pointdensity(aes(x = dist_urban, y = VIR, size = total_rcs, alpha = after_stat(density))) +
#   # geom_pointdensity(aes(x = dist_urban, y = VIR, size = total_rcs), alpha = 0.05) +
#   # Horizontal lines
#   geom_hline(yintercept = mean(baseline_all$VIR), color = "blue", linetype = "dashed") +
#   geom_hline(yintercept = mean(data_cleaned$VIR), color = "red", linetype = "dashed") +
#   # Smooths Undisturbed
#   geom_ribbon(aes(x = dist_urban, y = VIR, group = dt), data = baseline_all, method = "gam", stat = "smooth", formula = y ~ s(x, bs = "cs"),
#               fill = "lightblue", alpha = alpha_ribbon) +
#   geom_line(aes(x = dist_urban, y = VIR, group = dt), data = baseline_all, method = "gam", stat = "smooth", formula = y ~ s(x, bs = "cs"),
#             color = "blue", alpha = alpha_baseline) +
#   # Smooths disturbed
#   geom_ribbon(aes(x = dist_urban, y = VIR), method = "gam", stat = "smooth", fill = "red", alpha = 0.2, formula = y ~ s(x, bs = "cs")) +
#   geom_line(aes(x = dist_urban, y = VIR), method = "gam", stat = "smooth", color = "red", alpha = 1, formula = y ~ s(x, bs = "cs")) +
#   # Annotations
#   annotate("text", x = 15500, y = mean(baseline_all$VIR) - 0.25, label = "Normal nights", hjust = 1, color = "blue", fontface = "bold") +
#   annotate("text", x = 15500, y = mean(data_cleaned$VIR) + 0.25, label = "NYE", hjust = 1, color = "red", fontface = "bold") +
#   # Theme & Styling
#   scale_color_viridis_c(option = "inferno") +
#   scale_y_continuous(labels = function(x) {10^x}, breaks = c(-1, 0, 1, 2, 3, 4, 5, 6)) +
#   scale_x_continuous(breaks = c(0, 5000, 10000, 15000)) +
#   theme_bw() +
#   labs(x = "Distance to residential area (m)", y = "VIR") +
#   guides(color = guide_colorbar("Density"),
#          size = guide_legend("Total RCS (cm2)")) +
#   coord_cartesian(expand = FALSE, ylim = c(-1, 6)) -> p_response

# p_response
```


```{r}
alpha_baseline <- 0.5
alpha_ribbon <- 0.3

baseline_all %>%
  mutate(prop_flight = log10(prop_flight)) %>%
  filter(is.finite(prop_flight)) %>%
  identity() -> baseline

data_cleaned %>%
  mutate(VIR = 10^VIR,
         prop_flight = VIR / total_rcs,
         prop_flight = log10(prop_flight),
         VIR = log10(VIR)) %>%
  filter(is.finite(prop_flight)) %>%
  identity() -> data_cleaned

data_cleaned %>%
  ggplot() +
  # Scatterplot
  geom_pointdensity(aes(x = dist_urban, y = prop_flight, size = total_rcs), alpha = 0.05) +
  # Horizontal lines
  geom_hline(yintercept = mean(baseline$prop_flight), color = "blue", linetype = "dashed") +
  geom_hline(yintercept = mean(data_cleaned$prop_flight), color = "red", linetype = "dashed") +
  # Smooths Undisturbed
  geom_ribbon(aes(x = dist_urban, y = prop_flight, group = dt), data = baseline, method = "gam", stat = "smooth", 
              formula = y ~ s(x, bs = "cs"), fill = "lightblue", alpha = alpha_ribbon) +
  geom_line(aes(x = dist_urban, y = prop_flight, group = dt), data = baseline, method = "gam", stat = "smooth", 
            formula = y ~ s(x, bs = "cs"), color = "blue", alpha = alpha_baseline) +
  # Smooths disturbed
  geom_ribbon(aes(x = dist_urban, y = prop_flight), method = "gam", stat = "smooth", fill = "red", alpha = 0.2, formula = y ~ s(x, bs = "cs")) +
  geom_line(aes(x = dist_urban, y = prop_flight), method = "gam", stat = "smooth", color = "red", alpha = 1, formula = y ~ s(x, bs = "cs")) +
  # Annotations
  annotate("text", x = 15500, y = mean(baseline$prop_flight) - 0.25, label = "Normal nights", hjust = 1, color = "blue", fontface = "bold") +
  annotate("text", x = 15500, y = mean(data_cleaned$prop_flight) + 0.25, label = "NYE", hjust = 1, color = "red", fontface = "bold") +
  # Theme & Styling
  scale_color_viridis_c(option = "inferno") +
  scale_y_continuous(labels = function(x) 10^x, breaks = c(-5, -4, -3, -2, -1, 0, 1, 2), limits = c(-5, 2)) +
  scale_x_continuous(breaks = c(0, 5000, 10000, 15000)) +
  theme_bw() +
  labs(x = "Distance to residential area (m)", y = "Measured / Potential VIR (Total RCS)") +
  guides(color = guide_colorbar("Density"),
         size = guide_legend("Total RCS (cm2)")) +
  coord_cartesian(expand = FALSE) -> p_response_relative

p_response_relative
```

```{r}
(p_landuse / p_response / p_bird_families +
  plot_layout(heights = c(1.5, 2.5, 1.5), guides = "collect"))

ggsave("data/plots/distance_effect_absolute.pdf", width = 7, height = 7)
```

```{r}
(p_landuse / p_response_relative / p_bird_families +
  plot_layout(heights = c(1.5, 2.5, 1.5), guides = "collect"))

ggsave("data/plots/distance_effect_relative.pdf", width = 7, height = 7)
```





## Old

```{r clean_data_distance_to_fireworks}
selected_scan <- load("data/processed/pvol_selection.RData")
scan_dt <- str_extract(basename(pvol_dhl_path), "[0-9]{12}")
data <- readRDS(file.path("data/processed/composite-ppis/500m/", paste0(scan_dt, ".RDS")))$data@data

clean_data <- function(data, max_distance) {
  mdl_variables <- c("VIR", "dist_radar", "total_biomass", "total_crs",
                     "agricultural", "semiopen", "forests", "wetlands", "waterbodies", "urban",
                     "dist_urban", "human_pop", "disturb_pot", "pixel", "coverage", "class", "x", "y",
                     "wb_area_nr", "ptt_route")
  log10_variables <- c("dist_urban", "human_pop", "total_biomass", "dist_urban", "disturb_pot")
  
  data %>%
    dplyr::filter(coverage > 0,
                  class != 1,
                  total_biomass > 0,
                  dist_radar < max_distance,
                  urban < 0.1) %>%
    mutate(VIR = replace_na(VIR, 0.1),
           VIR = if_else(VIR == 0, 0.1, VIR),
           VIR = log10(VIR),
           disturb_pot = human_pop / dist_urban,
           total_biomass = total_biomass / 1000) %>%
    dplyr::select(all_of(mdl_variables)) %>%
    # filter_all(all_vars(is.finite(.))) %>%
    rename(total_rcs = total_crs) %>%
    identity() -> data_cleaned
  
  data_cleaned
}

data_cleaned <- clean_data(data, 66000)

wb_year <- 2018
ptt_year <- 2017
ptt <- readRDS("data/processed/sovon/ptt.RDS") %>% filter(year == ptt_year)
wb <- readRDS("data/processed/sovon/wb.RDS") %>% filter(year == wb_year)
```

```{r}
data_cleaned %>%
  select(dist_urban, wb_area_nr, ptt_route) %>%
  group_by(wb_area_nr) %>%
  mutate(mean_dist_urban_wb = mean(dist_urban, na.rm = TRUE)) %>%
  ungroup() %>%
  group_by(ptt_route) %>%
  mutate(mean_dist_urban_ptt = if_else(!is.na(ptt_route), mean(dist_urban, na.rm = TRUE), NA_real_)) %>%
  ungroup() %>%
  distinct(wb_area_nr, ptt_route, .keep_all = TRUE) %>%
  mutate(wb = !is.na(wb_area_nr),
         ptt = !is.na(ptt_route),
         type = case_when(
           wb & ptt ~ "both",
           wb ~ "wb", 
           ptt ~ "ptt"
         )) %>%
  filter(type != "both",
         dist_urban > 250) %>%
  identity() -> distances
head(distances, 10)
```


```{r create_bird_counts_distances_dataframe}
ptt %>%
  group_by(route) %>%
  summarise(total_birds_ptt = sum(number), .groups = "drop_last") -> ptt_birds

wb %>%
  group_by(area_nr) %>%
  summarise(total_birds_wb = sum(number), .groups = "drop_last") -> wb_birds

distances %>%
  left_join(ptt_birds, by = c("ptt_route" = "route")) %>%
  left_join(wb_birds, by = c("wb_area_nr" = "area_nr")) %>%
  rowwise() %>%
  mutate(total_birds = sum(c(total_birds_wb, total_birds_ptt), na.rm = TRUE)) %>%
  identity() -> birds
```

```{r create_distances_donutchart, results='hold'}
birds %>%
  arrange(dist_urban) %>%
  group_by(dist_urban) %>%
  mutate(total_birds = sum(total_birds)) %>%
  ungroup() %>%
  distinct(dist_urban, total_birds) %>%
  mutate(dist_class = case_when(
    dist_urban <= 500 ~ "<500m",
    dist_urban > 500 & dist_urban <= 1000 ~ "500-1000m",
    dist_urban > 1000 & dist_urban <= 2500 ~ "1000-2500m",
    dist_urban > 2500 & dist_urban <= 5000 ~ "2500-5000m",
    dist_urban > 5000 ~ ">5000m"
  )) %>%
  group_by(dist_class) %>%
  summarise(total_birds_interval = sum(total_birds), .groups = "drop_last") %>%
  mutate(dist = case_when(dist_class == "<500m" ~ 1,
                          dist_class == "500-1000m" ~ 2,
                          dist_class == "1000-2500m" ~ 3,
                          dist_class == "2500-5000m" ~ 4,
                          dist_class == ">5000m" ~ 5),
    dist_class = fct_reorder(as.factor(dist_class), dist, .desc = TRUE)) %>%
  ungroup() %>%
  mutate(total_prop = round((total_birds_interval / sum(total_birds_interval)) * 100),
         total_prop_str = paste0(total_prop, "%"),
         ymax = cumsum(total_prop),
         ymin = c(0, head(ymax, n=-1))) %>%
  arrange(dist) %>%
  identity() %>%
  ggdonutchart(x = "total_prop", label = "total_prop_str", lab.pos = "in", fill = "dist_class", color = "white", lab.adjust = 0,
             palette = rev(c("#94346e", "#c43d66", "#e85553", "#fd7a37", "#ffa600")))

# colorscale made using https://learnui.design/tools/data-color-picker.html and #94346e as starting point

ggsave("data/plots/distances.pdf", width = 4, height = 4)
```
