---
title: 'Fireworks Case-study'
author: "Bart Hoekstra"
bibliography: fireworks.bib
output:
  html_document:
    toc: true
    toc_float: true
    code_folding: show
---
# 1. Selecting firework take-off moment

For this study we select the moment of ‘en masse’ take-off of birds at the turn of the year. To make sure birds are still sufficiently ‘close’ to the take-off habitat, we pick the moment where the increase in `VIR` (vertically integrated reflectivity) is the highest. Based on experience, we would expect this to occur between 00:05 and 00:15 on January 1st, 2018, as people light the fireworks right after they have shared new year's wishes with each other.

## 1.1 Setting-up the processing environment

We use `vol2bird` included in the [bioRad package](http://adokter.github.io/bioRad) to calculate vertical profiles of reflectivity and to determine the take-off moment of birds. In this case that means we assume birds take off everywhere simultaneously, but that seems a realistic assumption given that lighting fireworks is synchronised by the time vs. the time of sunset.

```{r warning=FALSE}
library(bioRad)
library(ggplot2)
setwd("~/Development/fireworks/")
Sys.setenv(TZ = "UTC")
```

## 1.2. Calculate the vertical profiles

We calculate vertical profiles for the period between December 31st, 2017 22:00 and 01:00 UTC on January 1st, 2018, this corresponds with 23:00 til 02:00 Amsterdam time (UTC + 1).

```{r eval=FALSE, include=TRUE}
fireworks_scans <- Sys.glob(file.path("data/raw/pvol/fireworks-2017-2018", "*NL62*"))
cat("Files left to process: ", length(fireworks_scans), "\n")
i = 1
for (scan in fireworks_scans) {
  if (i %% 5 == 0) {
    cat(i, "... ")
  }
  
  vpfile_out <- sub("raw/pvol/fireworks-2017-2018", "processed/vp/fireworks-2017-2018", scan)
  try(calculate_vp(scan, vpfile = vpfile_out, verbose = FALSE, mount = dirname(fireworks_scans[1])))
  i = i + 1
}
```

## 1.3. Generate time-series of vertical profiles

```{r}
fireworks_vpfilepaths <- Sys.glob(file.path("data/processed/vp/fireworks-2017-2018", "*NL62*"))
fireworks_vpfiles <- read_vpfiles(fireworks_vpfilepaths)
fireworks_vpts <- bind_into_vpts(fireworks_vpfiles)
fireworks_vpts <- regularize_vpts(fireworks_vpts, interval = 5)
```

```{r}
start <- as.POSIXct("2017-12-31 22:00:00")
end <- as.POSIXct("2018-01-01 01:00:00")
indexes <- which(fireworks_vpts$datetime >= start & fireworks_vpts$datetime <= end)
plot(fireworks_vpts[indexes])
```

That plot shows exactly what we expect: low densities of birds aloft until roughly midnight (23:00 UTC), then very high densities of birds suddenly taking off.

## 1.4 Identifying moment of take-off

We integrate the time series of veritcal profiles, so we can calculate the `vir` derivative and determine in what volume scan birds really take to the skies.
```{r}
integrated <- integrate_profile(fireworks_vpts)
```

Plotting both the `vir` and its derivative.
```{r}
theme_set(theme_bw())
integrated$vir_deriv <- c(NA, diff(integrated$vir, 1))
ggplot(integrated[indexes, ], aes(x = datetime)) + 
  geom_line(aes(y = vir, colour = "vir")) +
  geom_line(aes(y = vir_deriv, colour = "vir_deriv")) +
  scale_color_manual(labels = c("VIR", expression(paste(Delta,"VIR/scan"))),
                     values = c("vir" = "black", "vir_deriv" = "red")) +
  labs(title = "Time series of Vertically Integrated Reflectivities (VIR)",
       subtitle = "NYE 2017-2018",
       x = "Time (CET)",
       y = "VIR",
       colour = NULL) +
  scale_x_datetime(breaks = integrated[indexes, "datetime"], date_labels = "%H:%M") +
  theme(axis.text.x = element_text(angle = -90, vjust = 0.1),
        panel.grid.minor = element_blank())
```

We can now identify which scan contains the moment of take-off:

```{r}
id <- which.max(integrated$vir_deriv[indexes])
integrated[id + min(indexes) - 1, ]
```

The datetime value for this record corresponds with the starttime of this scan, which we will continue to use in this study. We furthermore assume the moment of take-off in Den Helder is the same.

```{r}
fireworks_vpfilepaths[id + min(indexes) - 1]
```

