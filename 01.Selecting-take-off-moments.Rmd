# (PART) Weather radar data {-}

# Selecting firework take-off moment

For this study we select the moment of 'en masse' take-off of birds at the turn of the year. To make sure birds are still fairly 'close' to the take-off habitat, we therefore focus on the period where the increase in `VIR` (Vertically Integrated Reflectivity) is the highest. Based on experience, one would expect this to occur between 00:05 and 00:15 on January 1st, as people tend to light the fireworks right after they have shared New Year's wishes with each other.

## Setting up the processing environment

We use `vol2bird` included in the [bioRad package](http://adokter.github.io/bioRad) [@dokter_biorad_2019] to calculate the vertical profiles of reflectivity, from which we determine the exact take off moment of birds. This implies we assume birds take to the skies everywhere simultaneously, but that seems a realistic assumption given that the lighting of fireworks is synchronised by the local time, rather than the time of sunset/sunrise.

```{r setup-selecting-firework-take-off-moment, warning=FALSE, message=FALSE}
library(bioRad)
library(ggplot2)
library(dplyr)
library(tidyr)
Sys.setenv(TZ = "UTC")
```

## Calculate the vertical profiles

We calculate vertical profiles for the period between December 31st, 2017 22:00 and 01:00 UTC on January 1st, 2018, which corresponds with 23:00 til 02:00 local Amsterdam time (UTC + 1). It is not necessary to generate so many `vp` files, but it gives a better temporal overview if we add some 'temporal padding' around the fireworks event.

*Beware: to calculate the vertical profiles, a running instance of [Docker](https://www.docker.com) is required. This code chunk will only run in [full-reproduction mode](A1.Full-reproduction-mode.html).*

See Appendix [generating-vps-for-den-helder-radar] for a more detailed explanation why we limit `vp` generation of Den Helder to certain azimuths.

```{r generate_vps, eval=full_repro}
fireworks_scans <- Sys.glob(file.path("data/raw/pvol/fireworks-2017-2018", "*_ODIM.h5"))
cat("Files left to process: ", length(fireworks_scans), "\n")
i = 1
for (scan in fireworks_scans) {
  if (i %% 5 == 0) {
    cat(i, "... ")
  }
  
  vpfile_out <- sub("raw/pvol/fireworks-2017-2018", "processed/vp/fireworks-2017-2018", scan)
  if (grepl("RAD_NL61", vpfile_out)) {
    try(calculate_vp(scan, vpfile = vpfile_out, verbose = FALSE, mount = dirname(fireworks_scans[1]),
                     azim_min = 90, azim_max = 200))
  } else {
    try(calculate_vp(scan, vpfile = vpfile_out, verbose = FALSE, mount = dirname(fireworks_scans[1])))
  }
  i = i + 1
}
```

## Generate time series of vertical profiles

We can now generate a time series of vertical profiles and plot the bird densities to get an idea of what was going on during NYE of 2017-2018.

```{r generate_vp_timeseries}
fw_hrw_vpts <- Sys.glob(file.path("data/processed/vp/fireworks-2017-2018", "*NL62*")) %>%
  read_vpfiles() %>%
  bind_into_vpts() %>%
  regularize_vpts(interval = "auto")

fw_dhl_vpts <- Sys.glob(file.path("data/processed/vp/fireworks-2017-2018", "*NL61*")) %>%
  read_vpfiles() %>%
  bind_into_vpts() %>%
  regularize_vpts(interval = "auto")

start <- as.POSIXct("2017-12-31 22:00:00")
end <- as.POSIXct("2018-01-01 01:00:00")

indexes_hrw <- which(fw_hrw_vpts$datetime >= start & fw_hrw_vpts$datetime <= end)
indexes_dhl <- which(fw_dhl_vpts$datetime >= start & fw_dhl_vpts$datetime <= end) # Should mostly be identical

title_hrw <- expression("Herwijnen: volume density [#/km"^3 * "]")
title_dhl <- expression("Den Helder: volume density [#/km"^3 * "]")
plot(fw_hrw_vpts[indexes_hrw], main = title_hrw)
plot(fw_dhl_vpts[indexes_dhl], main = title_dhl)
```

Both plots for Herwijnen and Den Helder show exactly what we would expect: comparatively low densities of birds aloft leading up to midnight (23:00 CET), then suddenly a strong increase of birds right after midnight. For Den Helder this peak appears much more pronounced, whereas for Herwijnen the period of disturbance seems to take considerably longer. This is probably due to the vastly different environment around the radar site: Herwijnen is located solidly in the center of the country, whereas Den Helder is located close to the coast on a 'peninsula' with much less land in the surroundings, especially as `vol2bird` only takes into account rangegates within 5-35km of the radar.

## Identifying moment of take-off

We integrate the time series of vertical profiles, so we can calculate the `vir` derivatives and determine in what volume scan birds really take to the skies for each radar separately.

```{r identify_takeoff}
integrated_hrw <- integrate_profile(fw_hrw_vpts)
integrated_dhl <- integrate_profile(fw_dhl_vpts)

integrated_hrw$vir_deriv <- c(NA, diff(integrated_hrw$vir, 1))
integrated_dhl$vir_deriv <- c(NA, diff(integrated_dhl$vir, 1))

integrated_hrw$radar <- "Herwijnen"
integrated_dhl$radar <- "Den Helder"

integrated <- rbind(integrated_hrw, integrated_dhl)

integrated_l <- integrated %>%
  pivot_longer(-c("datetime", "radar"), names_to = "variable", values_to = "value") %>%
  filter(variable == "vir" | variable == "vir_deriv") %>%
  filter(datetime >= start & datetime <= end)

max_vir_deriv <- integrated_l %>%
  group_by(variable, radar) %>%
  filter(variable == "vir_deriv") %>%
  summarize(max_value = max(value), datetime = datetime[which.max(value)]) %>%
  arrange(radar)  # Sort so order remains the same

theme_set(theme_bw())
ggplot(integrated_l, aes(x = datetime)) +
  geom_line(aes(y = value, colour = radar, linetype = variable)) +
  scale_x_datetime(breaks = "10 min", date_labels = "%H:%M", expand = c(0, 0)) + 
  scale_color_manual(values = c("blue", "red")) +
  scale_linetype_discrete(name = "Line type", labels = c("VIR", expression(paste(Delta,"VIR/scan")))) + 
  labs(title = "Time series of Vertically Integrated Reflectivities (VIR)",
       subtitle = "NYE 2017-2018",
       x = "Time (CET)",
       y = "VIR",
       colour = "Radar",
       linetype = "Linetype") +
  theme(axis.text.x = element_text(angle = -90),
        panel.grid.minor = element_blank())
```

The plot shows a rapid increase in `VIR` in the first 15 and 20 minutes after midnight (23:00 CET) for the Den Helder and Herwijnen radar respectively. After that period, `VIR` starts to drop, faster for Den Helder than for Herwijnen, possibly as a result of birds dispersing from the North Holland mainland towards the IJsselmeer area, which we have deliberately excluded from the generation of the vertical profiles (by selecting azimuths that are above land).

To reduce the effect of bird dispersal on our analysis, we will thus define the take-off moment as the first 15 minutes after midnight (23:00 CET). We will use the moments of peak growth in `VIR` ($\Delta{VIR}$) to illustrate the data preprocessing with.

```{r identify_takeoff_scans}
max_vir_deriv[, 2:4]
```

```{r save_takeoff_scans}
pvol_folder <- "data/raw/pvol/fireworks-2017-2018/"
hrw_dt_str <- strftime(max_vir_deriv[[2, 4]], format = "%Y%m%d%H%M")
dhl_dt_str <- strftime(max_vir_deriv[[1, 4]], format = "%Y%m%d%H%M")

pvol_hrw_path <- paste(pvol_folder, "RAD_NL62_VOL_NA_", hrw_dt_str, "_ODIM.h5", sep = "")
pvol_dhl_path <- paste(pvol_folder, "RAD_NL61_VOL_NA_", dhl_dt_str, "_ODIM.h5", sep = "")

save(pvol_hrw_path, pvol_dhl_path, file = "data/processed/pvol_selection.RData")
```

So at first we will continue using the following files in this study:

- **Herwijnen**: ``r basename(pvol_hrw_path)``
- **Den Helder**: ``r basename(pvol_dhl_path)``

## Determining maximum range from radar to detect birds

We can assume that the flight altitudes derived from `vol2bird` are representative for flight altitudes throughout the country. Given that most of the disturbance happens at comparatively low altitudes, the radar is likely to 'overshoot' this entirely at substantial distances away from the radar where compensating for range-effects (e.g. using [@kranstauber2020]) will thus have no effect. Therefore we need to calculate the maximum range we could still feasibly measure birds aloft.

We define the minimum altitude a radar beam must propagate through as the heighest altitude during the fireworks event below which 90% of birds pass through. Assuming uniform distribution of flight altitudes, this would leave 5% of the numbers of birds aloft at range to apply range-bias correction with [@kranstauber2020].

```{r determine_range_of_overshoot, warning=FALSE}
alt_cutoff <- 0.90

dens_hrw <- get_quantity(fw_hrw_vpts[indexes_hrw], "dens")
dens_dhl <- get_quantity(fw_dhl_vpts[indexes_dhl], "dens")

apply(dens_hrw, 2, function(x) {min(which(cumsum(x) / sum(x) > alt_cutoff))}) %>%
  as.data.frame() %>%
  tibble::rownames_to_column() %>%
  rename("datetime" = "rowname", "height_bin" = 2) %>%
  mutate(datetime = as.POSIXct(datetime), radar = "Herwijnen") %>%
  mutate(height_bin = height_bin * fw_hrw_vpts$attributes$where$interval) -> altitudes_hrw

apply(dens_dhl, 2, function(x) {min(which(cumsum(x) / sum(x) > alt_cutoff))}) %>%
  as.data.frame() %>%
  tibble::rownames_to_column() %>%
  rename("datetime" = "rowname", "height_bin" = 2) %>%
  mutate(datetime = as.POSIXct(datetime), radar = "Den Helder") %>%
  mutate(height_bin = height_bin * fw_dhl_vpts$attributes$where$interval) -> altitudes_dhl

bind_rows(altitudes_hrw, altitudes_dhl) %>%
  filter(is.finite(height_bin)) %>%
  ggplot() +
  geom_line(aes(x = datetime, y = height_bin, group = radar, colour = radar)) +
  scale_x_datetime(breaks = "10 min", date_labels = "%H:%M", expand = c(0, 0)) + 
  scale_y_continuous(breaks = scales::pretty_breaks(20)) +
  scale_color_manual(values = c("blue", "red")) +
  labs(title = paste("Altitude below which ", alt_cutoff * 100, "% of birds fly", sep = ""),
       subtitle = "NYE 2017-2018",
       x = "Time (CET)",
       y = "Altitude",
       colour = "Radar") +
  theme(axis.text.x = element_text(angle = -90),
        panel.grid.minor = element_blank())
```

We can see in this plot, and the earlier `vpts` of Den Helder that there is substantial noise at higher altitudes causing odd spikes in the altitudes. It seems that an altitude of _800m_ as a cutoff point strikes a good balance for both Herwijnen and Den Helder radars. Now we can calculate the distance at which that height is the height of the lowest elevation (0.3 degrees) and round to the nearest kilometer. 

```{r determine_distance_cutoff}
altitude_cutoff <- 600
ranges <- seq(0, 180000, 100)
beamheights <- beam_height(ranges, 0.3)
nearest_index <- which(abs(beamheights - altitude_cutoff) == min(abs(beamheights - altitude_cutoff)))
distance_cutoff <- plyr::round_any(ranges[nearest_index], 1000)
distance_cutoff
```

So at roughly `r distance_cutoff / 1000` kilometers from the radar, the lowest elevation scan pierces the sky at an altitude (`r altitude_cutoff`m) where we could still expect ~`r (1 - alt_cutoff) * 100`% of birds to be above.
