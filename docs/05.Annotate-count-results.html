<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>5 Annotating count results | Fireworks</title>
  <meta name="description" content="Using ground-based bird counts and weather radar measurements to estimate numbers of birds aloft during NYE fireworks events." />
  <meta name="generator" content="bookdown 0.17 and GitBook 2.6.7" />

  <meta property="og:title" content="5 Annotating count results | Fireworks" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="Using ground-based bird counts and weather radar measurements to estimate numbers of birds aloft during NYE fireworks events." />
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="5 Annotating count results | Fireworks" />
  
  <meta name="twitter:description" content="Using ground-based bird counts and weather radar measurements to estimate numbers of birds aloft during NYE fireworks events." />
  

<meta name="author" content="Bart Hoekstra" />


<meta name="date" content="2020-02-28" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="04.Annotate-count-areas.html"/>
<link rel="next" href="References.html"/>
<script src="assets/jquery-2.2.3/jquery.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="assets/htmlwidgets-1.5.1/htmlwidgets.js"></script>
<script src="assets/plotly-binding-4.9.1/plotly.js"></script>
<script src="assets/typedarray-0.1/typedarray.min.js"></script>
<link href="assets/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
<script src="assets/crosstalk-1.0.0/js/crosstalk.min.js"></script>
<link href="assets/plotly-htmlwidgets-css-1.49.4/plotly-htmlwidgets.css" rel="stylesheet" />
<script src="assets/plotly-main-1.49.4/plotly-latest.min.js"></script>
<link href="assets/leaflet-1.3.1/leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-1.3.1/leaflet.js"></script>
<link href="assets/leafletfix-1.0.0/leafletfix.css" rel="stylesheet" />
<script src="assets/Proj4Leaflet-1.0.1/proj4-compressed.js"></script>
<script src="assets/Proj4Leaflet-1.0.1/proj4leaflet.js"></script>
<link href="assets/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet" />
<script src="assets/leaflet-binding-2.0.3/leaflet.js"></script>
<script src="assets/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script>
<script src="assets/leaflet-providers-plugin-2.0.3/leaflet-providers-plugin.js"></script>
<script src="assets/VIR-1/data_stars_VIRe268cb.txt"></script>
<script src="assets/joda-0.0.1/joda.js"></script>
<link href="assets/HomeButton-0.0.1/home-button.css" rel="stylesheet" />
<script src="assets/HomeButton-0.0.1/home-button.js"></script>
<script src="assets/HomeButton-0.0.1/easy-button-src.min.js"></script>
<script src="assets/VID-1/data_stars_VID90bd8a.txt"></script>
<script src="assets/R-1/data_stars_R7ebfc1.txt"></script>
<script src="assets/overlap-1/data_stars_overlapf52ab1.txt"></script>
<script src="assets/eta_sum-1/data_stars_eta_sum31f5c9.txt"></script>
<script src="assets/eta_sum_expected-1/data_stars_eta_sum_expectedae4f68.txt"></script>
<script src="assets/pop-1/data_stars_popc3082a.txt"></script>
<script src="assets/dist_urban-1/data_stars_dist_urbande4ab9.txt"></script>


<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li class="chapter" data-level="" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i>Preface</a><ul>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#abstract"><i class="fa fa-check"></i>Abstract</a></li>
<li class="chapter" data-level="" data-path="index.html"><a href="index.html#how-to-use-this-document"><i class="fa fa-check"></i>How to use this document</a></li>
</ul></li>
<li class="part"><span><b>I Weather radar data</b></span></li>
<li class="chapter" data-level="1" data-path="01.Selecting-take-off-moments.html"><a href="01.Selecting-take-off-moments.html"><i class="fa fa-check"></i><b>1</b> Selecting firework take-off moment</a><ul>
<li class="chapter" data-level="1.1" data-path="01.Selecting-take-off-moments.html"><a href="01.Selecting-take-off-moments.html#setting-up-the-processing-environment"><i class="fa fa-check"></i><b>1.1</b> Setting up the processing environment</a></li>
<li class="chapter" data-level="1.2" data-path="01.Selecting-take-off-moments.html"><a href="01.Selecting-take-off-moments.html#calculate-the-vertical-profiles"><i class="fa fa-check"></i><b>1.2</b> Calculate the vertical profiles</a></li>
<li class="chapter" data-level="1.3" data-path="01.Selecting-take-off-moments.html"><a href="01.Selecting-take-off-moments.html#generate-time-series-of-vertical-profiles"><i class="fa fa-check"></i><b>1.3</b> Generate time series of vertical profiles</a></li>
<li class="chapter" data-level="1.4" data-path="01.Selecting-take-off-moments.html"><a href="01.Selecting-take-off-moments.html#identifying-moment-of-take-off"><i class="fa fa-check"></i><b>1.4</b> Identifying moment of take-off</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html"><i class="fa fa-check"></i><b>2</b> Radar Data Preprocessing</a><ul>
<li class="chapter" data-level="2.1" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html#setting-up-the-pre-processing-environment"><i class="fa fa-check"></i><b>2.1</b> Setting-up the pre-processing environment</a></li>
<li class="chapter" data-level="2.2" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html#removing-electromagnetic-interference"><i class="fa fa-check"></i><b>2.2</b> Removing electromagnetic interference</a></li>
<li class="chapter" data-level="2.3" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html#filter-meteorology-using-the-depolarization-ratio"><i class="fa fa-check"></i><b>2.3</b> Filter meteorology using the depolarization ratio</a></li>
<li class="chapter" data-level="2.4" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html#remove-classified-precipitation-from-polar-volumes"><i class="fa fa-check"></i><b>2.4</b> Remove classified precipitation from polar volumes</a></li>
<li class="chapter" data-level="2.5" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html#filter-ground-clutter"><i class="fa fa-check"></i><b>2.5</b> Filter ground clutter</a></li>
<li class="chapter" data-level="2.6" data-path="02.Radar-data-preprocessing.html"><a href="02.Radar-data-preprocessing.html#range-bias-correction"><i class="fa fa-check"></i><b>2.6</b> Range-bias correction</a></li>
</ul></li>
<li class="part"><span><b>II Land use</b></span></li>
<li class="chapter" data-level="3" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html"><i class="fa fa-check"></i><b>3</b> Annotating land use</a><ul>
<li class="chapter" data-level="3.1" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#setting-up-the-annotation-environment"><i class="fa fa-check"></i><b>3.1</b> Setting up the annotation environment</a></li>
<li class="chapter" data-level="3.2" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#converting-the-land-use-map"><i class="fa fa-check"></i><b>3.2</b> Converting the land use map</a></li>
<li class="chapter" data-level="3.3" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#adding-land-use-classifications-to-the-ppis"><i class="fa fa-check"></i><b>3.3</b> Adding land use classifications to the PPIs</a></li>
<li class="chapter" data-level="3.4" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#classify-land-use-types-in-urban-vs.rural"><i class="fa fa-check"></i><b>3.4</b> Classify land use types in Urban vs. Rural</a></li>
<li class="chapter" data-level="3.5" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#calculate-distance-to-nearest-urban-area"><i class="fa fa-check"></i><b>3.5</b> Calculate distance to nearest urban area</a></li>
<li class="chapter" data-level="3.6" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#add-population-density"><i class="fa fa-check"></i><b>3.6</b> Add population density</a></li>
<li class="chapter" data-level="3.7" data-path="03.Annotate-land-use.html"><a href="03.Annotate-land-use.html#testing"><i class="fa fa-check"></i><b>3.7</b> Testing</a></li>
</ul></li>
<li class="part"><span><b>III Sovon counts</b></span></li>
<li class="chapter" data-level="4" data-path="04.Annotate-count-areas.html"><a href="04.Annotate-count-areas.html"><i class="fa fa-check"></i><b>4</b> Annotating count areas</a><ul>
<li class="chapter" data-level="4.1" data-path="04.Annotate-count-areas.html"><a href="04.Annotate-count-areas.html#setting-up-the-annotation-environment-1"><i class="fa fa-check"></i><b>4.1</b> Setting up the annotation environment</a></li>
<li class="chapter" data-level="4.2" data-path="04.Annotate-count-areas.html"><a href="04.Annotate-count-areas.html#annotate-ppis-with-waterbird-area-codes"><i class="fa fa-check"></i><b>4.2</b> Annotate PPIs with waterbird area codes</a></li>
<li class="chapter" data-level="4.3" data-path="04.Annotate-count-areas.html"><a href="04.Annotate-count-areas.html#annotate-ppis-with-point-transect-counts"><i class="fa fa-check"></i><b>4.3</b> Annotate PPIs with point-transect-counts</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="05.Annotate-count-results.html"><a href="05.Annotate-count-results.html"><i class="fa fa-check"></i><b>5</b> Annotating count results</a><ul>
<li class="chapter" data-level="5.1" data-path="05.Annotate-count-results.html"><a href="05.Annotate-count-results.html#setting-up-the-annotation-environment-2"><i class="fa fa-check"></i><b>5.1</b> Setting up the annotation environment</a></li>
<li class="chapter" data-level="5.2" data-path="05.Annotate-count-results.html"><a href="05.Annotate-count-results.html#loading-the-sovon-count-data"><i class="fa fa-check"></i><b>5.2</b> Loading the Sovon count data</a></li>
<li class="chapter" data-level="5.3" data-path="05.Annotate-count-results.html"><a href="05.Annotate-count-results.html#filteringpreprocessing-species-names"><i class="fa fa-check"></i><b>5.3</b> Filtering/preprocessing species names</a></li>
<li class="chapter" data-level="5.4" data-path="05.Annotate-count-results.html"><a href="05.Annotate-count-results.html#linking-life-history-traits-to-species"><i class="fa fa-check"></i><b>5.4</b> Linking life-history traits to species</a></li>
</ul></li>
<li class="part"><span><b>IV Other</b></span></li>
<li class="chapter" data-level="6" data-path="References.html"><a href="References.html"><i class="fa fa-check"></i><b>6</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Fireworks</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="annotating-count-results" class="section level1">
<h1><span class="header-section-number">5</span> Annotating count results</h1>
<p>For now, we are interested in calculating the following parameters for the count results:</p>
<ol style="list-style-type: decimal">
<li>The number of birds within every PPI pixel.</li>
<li>The average mass of the birds within every PPI pixel.</li>
</ol>
<p>We can derive the total numbers of birds comparatively easily from the bird counts by Sovon, but to calculate the average mass of the birds we need to link a database of life-history traits. For the latter we first need to translate the vernacular (modern) names of bird species to the scientific ones, so we can link both.</p>
<div id="setting-up-the-annotation-environment-2" class="section level2">
<h2><span class="header-section-number">5.1</span> Setting up the annotation environment</h2>
<div class="sourceCode" id="cb90"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb90-1" data-line-number="1"><span class="kw">library</span>(rgbif)</a>
<a class="sourceLine" id="cb90-2" data-line-number="2"><span class="kw">library</span>(stringr)</a>
<a class="sourceLine" id="cb90-3" data-line-number="3"><span class="kw">library</span>(readxl)</a>
<a class="sourceLine" id="cb90-4" data-line-number="4"><span class="kw">library</span>(dplyr)</a>
<a class="sourceLine" id="cb90-5" data-line-number="5"><span class="kw">library</span>(tidyr)</a>
<a class="sourceLine" id="cb90-6" data-line-number="6"><span class="kw">library</span>(readr)</a></code></pre></div>
</div>
<div id="loading-the-sovon-count-data" class="section level2">
<h2><span class="header-section-number">5.2</span> Loading the Sovon count data</h2>
<p>The count data is spread over a few sheets in an <code>xlsx</code> file, which we load here. For clarity, we rename all the columns to English and we filter out all counts (i.e. areas) where birds are not positively identified to species level. Although it would be possible to ‘fill’ these uncertain counts based on proportions, determining how to do that is not necessary for our purposes. Instead, we will just remove these counts altogether. Finally, subspecies identifiers for these species are removed, as we assume there is no variation between subspecies to negatively affect our results, nor does the database of life-history traits contain parameters for subspecies.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb91-1" data-line-number="1">sovon_data &lt;-<span class="st"> &quot;data/raw/sovon/tel_dec_jan_1718.xlsx&quot;</span></a>
<a class="sourceLine" id="cb91-2" data-line-number="2"></a>
<a class="sourceLine" id="cb91-3" data-line-number="3">data &lt;-<span class="st"> </span><span class="kw">data.frame</span>()</a>
<a class="sourceLine" id="cb91-4" data-line-number="4">sheets &lt;-<span class="st"> </span><span class="kw">excel_sheets</span>(sovon_data)</a>
<a class="sourceLine" id="cb91-5" data-line-number="5">sheets &lt;-<span class="st"> </span>sheets[<span class="op">-</span><span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">5</span>)]  <span class="co"># Sheet 1 and 5 contain PTT and roost counts respectively, so we ignore these for now, as they have to be processed differently</span></a>
<a class="sourceLine" id="cb91-6" data-line-number="6"></a>
<a class="sourceLine" id="cb91-7" data-line-number="7"><span class="co"># Explicit column types to suppress warnings thrown because of lacking euring codes for records with no birds</span></a>
<a class="sourceLine" id="cb91-8" data-line-number="8">coltypes &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;text&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;text&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>, <span class="st">&quot;numeric&quot;</span>)</a>
<a class="sourceLine" id="cb91-9" data-line-number="9"></a>
<a class="sourceLine" id="cb91-10" data-line-number="10"><span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(sheets)) {</a>
<a class="sourceLine" id="cb91-11" data-line-number="11">  data &lt;-<span class="st"> </span><span class="kw">rbind</span>(data, <span class="kw">read_excel</span>(sovon_data, <span class="dt">sheet =</span> sheets[i], <span class="dt">col_types =</span> coltypes))</a>
<a class="sourceLine" id="cb91-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb91-13" data-line-number="13"></a>
<a class="sourceLine" id="cb91-14" data-line-number="14">data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-15" data-line-number="15"><span class="st">  </span><span class="kw">drop_na</span>() <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># A few rows somehow contain no birds or species &#39;geen vogels&#39;</span></a>
<a class="sourceLine" id="cb91-16" data-line-number="16"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">count_id =</span> TELLING_ID, <span class="dt">area_nr =</span> GEBIEDSCODE, <span class="dt">year =</span> JAAR, <span class="dt">month =</span> MAAND, <span class="dt">day =</span> DAG, <span class="dt">start_time =</span> BEGINTIJD, <span class="dt">end_time =</span> EINDTIJD,</a>
<a class="sourceLine" id="cb91-17" data-line-number="17">         <span class="st">&quot;euring&quot;</span> =<span class="st"> &quot;EURING&quot;</span>, <span class="dt">species =</span> SOORT, <span class="dt">number =</span> Aantal, <span class="dt">xcoor =</span> XCOOR, <span class="dt">ycoor =</span> YCOOR) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-18" data-line-number="18"><span class="st">  </span><span class="kw">group_by</span>(area_nr) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-19" data-line-number="19"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">str_ends</span>(species, <span class="st">&quot;spec.&quot;</span>))) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out all counts with unidentified birds</span></a>
<a class="sourceLine" id="cb91-20" data-line-number="20"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">length</span>(<span class="kw">str_subset</span>(species, <span class="st">&quot; of &quot;</span>)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out all counts with either/or totals</span></a>
<a class="sourceLine" id="cb91-21" data-line-number="21"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">str_starts</span>(species, <span class="st">&quot;hybride&quot;</span>))) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out all counts with hybrids</span></a>
<a class="sourceLine" id="cb91-22" data-line-number="22"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-23" data-line-number="23"><span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb91-24" data-line-number="24"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">species =</span> <span class="kw">str_split</span>(species, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">(&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_trim</span>()) -&gt;<span class="st"> </span>wb_data  <span class="co"># And remove all subspecies identifications</span></a>
<a class="sourceLine" id="cb91-25" data-line-number="25"></a>
<a class="sourceLine" id="cb91-26" data-line-number="26"><span class="kw">head</span>(wb_data, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">count_id</th>
<th align="left">area_nr</th>
<th align="right">year</th>
<th align="right">month</th>
<th align="right">day</th>
<th align="right">start_time</th>
<th align="right">end_time</th>
<th align="right">euring</th>
<th align="left">species</th>
<th align="right">number</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1060908</td>
<td align="left">BR1111</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1045</td>
<td align="right">1108</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">280</td>
<td align="right">127723</td>
<td align="right">426233</td>
</tr>
<tr class="even">
<td align="right">1060908</td>
<td align="left">BR1111</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1045</td>
<td align="right">1108</td>
<td align="right">1700</td>
<td align="left">Nijlgans</td>
<td align="right">2</td>
<td align="right">127723</td>
<td align="right">426233</td>
</tr>
<tr class="odd">
<td align="right">1060909</td>
<td align="left">BR1112</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1108</td>
<td align="right">1126</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">76</td>
<td align="right">125082</td>
<td align="right">426701</td>
</tr>
<tr class="even">
<td align="right">1060909</td>
<td align="left">BR1112</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1108</td>
<td align="right">1126</td>
<td align="right">1661</td>
<td align="left">Grote Canadese Gans</td>
<td align="right">50</td>
<td align="right">125082</td>
<td align="right">426701</td>
</tr>
<tr class="odd">
<td align="right">1060909</td>
<td align="left">BR1112</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1108</td>
<td align="right">1126</td>
<td align="right">1700</td>
<td align="left">Nijlgans</td>
<td align="right">22</td>
<td align="right">125082</td>
<td align="right">426701</td>
</tr>
<tr class="even">
<td align="right">1060906</td>
<td align="left">BR1122</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1020</td>
<td align="right">1037</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">250</td>
<td align="right">125313</td>
<td align="right">426061</td>
</tr>
<tr class="odd">
<td align="right">1060906</td>
<td align="left">BR1122</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1020</td>
<td align="right">1037</td>
<td align="right">1619</td>
<td align="left">Soepgans</td>
<td align="right">5</td>
<td align="right">125313</td>
<td align="right">426061</td>
</tr>
<tr class="even">
<td align="right">1060906</td>
<td align="left">BR1122</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1020</td>
<td align="right">1037</td>
<td align="right">1661</td>
<td align="left">Grote Canadese Gans</td>
<td align="right">35</td>
<td align="right">125313</td>
<td align="right">426061</td>
</tr>
<tr class="odd">
<td align="right">1060911</td>
<td align="left">BR1130</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1145</td>
<td align="right">1200</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">200</td>
<td align="right">121962</td>
<td align="right">426420</td>
</tr>
<tr class="even">
<td align="right">1060911</td>
<td align="left">BR1130</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1145</td>
<td align="right">1200</td>
<td align="right">1661</td>
<td align="left">Grote Canadese Gans</td>
<td align="right">40</td>
<td align="right">121962</td>
<td align="right">426420</td>
</tr>
</tbody>
</table>
</div>
<p>Following this logic, we can process the PTT counts similarly and see which species are contained in those.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb92-1" data-line-number="1"><span class="kw">read_excel</span>(sovon_data, <span class="dt">sheet =</span> <span class="dv">1</span>) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-2" data-line-number="2"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">count_id =</span> tellingid, <span class="dt">route =</span> route, <span class="dt">count_point =</span> telpunt, <span class="dt">season =</span> seizoen, <span class="dt">year =</span> teljaar, <span class="dt">month =</span> maand, </a>
<a class="sourceLine" id="cb92-3" data-line-number="3">         <span class="dt">day =</span> dag, <span class="dt">euring =</span> euring, <span class="dt">species =</span> soort, <span class="dt">number =</span> aantal, <span class="dt">xcoor =</span> xcoor, <span class="dt">ycoor =</span> ycoor) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-4" data-line-number="4"><span class="st">  </span><span class="kw">group_by</span>(route, count_point) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-5" data-line-number="5"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">str_ends</span>(species, <span class="st">&quot;spec.&quot;</span>))) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out all counts with unidentified birds</span></a>
<a class="sourceLine" id="cb92-6" data-line-number="6"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">length</span>(<span class="kw">str_subset</span>(species, <span class="st">&quot; of &quot;</span>)) <span class="op">&gt;</span><span class="st"> </span><span class="dv">0</span>)) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out all counts with either/or totals</span></a>
<a class="sourceLine" id="cb92-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">str_starts</span>(species, <span class="st">&quot;hybride&quot;</span>))) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out all counts with hybrids</span></a>
<a class="sourceLine" id="cb92-8" data-line-number="8"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-9" data-line-number="9"><span class="st">  </span><span class="kw">rowwise</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb92-10" data-line-number="10"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">species =</span> <span class="kw">str_split</span>(species, <span class="st">&quot;</span><span class="ch">\\</span><span class="st">(&quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">str_trim</span>()) -&gt;<span class="st"> </span>ptt_data  <span class="co"># And remove all subspecies identifications-&gt; ptt_data</span></a>
<a class="sourceLine" id="cb92-11" data-line-number="11"></a>
<a class="sourceLine" id="cb92-12" data-line-number="12"><span class="kw">head</span>(ptt_data, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">count_id</th>
<th align="right">route</th>
<th align="right">count_point</th>
<th align="right">season</th>
<th align="right">year</th>
<th align="right">month</th>
<th align="right">day</th>
<th align="right">euring</th>
<th align="left">species</th>
<th align="right">number</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">720</td>
<td align="left">Aalscholver</td>
<td align="right">2</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">5920</td>
<td align="left">Zilvermeeuw</td>
<td align="right">18</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">6700</td>
<td align="left">Houtduif</td>
<td align="right">1</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">11870</td>
<td align="left">Merel</td>
<td align="right">4</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15630</td>
<td align="left">Roek</td>
<td align="right">24</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">6700</td>
<td align="left">Houtduif</td>
<td align="right">1</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">11870</td>
<td align="left">Merel</td>
<td align="right">1</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15600</td>
<td align="left">Kauw</td>
<td align="right">6</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15630</td>
<td align="left">Roek</td>
<td align="right">78</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">14620</td>
<td align="left">Pimpelmees</td>
<td align="right">2</td>
<td align="right">246692</td>
<td align="right">523139</td>
</tr>
</tbody>
</table>
</div>
</div>
<div id="filteringpreprocessing-species-names" class="section level2">
<h2><span class="header-section-number">5.3</span> Filtering/preprocessing species names</h2>
<p>The following section is the result of an iterative process aimed at matching species in our count data with species in the database of life-history characteristics. Unfortunately, automatic tools only get us so far, a bit of tweaking has to be done by hand. To reduce manual corrections needed, <em>only species to which &gt;1% of the birds belong in a single count</em> have been corrected manually. In other words: if a species which cannot be matched always accounts for less than 1% of the total number of birds within a count, this species is discarded from the whole dataset.</p>
<p>Besides the 1% criteria, both the waterbird and PTT counts contain some exotics (e.g. ‘Helmparelhoen’/Helmeted guineafowl) for which our life-history characteristics dataset does not contain any measurements anyways (there are others that we do have measurements of), some species that are very unlikely to ever take flight during NYE (e.g. ‘Kip’/Domesticated chicken) and some mammals for which the same applies. We will remove these from the dataset manually.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb93-1" data-line-number="1">exotics &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Helmparelhoen&quot;</span>, <span class="st">&quot;Kaapse Casarca&quot;</span>, <span class="st">&quot;Manengans&quot;</span>, <span class="st">&quot;Ringtaling&quot;</span>, <span class="st">&quot;Buffelkopeend&quot;</span>, <span class="st">&quot;Kokardezaagbek&quot;</span>, <span class="st">&quot;Chileense Flamingo&quot;</span>,</a>
<a class="sourceLine" id="cb93-2" data-line-number="2">             <span class="st">&quot;Kaapse Taling&quot;</span>, <span class="st">&quot;Bahamapijlstaart&quot;</span>, <span class="st">&quot;Muskuseend&quot;</span>, <span class="st">&quot;Zwarte Zwaan&quot;</span>, <span class="st">&quot;Knobbelgans&quot;</span>, <span class="st">&quot;Zwaangans&quot;</span>)</a>
<a class="sourceLine" id="cb93-3" data-line-number="3">unlikely_flight_candidate &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Kip&quot;</span>)</a>
<a class="sourceLine" id="cb93-4" data-line-number="4">mammals &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Damhert&quot;</span>, <span class="st">&quot;Haas&quot;</span>, <span class="st">&quot;Ree&quot;</span>, <span class="st">&quot;Bever&quot;</span>, <span class="st">&quot;Bruine Rat&quot;</span>, <span class="st">&quot;Muskusrat&quot;</span>, <span class="st">&quot;Mol&quot;</span>, <span class="st">&quot;Vos&quot;</span>, <span class="st">&quot;Kat&quot;</span>, <span class="st">&quot;Otter&quot;</span>, <span class="st">&quot;Grijze Zeehond&quot;</span>, <span class="st">&quot;Konijn&quot;</span>,</a>
<a class="sourceLine" id="cb93-5" data-line-number="5">             <span class="st">&quot;Eekhoorn&quot;</span>, <span class="st">&quot;Edelhert&quot;</span>, <span class="st">&quot;Gewone Zeehond&quot;</span>, <span class="st">&quot;Wild Zwijn&quot;</span>, <span class="st">&quot;Steenmarter&quot;</span>, <span class="st">&quot;Moeflon&quot;</span>)</a>
<a class="sourceLine" id="cb93-6" data-line-number="6">input_error &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;Steltstrandloper&quot;</span>)</a>
<a class="sourceLine" id="cb93-7" data-line-number="7">remove_species &lt;-<span class="st"> </span><span class="kw">c</span>(exotics, unlikely_flight_candidate, mammals, input_error)</a>
<a class="sourceLine" id="cb93-8" data-line-number="8"></a>
<a class="sourceLine" id="cb93-9" data-line-number="9">ptt_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb93-10" data-line-number="10"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>species <span class="op">%in%</span><span class="st"> </span>remove_species) -&gt;<span class="st"> </span>ptt_data</a>
<a class="sourceLine" id="cb93-11" data-line-number="11"></a>
<a class="sourceLine" id="cb93-12" data-line-number="12">wb_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb93-13" data-line-number="13"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span>species <span class="op">%in%</span><span class="st"> </span>remove_species) -&gt;<span class="st"> </span>wb_data</a></code></pre></div>
<p>With all these species removed or adjusted, we can create a species lookup table. We fetch the scientific names and corresponding GBIF species IDs from the <a href="https://doi.org/10.15468/rjdpzy">Checklist Dutch Species Register</a>, which is the GBIF dataset with key <code>4dd32523-a3a3-43b7-84df-4cda02f15cf7</code>. We furthermore remove all unnecessary information, such as subspecies from the scientific names as well.</p>
<div class="sourceCode" id="cb94"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb94-1" data-line-number="1">unique_species &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">c</span>(wb_data<span class="op">$</span>species, ptt_data<span class="op">$</span>species))</a>
<a class="sourceLine" id="cb94-2" data-line-number="2"></a>
<a class="sourceLine" id="cb94-3" data-line-number="3">build_species_lut &lt;-<span class="st"> </span><span class="cf">function</span>(specieslist, <span class="dt">datasetKey =</span> <span class="ot">NULL</span>, <span class="dt">higherTaxonKey =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb94-4" data-line-number="4">  <span class="co"># As this function can possibly return many different records, we pick the scientific name and GBIF ID (nubKey) that are the most</span></a>
<a class="sourceLine" id="cb94-5" data-line-number="5">  <span class="co"># common in the returned results. This should most often result in an OK result of the name lookup function.</span></a>
<a class="sourceLine" id="cb94-6" data-line-number="6">  Mode &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb94-7" data-line-number="7">    ux &lt;-<span class="st"> </span><span class="kw">unique</span>(<span class="kw">na.omit</span>(x))</a>
<a class="sourceLine" id="cb94-8" data-line-number="8">    ux[<span class="kw">which.max</span>(<span class="kw">tabulate</span>(<span class="kw">match</span>(x, ux)))]</a>
<a class="sourceLine" id="cb94-9" data-line-number="9">  }</a>
<a class="sourceLine" id="cb94-10" data-line-number="10">  </a>
<a class="sourceLine" id="cb94-11" data-line-number="11">  n &lt;-<span class="st"> </span><span class="kw">length</span>(specieslist)</a>
<a class="sourceLine" id="cb94-12" data-line-number="12">  </a>
<a class="sourceLine" id="cb94-13" data-line-number="13">  species_lut &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">lookupname =</span> <span class="kw">character</span>(n), </a>
<a class="sourceLine" id="cb94-14" data-line-number="14">                            <span class="dt">scientificname =</span> <span class="kw">character</span>(n), </a>
<a class="sourceLine" id="cb94-15" data-line-number="15">                            <span class="dt">gbif_key =</span> <span class="kw">numeric</span>(n), <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb94-16" data-line-number="16">  </a>
<a class="sourceLine" id="cb94-17" data-line-number="17">  <span class="cf">for</span>(i <span class="cf">in</span> <span class="kw">seq_along</span>(specieslist)) {</a>
<a class="sourceLine" id="cb94-18" data-line-number="18">    gbif_data &lt;-<span class="st"> </span><span class="kw">tryCatch</span>({</a>
<a class="sourceLine" id="cb94-19" data-line-number="19">      gbif &lt;-<span class="st"> </span><span class="kw">name_lookup</span>(specieslist[i], </a>
<a class="sourceLine" id="cb94-20" data-line-number="20">                          <span class="dt">datasetKey =</span> datasetKey, </a>
<a class="sourceLine" id="cb94-21" data-line-number="21">                          <span class="dt">higherTaxonKey =</span> higherTaxonKey, </a>
<a class="sourceLine" id="cb94-22" data-line-number="22">                          <span class="dt">return =</span> <span class="st">&quot;data&quot;</span>)</a>
<a class="sourceLine" id="cb94-23" data-line-number="23">      </a>
<a class="sourceLine" id="cb94-24" data-line-number="24">      <span class="kw">list</span>(<span class="kw">paste</span>(<span class="kw">str_split</span>(<span class="kw">Mode</span>(gbif<span class="op">$</span>scientificName), <span class="dt">pattern =</span> <span class="st">&quot; &quot;</span>)[[<span class="dv">1</span>]][<span class="dv">1</span><span class="op">:</span><span class="dv">2</span>], <span class="dt">collapse =</span> <span class="st">&quot; &quot;</span>), <span class="kw">Mode</span>(gbif<span class="op">$</span>nubKey))</a>
<a class="sourceLine" id="cb94-25" data-line-number="25">    }, <span class="dt">error =</span> <span class="cf">function</span>(e) {</a>
<a class="sourceLine" id="cb94-26" data-line-number="26">      <span class="kw">list</span>(<span class="st">&quot;&quot;</span>, <span class="ot">NaN</span>)</a>
<a class="sourceLine" id="cb94-27" data-line-number="27">    })</a>
<a class="sourceLine" id="cb94-28" data-line-number="28">    </a>
<a class="sourceLine" id="cb94-29" data-line-number="29">    species_lut[i, ] &lt;-<span class="st"> </span><span class="kw">c</span>(specieslist[i], gbif_data[<span class="dv">1</span>], <span class="kw">as.numeric</span>(<span class="kw">as.character</span>(gbif_data[<span class="dv">2</span>])))</a>
<a class="sourceLine" id="cb94-30" data-line-number="30">  }</a>
<a class="sourceLine" id="cb94-31" data-line-number="31">  </a>
<a class="sourceLine" id="cb94-32" data-line-number="32">  <span class="kw">return</span>(species_lut)</a>
<a class="sourceLine" id="cb94-33" data-line-number="33">}</a>
<a class="sourceLine" id="cb94-34" data-line-number="34"></a>
<a class="sourceLine" id="cb94-35" data-line-number="35">species_lut &lt;-<span class="st"> </span><span class="kw">build_species_lut</span>(unique_species, <span class="dt">datasetKey =</span> <span class="st">&quot;4dd32523-a3a3-43b7-84df-4cda02f15cf7&quot;</span>, <span class="dt">higherTaxonKey =</span> <span class="dv">162310263</span>)</a>
<a class="sourceLine" id="cb94-36" data-line-number="36"><span class="kw">head</span>(species_lut, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left">lookupname</th>
<th align="left">scientificname</th>
<th align="right">gbif_key</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Grauwe Gans</td>
<td align="left">Anser anser</td>
<td align="right">2498036</td>
</tr>
<tr class="even">
<td align="left">Nijlgans</td>
<td align="left">Alopochen aegyptiaca</td>
<td align="right">2498252</td>
</tr>
<tr class="odd">
<td align="left">Grote Canadese Gans</td>
<td align="left">Branta canadensis</td>
<td align="right">5232437</td>
</tr>
<tr class="even">
<td align="left">Soepgans</td>
<td align="left">Anser anser</td>
<td align="right">9384117</td>
</tr>
<tr class="odd">
<td align="left">Brandgans</td>
<td align="left">Branta leucopsis</td>
<td align="right">5232464</td>
</tr>
<tr class="even">
<td align="left">Knobbelzwaan</td>
<td align="left">Cygnus olor</td>
<td align="right">2498343</td>
</tr>
<tr class="odd">
<td align="left">Kolgans</td>
<td align="left">Anser albifrons</td>
<td align="right">2498017</td>
</tr>
<tr class="even">
<td align="left">Canadese Gans</td>
<td align="left">Branta hutchinsii</td>
<td align="right">5232458</td>
</tr>
<tr class="odd">
<td align="left">Toendrarietgans</td>
<td align="left">Anser serrirostris</td>
<td align="right">9455781</td>
</tr>
<tr class="even">
<td align="left">Kleine Zwaan</td>
<td align="left">Cygnus bewickii</td>
<td align="right">4409105</td>
</tr>
</tbody>
</table>
</div>
<p>Finally, the lookup table also contains some scientific names which unfortunately will not match with the life-history characteristics dataset, so these too we will adjust manually.</p>
<div class="sourceCode" id="cb95"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb95-1" data-line-number="1"><span class="co"># Change to similar species which is in the LHT database</span></a>
<a class="sourceLine" id="cb95-2" data-line-number="2">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Toendrarietgans&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Anser fabalis&quot;</span>  <span class="co"># Taiga Bean Goose</span></a>
<a class="sourceLine" id="cb95-3" data-line-number="3">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Kleine Canadese Gans&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Branta leucopsis&quot;</span>  <span class="co"># Barnacle Goose</span></a>
<a class="sourceLine" id="cb95-4" data-line-number="4">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Kleine Barmsijs&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Acanthis flammea&quot;</span>  <span class="co"># Redpoll</span></a>
<a class="sourceLine" id="cb95-5" data-line-number="5">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Pontische Meeuw&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Larus argentatus&quot;</span>  <span class="co"># Herring Gull</span></a>
<a class="sourceLine" id="cb95-6" data-line-number="6">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Indische Gans&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Anser albifrons&quot;</span>  <span class="co"># Greater White-fronted Goose</span></a>
<a class="sourceLine" id="cb95-7" data-line-number="7">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Canadese Gans&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Branta canadensis&quot;</span>  <span class="co"># Canada Goose</span></a>
<a class="sourceLine" id="cb95-8" data-line-number="8"></a>
<a class="sourceLine" id="cb95-9" data-line-number="9"><span class="co"># Change scientific name for same species to match with the LHT database</span></a>
<a class="sourceLine" id="cb95-10" data-line-number="10">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Kleine Zwaan&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Cygnus columbianus&quot;</span>  <span class="co"># Bewick&#39;s Swan</span></a>
<a class="sourceLine" id="cb95-11" data-line-number="11">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Kokmeeuw&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Larus ridibundus&quot;</span>  <span class="co"># Black-headed Gull</span></a>
<a class="sourceLine" id="cb95-12" data-line-number="12">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Smient&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Mareca penelope&quot;</span>  <span class="co"># Wigeon</span></a>
<a class="sourceLine" id="cb95-13" data-line-number="13">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Krakeend&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Mareca strepera&quot;</span>  <span class="co"># Gadwall</span></a>
<a class="sourceLine" id="cb95-14" data-line-number="14">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Slobeend&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Spatula clypeata&quot;</span>  <span class="co"># Northern Shoveler</span></a>
<a class="sourceLine" id="cb95-15" data-line-number="15">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Winterkoning&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Troglodytes troglodytes&quot;</span>  <span class="co"># Wren</span></a>
<a class="sourceLine" id="cb95-16" data-line-number="16">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Grote Jager&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Catharacta skua&quot;</span>  <span class="co"># Great Skua</span></a>
<a class="sourceLine" id="cb95-17" data-line-number="17">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Roodborsttapuit&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Saxicola torquatus&quot;</span>  <span class="co"># Stonechat</span></a>
<a class="sourceLine" id="cb95-18" data-line-number="18">species_lut[species_lut<span class="op">$</span>lookupname <span class="op">==</span><span class="st"> &quot;Strandleeuwerik&quot;</span>, <span class="st">&quot;scientificname&quot;</span>] &lt;-<span class="st"> &quot;Eremophila alpestris&quot;</span>  <span class="co"># Horned Lark</span></a></code></pre></div>
</div>
<div id="linking-life-history-traits-to-species" class="section level2">
<h2><span class="header-section-number">5.4</span> Linking life-history traits to species</h2>
<p>We use the <em>Life-history characteristics of European birds</em>-dataset <span class="citation">(Storchová and Hořák <a href="#ref-storchova_2018">2018</a>)</span> to calculate the mean mass of all birds in a PPI pixel. This dataset is stored on Dryad and we can <a href="https://doi.org/10.5061/dryad.n6k3n">download</a> it there. Unfortunately the <code>rdryad</code> package is severely out-of-date with the new Dryad API, so we cannot nicely automate this download yet. Anyways, the files should be downloaded manually and added to <code>data/raw/life-history-characteristics/</code>.</p>
<p>We calculate the mean of the mass of both sexed and unsexed birds and assume they occur</p>
<div class="sourceCode" id="cb96"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb96-1" data-line-number="1"><span class="kw">read_tsv</span>(<span class="st">&quot;data/raw/life-history-characteristics/Life-history characteristics of European birds.txt&quot;</span>, </a>
<a class="sourceLine" id="cb96-2" data-line-number="2">         <span class="dt">col_types =</span> <span class="kw">cols_only</span>(<span class="st">&#39;Species&#39;</span> =<span class="st"> </span><span class="kw">col_character</span>(), <span class="st">&#39;WeightU_MEAN&#39;</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">&#39;WeightM_MEAN&#39;</span> =<span class="st"> </span><span class="kw">col_double</span>(), <span class="st">&#39;WeightF_MEAN&#39;</span> =<span class="st"> </span><span class="kw">col_double</span>())) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-3" data-line-number="3"><span class="st">  </span>rowwise <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">mean_weight =</span> <span class="kw">mean</span>(<span class="kw">c</span>(WeightU_MEAN, WeightF_MEAN, WeightM_MEAN))) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(Species, mean_weight) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-6" data-line-number="6"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">species =</span> Species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb96-7" data-line-number="7"><span class="st">  </span><span class="kw">filter</span>(<span class="op">!</span><span class="kw">any</span>(<span class="kw">str_ends</span>(species, <span class="st">&quot;ssp&quot;</span>))) <span class="op">%&gt;%</span><span class="st">  </span><span class="co"># Filter out birds not identified to species</span></a>
<a class="sourceLine" id="cb96-8" data-line-number="8"><span class="st">  </span><span class="kw">drop_na</span>() -&gt;<span class="st"> </span>lhc</a>
<a class="sourceLine" id="cb96-9" data-line-number="9"></a>
<a class="sourceLine" id="cb96-10" data-line-number="10">lhc[lhc<span class="op">$</span>species <span class="op">==</span><span class="st"> &quot;Aquila nipalenis&quot;</span>, <span class="st">&quot;species&quot;</span>] &lt;-<span class="st"> &quot;Aquila nipalensis&quot;</span>  <span class="co"># Small error in dataset -&gt; notified author</span></a>
<a class="sourceLine" id="cb96-11" data-line-number="11"><span class="kw">head</span>(lhc, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left">species</th>
<th align="right">mean_weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Accipiter brevipes</td>
<td align="right">221.5</td>
</tr>
<tr class="even">
<td align="left">Accipiter gentilis</td>
<td align="right">931.5</td>
</tr>
<tr class="odd">
<td align="left">Accipiter nisus</td>
<td align="right">204.0</td>
</tr>
<tr class="even">
<td align="left">Aegypius monachus</td>
<td align="right">9625.0</td>
</tr>
<tr class="odd">
<td align="left">Aquila adalberti</td>
<td align="right">3000.0</td>
</tr>
<tr class="even">
<td align="left">Aquila fasciata</td>
<td align="right">1905.0</td>
</tr>
<tr class="odd">
<td align="left">Aquila heliaca</td>
<td align="right">3262.5</td>
</tr>
<tr class="even">
<td align="left">Aquila chrysaetos</td>
<td align="right">4383.0</td>
</tr>
<tr class="odd">
<td align="left">Aquila nipalensis</td>
<td align="right">2723.0</td>
</tr>
<tr class="even">
<td align="left">Buteo buteo</td>
<td align="right">806.5</td>
</tr>
</tbody>
</table>
</div>
<p>Now we can try to link the names once again with what can be found in GBIF.</p>
<div class="sourceCode" id="cb97"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb97-1" data-line-number="1">unique_species_lhc &lt;-<span class="st"> </span><span class="kw">unique</span>(lhc<span class="op">$</span>species)</a>
<a class="sourceLine" id="cb97-2" data-line-number="2"></a>
<a class="sourceLine" id="cb97-3" data-line-number="3">lhc_species_lut &lt;-<span class="st"> </span><span class="kw">build_species_lut</span>(unique_species_lhc, <span class="dt">dataset =</span> <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb97-4" data-line-number="4"><span class="kw">head</span>(lhc_species_lut, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="left">lookupname</th>
<th align="left">scientificname</th>
<th align="right">gbif_key</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Accipiter brevipes</td>
<td align="left">Accipiter brevipes</td>
<td align="right">2480578</td>
</tr>
<tr class="even">
<td align="left">Accipiter gentilis</td>
<td align="left">Accipiter gentilis</td>
<td align="right">2480589</td>
</tr>
<tr class="odd">
<td align="left">Accipiter nisus</td>
<td align="left">Accipiter nisus</td>
<td align="right">2480637</td>
</tr>
<tr class="even">
<td align="left">Aegypius monachus</td>
<td align="left">Aegypius monachus</td>
<td align="right">5229165</td>
</tr>
<tr class="odd">
<td align="left">Aquila adalberti</td>
<td align="left">Aquila adalberti</td>
<td align="right">2480510</td>
</tr>
<tr class="even">
<td align="left">Aquila fasciata</td>
<td align="left">Aquila fasciata</td>
<td align="right">5844449</td>
</tr>
<tr class="odd">
<td align="left">Aquila heliaca</td>
<td align="left">Aquila heliaca</td>
<td align="right">2480500</td>
</tr>
<tr class="even">
<td align="left">Aquila chrysaetos</td>
<td align="left">Aquila chrysaetos</td>
<td align="right">2480506</td>
</tr>
<tr class="odd">
<td align="left">Aquila nipalensis</td>
<td align="left">Aquila nipalensis</td>
<td align="right">2480513</td>
</tr>
<tr class="even">
<td align="left">Buteo buteo</td>
<td align="left">Buteo buteo</td>
<td align="right">2480537</td>
</tr>
</tbody>
</table>
</div>
<p>With the GBIF IDs/keys in place for both the life-history characteristics, as well as the Sovon counts, we can now link the datasets together. First the waterbirds</p>
<div class="sourceCode" id="cb98"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb98-1" data-line-number="1">lhc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(lhc_species_lut, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;species&quot;</span> =<span class="st"> &quot;scientificname&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-3" data-line-number="3"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(species, mean_weight, gbif_key) -&gt;<span class="st"> </span>lhc</a>
<a class="sourceLine" id="cb98-4" data-line-number="4"></a>
<a class="sourceLine" id="cb98-5" data-line-number="5">wb_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-6" data-line-number="6"><span class="st">  </span><span class="kw">left_join</span>(species_lut, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;species&quot;</span> =<span class="st"> &quot;lookupname&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-7" data-line-number="7"><span class="st">  </span><span class="kw">left_join</span>(dplyr<span class="op">::</span><span class="kw">select</span>(lhc, mean_weight, gbif_key), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;gbif_key&quot;</span> =<span class="st"> &quot;gbif_key&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-8" data-line-number="8"><span class="st">  </span><span class="kw">left_join</span>(dplyr<span class="op">::</span><span class="kw">select</span>(lhc, mean_weight, species), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;scientificname&quot;</span> =<span class="st"> &quot;species&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-9" data-line-number="9"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(mean_weight.x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb98-10" data-line-number="10"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">mean_weight =</span> mean_weight.y) -&gt;<span class="st"> </span>wb_data_lhc</a>
<a class="sourceLine" id="cb98-11" data-line-number="11"><span class="kw">head</span>(wb_data_lhc, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">count_id</th>
<th align="left">area_nr</th>
<th align="right">year</th>
<th align="right">month</th>
<th align="right">day</th>
<th align="right">start_time</th>
<th align="right">end_time</th>
<th align="right">euring</th>
<th align="left">species</th>
<th align="right">number</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
<th align="left">scientificname</th>
<th align="right">gbif_key</th>
<th align="right">mean_weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">1060908</td>
<td align="left">BR1111</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1045</td>
<td align="right">1108</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">280</td>
<td align="right">127723</td>
<td align="right">426233</td>
<td align="left">Anser anser</td>
<td align="right">2498036</td>
<td align="right">3347</td>
</tr>
<tr class="even">
<td align="right">1060908</td>
<td align="left">BR1111</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1045</td>
<td align="right">1108</td>
<td align="right">1700</td>
<td align="left">Nijlgans</td>
<td align="right">2</td>
<td align="right">127723</td>
<td align="right">426233</td>
<td align="left">Alopochen aegyptiaca</td>
<td align="right">2498252</td>
<td align="right">2270</td>
</tr>
<tr class="odd">
<td align="right">1060909</td>
<td align="left">BR1112</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1108</td>
<td align="right">1126</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">76</td>
<td align="right">125082</td>
<td align="right">426701</td>
<td align="left">Anser anser</td>
<td align="right">2498036</td>
<td align="right">3347</td>
</tr>
<tr class="even">
<td align="right">1060909</td>
<td align="left">BR1112</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1108</td>
<td align="right">1126</td>
<td align="right">1661</td>
<td align="left">Grote Canadese Gans</td>
<td align="right">50</td>
<td align="right">125082</td>
<td align="right">426701</td>
<td align="left">Branta canadensis</td>
<td align="right">5232437</td>
<td align="right">4635</td>
</tr>
<tr class="odd">
<td align="right">1060909</td>
<td align="left">BR1112</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1108</td>
<td align="right">1126</td>
<td align="right">1700</td>
<td align="left">Nijlgans</td>
<td align="right">22</td>
<td align="right">125082</td>
<td align="right">426701</td>
<td align="left">Alopochen aegyptiaca</td>
<td align="right">2498252</td>
<td align="right">2270</td>
</tr>
<tr class="even">
<td align="right">1060906</td>
<td align="left">BR1122</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1020</td>
<td align="right">1037</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">250</td>
<td align="right">125313</td>
<td align="right">426061</td>
<td align="left">Anser anser</td>
<td align="right">2498036</td>
<td align="right">3347</td>
</tr>
<tr class="odd">
<td align="right">1060906</td>
<td align="left">BR1122</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1020</td>
<td align="right">1037</td>
<td align="right">1619</td>
<td align="left">Soepgans</td>
<td align="right">5</td>
<td align="right">125313</td>
<td align="right">426061</td>
<td align="left">Anser anser</td>
<td align="right">9384117</td>
<td align="right">3347</td>
</tr>
<tr class="even">
<td align="right">1060906</td>
<td align="left">BR1122</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1020</td>
<td align="right">1037</td>
<td align="right">1661</td>
<td align="left">Grote Canadese Gans</td>
<td align="right">35</td>
<td align="right">125313</td>
<td align="right">426061</td>
<td align="left">Branta canadensis</td>
<td align="right">5232437</td>
<td align="right">4635</td>
</tr>
<tr class="odd">
<td align="right">1060911</td>
<td align="left">BR1130</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1145</td>
<td align="right">1200</td>
<td align="right">1610</td>
<td align="left">Grauwe Gans</td>
<td align="right">200</td>
<td align="right">121962</td>
<td align="right">426420</td>
<td align="left">Anser anser</td>
<td align="right">2498036</td>
<td align="right">3347</td>
</tr>
<tr class="even">
<td align="right">1060911</td>
<td align="left">BR1130</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">19</td>
<td align="right">1145</td>
<td align="right">1200</td>
<td align="right">1661</td>
<td align="left">Grote Canadese Gans</td>
<td align="right">40</td>
<td align="right">121962</td>
<td align="right">426420</td>
<td align="left">Branta canadensis</td>
<td align="right">5232437</td>
<td align="right">4635</td>
</tr>
</tbody>
</table>
</div>
<p>And then the PTT counts</p>
<div class="sourceCode" id="cb99"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb99-1" data-line-number="1">ptt_data <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-2" data-line-number="2"><span class="st">  </span><span class="kw">left_join</span>(species_lut, <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;species&quot;</span> =<span class="st"> &quot;lookupname&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-3" data-line-number="3"><span class="st">  </span><span class="kw">left_join</span>(dplyr<span class="op">::</span><span class="kw">select</span>(lhc, mean_weight, gbif_key), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;gbif_key&quot;</span> =<span class="st"> &quot;gbif_key&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-4" data-line-number="4"><span class="st">  </span><span class="kw">left_join</span>(dplyr<span class="op">::</span><span class="kw">select</span>(lhc, mean_weight, species), <span class="dt">by =</span> <span class="kw">c</span>(<span class="st">&quot;scientificname&quot;</span> =<span class="st"> &quot;species&quot;</span>)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-5" data-line-number="5"><span class="st">  </span>dplyr<span class="op">::</span><span class="kw">select</span>(<span class="op">-</span><span class="kw">c</span>(mean_weight.x)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb99-6" data-line-number="6"><span class="st">  </span><span class="kw">rename</span>(<span class="dt">mean_weight =</span> mean_weight.y) -&gt;<span class="st"> </span>ptt_data_lhc</a>
<a class="sourceLine" id="cb99-7" data-line-number="7"><span class="kw">head</span>(ptt_data_lhc, <span class="dv">10</span>)</a></code></pre></div>
<div class="kable-table">
<table>
<thead>
<tr class="header">
<th align="right">count_id</th>
<th align="right">route</th>
<th align="right">count_point</th>
<th align="right">season</th>
<th align="right">year</th>
<th align="right">month</th>
<th align="right">day</th>
<th align="right">euring</th>
<th align="left">species</th>
<th align="right">number</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
<th align="left">scientificname</th>
<th align="right">gbif_key</th>
<th align="right">mean_weight</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">720</td>
<td align="left">Aalscholver</td>
<td align="right">2</td>
<td align="right">246342</td>
<td align="right">520763</td>
<td align="left">Phalacrocorax carbo</td>
<td align="right">2481890</td>
<td align="right">2254.0</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">5920</td>
<td align="left">Zilvermeeuw</td>
<td align="right">18</td>
<td align="right">246342</td>
<td align="right">520763</td>
<td align="left">Larus argentatus</td>
<td align="right">2481139</td>
<td align="right">1054.0</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">6700</td>
<td align="left">Houtduif</td>
<td align="right">1</td>
<td align="right">246342</td>
<td align="right">520763</td>
<td align="left">Columba palumbus</td>
<td align="right">2495455</td>
<td align="right">496.5</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">11870</td>
<td align="left">Merel</td>
<td align="right">4</td>
<td align="right">246342</td>
<td align="right">520763</td>
<td align="left">Turdus merula</td>
<td align="right">2490719</td>
<td align="right">97.0</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15630</td>
<td align="left">Roek</td>
<td align="right">24</td>
<td align="right">246342</td>
<td align="right">520763</td>
<td align="left">Corvus frugilegus</td>
<td align="right">2482513</td>
<td align="right">459.0</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">6700</td>
<td align="left">Houtduif</td>
<td align="right">1</td>
<td align="right">246357</td>
<td align="right">522178</td>
<td align="left">Columba palumbus</td>
<td align="right">2495455</td>
<td align="right">496.5</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">11870</td>
<td align="left">Merel</td>
<td align="right">1</td>
<td align="right">246357</td>
<td align="right">522178</td>
<td align="left">Turdus merula</td>
<td align="right">2490719</td>
<td align="right">97.0</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15600</td>
<td align="left">Kauw</td>
<td align="right">6</td>
<td align="right">246357</td>
<td align="right">522178</td>
<td align="left">Corvus monedula</td>
<td align="right">2482473</td>
<td align="right">236.0</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15630</td>
<td align="left">Roek</td>
<td align="right">78</td>
<td align="right">246357</td>
<td align="right">522178</td>
<td align="left">Corvus frugilegus</td>
<td align="right">2482513</td>
<td align="right">459.0</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">14620</td>
<td align="left">Pimpelmees</td>
<td align="right">2</td>
<td align="right">246692</td>
<td align="right">523139</td>
<td align="left">Cyanistes caeruleus</td>
<td align="right">2487879</td>
<td align="right">11.5</td>
</tr>
</tbody>
</table>
</div>
<p>Now we can verify if our 1% criteria for species matching is met. We do this by calculating the proportions of birds belonging to a certain species out of the total numbers of birds counted within a count. This should result in an empty dataframe, which will stop the code chunk below from running if that is <em>not</em> the case.</p>
<div class="sourceCode" id="cb100"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb100-1" data-line-number="1">wb_data_lhc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-2" data-line-number="2"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(count_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_birds_count =</span> <span class="kw">sum</span>(number)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(count_id, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion_species =</span> <span class="kw">sum</span>(number) <span class="op">/</span><span class="st"> </span>total_birds_count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-7" data-line-number="7"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-8" data-line-number="8"><span class="st">  </span><span class="kw">arrange</span>(count_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb100-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>((<span class="kw">is.na</span>(mean_weight) <span class="op">&amp;</span><span class="st"> </span>(proportion_species <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.01</span>))) -&gt;<span class="st"> </span>wb_data_lhc_verify</a>
<a class="sourceLine" id="cb100-10" data-line-number="10"></a>
<a class="sourceLine" id="cb100-11" data-line-number="11"><span class="kw">stopifnot</span>(<span class="kw">nrow</span>(wb_data_lhc_verify) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb100-12" data-line-number="12"><span class="kw">rm</span>(wb_data_lhc_verify)</a></code></pre></div>
<p>And once again, we can do the same for the PTT counts.</p>
<div class="sourceCode" id="cb101"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb101-1" data-line-number="1">ptt_data_lhc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-2" data-line-number="2"><span class="st">  </span><span class="kw">as.data.frame</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-3" data-line-number="3"><span class="st">  </span><span class="kw">group_by</span>(count_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-4" data-line-number="4"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">total_birds_count =</span> <span class="kw">sum</span>(number)) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-5" data-line-number="5"><span class="st">  </span><span class="kw">group_by</span>(count_id, species) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-6" data-line-number="6"><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">proportion_species =</span> <span class="kw">sum</span>(number) <span class="op">/</span><span class="st"> </span>total_birds_count) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-7" data-line-number="7"><span class="st">  </span><span class="kw">ungroup</span>() <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-8" data-line-number="8"><span class="st">  </span><span class="kw">arrange</span>(count_id) <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb101-9" data-line-number="9"><span class="st">  </span><span class="kw">filter</span>((<span class="kw">is.na</span>(mean_weight) <span class="op">&amp;</span><span class="st"> </span>(proportion_species <span class="op">&gt;</span><span class="st"> </span><span class="fl">0.01</span>))) -&gt;<span class="st"> </span>ptt_data_lhc_verify</a>
<a class="sourceLine" id="cb101-10" data-line-number="10"></a>
<a class="sourceLine" id="cb101-11" data-line-number="11"><span class="kw">stopifnot</span>(<span class="kw">nrow</span>(ptt_data_lhc_verify) <span class="op">==</span><span class="st"> </span><span class="dv">0</span>)</a>
<a class="sourceLine" id="cb101-12" data-line-number="12"><span class="kw">rm</span>(ptt_data_lhc_verify)</a></code></pre></div>
<p>With that out of the way we can <em>finally</em> remove the remaining empty rows and save the PTT and waterbird counts in their final form.</p>
<div class="sourceCode" id="cb102"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb102-1" data-line-number="1">ptt_data_lhc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-2" data-line-number="2"><span class="st">  </span><span class="kw">drop_na</span>() -&gt;<span class="st"> </span>ptt_data</a>
<a class="sourceLine" id="cb102-3" data-line-number="3"></a>
<a class="sourceLine" id="cb102-4" data-line-number="4">wb_data_lhc <span class="op">%&gt;%</span></a>
<a class="sourceLine" id="cb102-5" data-line-number="5"><span class="st">  </span><span class="kw">drop_na</span>() -&gt;<span class="st"> </span>wb_data</a></code></pre></div>

</div>
</div>



<h3> References</h3>
<div id="refs" class="references">
<div id="ref-storchova_2018">
<p>Storchová, Lenka, and David Hořák. 2018. “Life-History Characteristics of European Birds.” <em>Global Ecology and Biogeography</em> 27 (4): 400–406. <a href="https://doi.org/10.1111/geb.12709">https://doi.org/10.1111/geb.12709</a>.</p>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="04.Annotate-count-areas.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="References.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": true,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/barthoekstra/fireworks/edit/master/05.Annotate-count-results.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/barthoekstra/fireworks/blob/master/05.Annotate-count-results.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "section",
"scroll_highlight": true
},
"toolbar": {
"position": "fixed"
},
"search": true,
"info": true
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>
