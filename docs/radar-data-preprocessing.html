<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2 Radar Data Preprocessing | Fireworks</title>
<meta name="author" content="Bart Hoekstra">
<meta name="description" content="Weather radar data of the firework events at the turns of the years usually contain some degree of precipitation clutter. To filter out precipitation advanced algorithms such as MistNet have been...">
<meta name="generator" content="bookdown 0.24 with bs4_book()">
<meta property="og:title" content="2 Radar Data Preprocessing | Fireworks">
<meta property="og:type" content="book">
<meta property="og:description" content="Weather radar data of the firework events at the turns of the years usually contain some degree of precipitation clutter. To filter out precipitation advanced algorithms such as MistNet have been...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="2 Radar Data Preprocessing | Fireworks">
<meta name="twitter:description" content="Weather radar data of the firework events at the turns of the years usually contain some degree of precipitation clutter. To filter out precipitation advanced algorithms such as MistNet have been...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/header-attrs-2.11/header-attrs.js"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.3.1/transition.js"></script><script src="libs/bs3compat-0.3.1/tabs.js"></script><script src="libs/bs3compat-0.3.1/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Fireworks</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li class="book-part">Weather radar data</li>
<li><a class="" href="selecting-firework-take-off-moment.html"><span class="header-section-number">1</span> Selecting firework take-off moment</a></li>
<li><a class="active" href="radar-data-preprocessing.html"><span class="header-section-number">2</span> Radar Data Preprocessing</a></li>
<li class="book-part">Land use</li>
<li><a class="" href="annotating-land-use.html"><span class="header-section-number">3</span> Annotating land use</a></li>
<li class="book-part">Sovon counts</li>
<li><a class="" href="annotating-count-areas.html"><span class="header-section-number">4</span> Annotating count areas</a></li>
<li><a class="" href="processing-count-results.html"><span class="header-section-number">5</span> Processing count results</a></li>
<li class="book-part">Composite PPIs</li>
<li><a class="" href="apply-processing-to-all-ppis.html"><span class="header-section-number">6</span> Apply processing to all PPIs</a></li>
<li><a class="" href="composite-all-ppis.html"><span class="header-section-number">7</span> Composite all PPIs</a></li>
<li class="book-part">Fireworks disturbance</li>
<li><a class="" href="modelling-fireworks-disturbance.html"><span class="header-section-number">8</span> Modelling fireworks disturbance</a></li>
<li><a class="" href="quantifying-model-uncertainty.html"><span class="header-section-number">9</span> Quantifying model uncertainty</a></li>
<li><a class="" href="determine-baseline-disturbance.html"><span class="header-section-number">10</span> Determine baseline disturbance</a></li>
<li class="book-part">Figures</li>
<li><a class="" href="figure-1-data-overview.html"><span class="header-section-number">11</span> Figure 1: Data overview</a></li>
<li><a class="" href="figure-2-model-output.html"><span class="header-section-number">12</span> Figure 2: Model output</a></li>
<li><a class="" href="figure-3-species-composition.html"><span class="header-section-number">13</span> Figure 3: Species composition</a></li>
<li><a class="" href="figure-4-distance-to-fireworks.html"><span class="header-section-number">14</span> Figure 4: Distance to fireworks</a></li>
<li><a class="" href="context-1-number-of-birds-affected.html"><span class="header-section-number">15</span> Context 1: Number of birds affected</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="generating-vps-for-den-helder-radar.html"><span class="header-section-number">16</span> Generating vertical profiles for Den Helder radar</a></li>
<li class="book-part">Other</li>
<li><a class="" href="references.html"><span class="header-section-number">17</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/barthoekstra/fireworks">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="radar-data-preprocessing" class="section level1" number="2">
<h1>
<span class="header-section-number">2</span> Radar Data Preprocessing<a class="anchor" aria-label="anchor" href="#radar-data-preprocessing"><i class="fas fa-link"></i></a>
</h1>
<p>Weather radar data of the firework events at the turns of the years usually contain some degree of precipitation clutter. To filter out precipitation advanced algorithms such as MistNet have been developed, but as we are dealing with dual-polarization radar data here, we can use a simpler and yet robust method using the depolarization ratio <span class="citation">(<a href="references.html#ref-kilambi_simple_2018" role="doc-biblioref">Kilambi, Fabry, and Meunier 2018</a>)</span>.</p>
<p>To make sure our processed weather radar data does not contain any significant proportions of precipitation or ground clutter anymore, we process the data as follows:</p>
<ol style="list-style-type: decimal">
<li>We remove electromagnetic interference based on a visual inspection of the scans and throw out all data of affected rays.</li>
<li>We calculate the depolarization ratio <span class="citation">(<a href="references.html#ref-kilambi_simple_2018" role="doc-biblioref">Kilambi, Fabry, and Meunier 2018</a>)</span> and separate biology from meteorology by classifying all range gates with a depolarization ratio <span class="math inline">\(&gt;-12dB\)</span> as biology. We subsequently ‘despeckle’ this, to remove obvious misclassifications.</li>
<li>We average reflectivity over a number of scans before the time of the fireworks event and throw out the range-gates with highest average reflectivities.</li>
</ol>
<p>All these steps can be undertaken directly on the polar volume data, so we can subsequently plug the cleaned up volume into the range-bias correction.</p>
<div id="processing-environment-1" class="section level2" number="2.1">
<h2>
<span class="header-section-number">2.1</span> Processing environment<a class="anchor" aria-label="anchor" href="#processing-environment-1"><i class="fas fa-link"></i></a>
</h2>
<p>As usual, most of the processing takes place using <a href="http://adokter.github.io/bioRad">bioRad</a> <span class="citation">(<a href="references.html#ref-dokter_biorad_2019" role="doc-biblioref">Dokter et al. 2019</a>)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/adokter/bioRad">bioRad</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://plotly-r.com">plotly</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">gridExtra</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rpkgs.datanovia.com/ggpubr/">ggpubr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/r-spatial/mapview">mapview</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/">viridis</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div id="removing-electromagnetic-interference" class="section level2" number="2.2">
<h2>
<span class="header-section-number">2.2</span> Removing electromagnetic interference<a class="anchor" aria-label="anchor" href="#removing-electromagnetic-interference"><i class="fas fa-link"></i></a>
</h2>
<p>We have determined in which scans birds are taking off based on the maximum increase in reflectivity in the scan for each of the involved radars. Let’s now look at these scans to see how much filtering for electromagnetic interference we need to do. The easiest way to determine which rays are subject to this interference is by plotting the scans in polar coordinates <span class="math inline">\((r, \alpha)\)</span>, so interference stands out as horizontal lines of more or less constant, or very gradually changing reflectivities. Plotting using <code>plotly</code> makes it easier to identify the specific problematic rays as one can zoom in to identify the exact azimuths <span class="math inline">\(\alpha\)</span> at which this interference occurs, but for this web version we stick to the static plots using <code>bioRad:::plot.scan()</code>.</p>
<p>The scans we will be using:</p>
<ul>
<li>
<strong>Herwijnen</strong>: <code>RAD_NL62_VOL_NA_201712312305_ODIM.h5</code>
</li>
<li>
<strong>Den Helder</strong>: <code>RAD_NL61_VOL_NA_201712312305_ODIM.h5</code>
</li>
</ul>
<p>For illustrative purposes we will only illustrate removal of EM interference for the Herwijnen radar, as the procedure for Den Helder is exactly identical, but this scan contains very little of said clutter.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pvol_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/read_pvolfile.html">read_pvolfile</a></span><span class="op">(</span><span class="va">pvol_hrw_path</span>, param <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span><span class="va">pvol_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/read_pvolfile.html">read_pvolfile</a></span><span class="op">(</span><span class="va">pvol_dhl_path</span>, param <span class="op">=</span> <span class="st">"all"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">scan</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">pvol_hrw</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, param <span class="op">=</span> <span class="st">"DBZH"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">180000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="co"># ggplotly(scan)  # Use when manually filtering EM contaminated beams</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">scan</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/load_pvols-1.png" width="672"></div>
<p>Right away we can see that rays at two places in the scan are subject to electromagnetic interference. This is probably most problematic in the lowest elevations of the volume scan, but nevertheless each of the 16 scans have to be checked manually. Doing so results in the identification of the following rays that contain electromagnetic interference (<code>ei_rays</code>), organised in a list with the scan numbers (organised ascendingly per elevation angle) as keys. <em>Admittedly: there is another ray that seems to contain interference in the first scan, but this is so far away from the radar (150km+) it should not affect our results as no meaningful numbers of birds can be detected at that range anyways and we thus exclude it from our analysis. Similarly, there are similar patterns of interference/clutter in higher elevation scans, but these too should not affect our results.</em></p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ei_rays_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>, <span class="fl">202</span>, <span class="fl">214</span>, <span class="fl">215</span><span class="op">)</span>, <span class="co"># scan 1</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>, <span class="fl">202</span>, <span class="fl">214</span>, <span class="fl">215</span><span class="op">)</span>, <span class="co"># scan 2</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">201</span>, <span class="fl">202</span>, <span class="fl">214</span>, <span class="fl">215</span><span class="op">)</span>, <span class="co"># scan 3</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">202</span>, <span class="fl">214</span>, <span class="fl">215</span><span class="op">)</span><span class="op">)</span>      <span class="co"># scan 4</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ei_rays_hrw</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span>, <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="va">ei_rays_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">60</span>, <span class="fl">61</span><span class="op">)</span><span class="op">)</span> <span class="co"># scan 1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/names.html">names</a></span><span class="op">(</span><span class="va">ei_rays_dhl</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<p>We can now remove the data for the affected rays in the corresponding scans by setting the values to <code>NA</code> (see <code>R/remove_rays.R</code>).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/remove_rays.R"</span><span class="op">)</span></span>
<span><span class="va">pvol_hrw</span> <span class="op">&lt;-</span> <span class="fu">remove_rays</span><span class="op">(</span><span class="va">pvol_hrw</span>, rays <span class="op">=</span> <span class="va">ei_rays_hrw</span><span class="op">)</span></span>
<span><span class="va">pvol_dhl</span> <span class="op">&lt;-</span> <span class="fu">remove_rays</span><span class="op">(</span><span class="va">pvol_dhl</span>, rays <span class="op">=</span> <span class="va">ei_rays_dhl</span><span class="op">)</span></span></code></pre></div>
<div id="verify-removal-of-rays-with-em-interference" class="section level3" number="2.2.1">
<h3>
<span class="header-section-number">2.2.1</span> Verify removal of rays with EM interference<a class="anchor" aria-label="anchor" href="#verify-removal-of-rays-with-em-interference"><i class="fas fa-link"></i></a>
</h3>
<p>If removal is correct, the <span class="math inline">\((r,\alpha)\)</span> plots should not show clear horizontal structures anymore.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">i</span> <span class="op">=</span> <span class="fl">1</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">pvol_hrw</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, param <span class="op">=</span> <span class="st">"DBZH"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">180000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Herwijnen: Cleaned from EM interference"</span>, subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Elevation:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pvol_hrw</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">attributes</span><span class="op">$</span><span class="va">where</span><span class="op">$</span><span class="va">elangle</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/plot_em_filtered_scans-1.png" width="672"></div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">pvol_dhl</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, param <span class="op">=</span> <span class="st">"DBZH"</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">180000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_dark</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Den Helder: Cleaned from EM interference"</span>, subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"Elevation:"</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html">round</a></span><span class="op">(</span><span class="va">pvol_dhl</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">attributes</span><span class="op">$</span><span class="va">where</span><span class="op">$</span><span class="va">elangle</span>, <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/plot_em_filtered_scans-2.png" width="672"></div>
<p>That seems to work nicely.</p>
</div>
</div>
<div id="filter-meteorology-using-the-depolarization-ratio" class="section level2" number="2.3">
<h2>
<span class="header-section-number">2.3</span> Filter meteorology using the depolarization ratio<a class="anchor" aria-label="anchor" href="#filter-meteorology-using-the-depolarization-ratio"><i class="fas fa-link"></i></a>
</h2>
<p>Meteorology can be filtered using the depolarization ratio following Kilambi et al. <span class="citation">(<a href="references.html#ref-kilambi_simple_2018" role="doc-biblioref">2018</a>)</span>. We calculate the depolarization ratio for the raw <code>pvol</code> data after EM interference has been removed and subsequently ‘despeckle’ the results to improve the classification.</p>
<p>Despeckling works by comparing the classification of the majority of the neighbourhood rangegates with the classification of the center rangegate, and changing the latter to reflect the majority of the neighbourhood classification if there is a difference. We define the ‘neighbourhood’ as a <span class="math inline">\(3^{\circ}\)</span> by <span class="math inline">\(3 \times rscale\)</span> area centered around a focal rangegate (3 rangegates in azimuth <span class="math inline">\(\times\)</span> 3 rangegates in range). Selecting the rangegates while taking the sphericity of the radar scan into account (e.g. ray 360 should be directly adjacent to ray 1) is made easier with the <code>R/window_coords.R</code> function. The despeckling is implemented in <code>R/despeckle_scan_logical.R</code>.</p>
<p>With the despeckling algorithm in place, we can:</p>
<ol style="list-style-type: decimal">
<li>Calculate the depolarization ratio (<code>DPR</code>).</li>
<li>Classify biology as rangegates where <code>DPR &gt; -12</code> and store this classification as <code>BIOLR</code> (Biology Raw) <code>scan</code> parameter in the <code>pvol</code> object.</li>
<li>Despeckle the classification and store the outcome in the <code>BIOLD</code> (Biology Despeckled) <code>scan</code> parameter in the <code>pvol</code> object.</li>
</ol>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/window_coords.R"</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/despeckle_scan_logical.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Calculate depolarization ratio, classify and despeckle biology classifications for the entire volume</span></span>
<span><span class="va">calculate_dpr</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">pvol</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Calculate ZDR as ZDR = DBZH - DBZV</span></span>
<span>    <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">ZDR</span> <span class="op">&lt;-</span> <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">DBZH</span> <span class="op">-</span> <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">DBZV</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">ZDR</span><span class="op">)</span><span class="op">$</span><span class="va">param</span> <span class="op">&lt;-</span> <span class="st">"ZDR"</span></span>
<span>    </span>
<span>    <span class="co"># Calculate depolarization ratio</span></span>
<span>    <span class="va">zdr_linear</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">**</span> <span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">ZDR</span> <span class="op">/</span> <span class="fl">10</span><span class="op">)</span></span>
<span>    <span class="va">dpr_linear</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">zdr_linear</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">-</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">zdr_linear</span><span class="op">)</span> <span class="op">*</span> <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">RHOHV</span><span class="op">)</span> <span class="op">/</span> </span>
<span>                  <span class="op">(</span><span class="va">zdr_linear</span> <span class="op">+</span> <span class="fl">1</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html">sqrt</a></span><span class="op">(</span><span class="va">zdr_linear</span><span class="op">)</span> <span class="op">*</span> <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">RHOHV</span><span class="op">)</span></span>
<span>    <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">DPR</span> <span class="op">&lt;-</span> <span class="fl">10</span> <span class="op">*</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">dpr_linear</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">DPR</span><span class="op">)</span><span class="op">$</span><span class="va">param</span> <span class="op">&lt;-</span> <span class="st">"DPR"</span></span>
<span>    </span>
<span>    <span class="co"># Classify based on depolarization ratio</span></span>
<span>    <span class="va">biology</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">DPR</span> <span class="op">&gt;</span> <span class="op">-</span><span class="fl">12</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1</span>  <span class="co"># multiply by 1 to convert TRUE/FALSE to 1/0</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/class.html">class</a></span><span class="op">(</span><span class="va">biology</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"param"</span>, <span class="st">"matrix"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">biology</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">DPR</span><span class="op">)</span>  <span class="co"># copy attributes from DPR</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">biology</span><span class="op">)</span><span class="op">$</span><span class="va">param</span> <span class="op">&lt;-</span> <span class="st">"BIOLR"</span></span>
<span>    <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">BIOLR</span> <span class="op">&lt;-</span> <span class="va">biology</span></span>
<span>    </span>
<span>    <span class="co"># Despeckle biology classification</span></span>
<span>    <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">BIOLD</span> <span class="op">&lt;-</span> <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">BIOLR</span></span>
<span>    <span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">BIOLD</span> <span class="op">&lt;-</span> <span class="fu">despeckle_scan_logical</span><span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">BIOLD</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attributes.html">attributes</a></span><span class="op">(</span><span class="va">pvol</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">params</span><span class="op">$</span><span class="va">BIOLD</span><span class="op">)</span><span class="op">$</span><span class="va">param</span> <span class="op">&lt;-</span> <span class="st">"BIOLD"</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="va">pvol</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">pvol_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">calculate_dpr</span><span class="op">(</span><span class="va">pvol_hrw</span><span class="op">)</span><span class="op">)</span> <span class="co"># Will throw NaN warnings if not suppressed</span></span>
<span><span class="va">pvol_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu">calculate_dpr</span><span class="op">(</span><span class="va">pvol_dhl</span><span class="op">)</span><span class="op">)</span> </span></code></pre></div>
<div id="verify-dpr-based-classification" class="section level3" number="2.3.1">
<h3>
<span class="header-section-number">2.3.1</span> Verify DPR-based classification<a class="anchor" aria-label="anchor" href="#verify-dpr-based-classification"><i class="fas fa-link"></i></a>
</h3>
<p>Now let’s plot some PPIs to verify the accuracy of DPR-based classification and the subsequent despeckling, by plotting <code>DBZH</code>, <code>VRADH</code>, <code>DPR</code>, <code>BIOLR</code> and <code>BIOLD</code>.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/side_by_side_ppi.R"</span><span class="op">)</span></span>
<span><span class="fu">side_by_side_ppi</span><span class="op">(</span><span class="va">pvol_hrw</span>, <span class="va">pvol_dhl</span>, <span class="st">"Herwijnen"</span>, <span class="st">"Den Helder"</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DBZH"</span>, <span class="st">"VRADH"</span>, <span class="st">"DPR"</span>, <span class="st">"BIOLR"</span>, <span class="st">"BIOLD"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="02.Radar-data-preprocessing_files/figure-html/verify_dpr_classifications-1.png" width="100%"><img src="02.Radar-data-preprocessing_files/figure-html/verify_dpr_classifications-2.png" width="100%"><img src="02.Radar-data-preprocessing_files/figure-html/verify_dpr_classifications-3.png" width="100%"><img src="02.Radar-data-preprocessing_files/figure-html/verify_dpr_classifications-4.png" width="100%"><img src="02.Radar-data-preprocessing_files/figure-html/verify_dpr_classifications-5.png" width="100%"></p>
<p>The plots show accurate classification of the obvious precipitation zones, except at the edges of these echoes, where <code>BIOLD</code> is a vast improvement over <code>BIOLR</code>, showing the value of despeckling. Similarly, there is a lot of ‘noise’ where birds should be, but despeckling takes care of most of that quite nicely as well. Additionally, it shows a pattern we would expect to see: at closer distances to the radar most ‘speckles’ that are not near to precipitation zones are turned into biology, and at distances further from the radar they are more often ‘flipped’ to meteorology. This method may not be perfect, but it classifies birds quite conservatively. The few misclassifications that remain should not affect the results so much, as they are few in number and do not occur at the centers of precipitation echoes, so they are not likely to turn into numerical outliers.</p>
</div>
</div>
<div id="remove-classified-precipitation-from-polar-volumes" class="section level2" number="2.4">
<h2>
<span class="header-section-number">2.4</span> Remove classified precipitation from polar volumes<a class="anchor" aria-label="anchor" href="#remove-classified-precipitation-from-polar-volumes"><i class="fas fa-link"></i></a>
</h2>
<p>Now that we have accurate classifications of the rangegates based on depolarization ratios, we can start to remove the precipitation from the polar volumes, to retain a scan that comprises of only birds (with a few occasional misclassifications). As there are areas where <code>DPR</code> and <code>DBZH</code> do not overlap, we also have to remove all rangegates that are not classified.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/remove_precipitation.R"</span><span class="op">)</span></span>
<span><span class="va">pvol_hrw</span> <span class="op">&lt;-</span> <span class="fu">remove_precipitation</span><span class="op">(</span><span class="va">pvol_hrw</span><span class="op">)</span></span>
<span><span class="va">pvol_dhl</span> <span class="op">&lt;-</span> <span class="fu">remove_precipitation</span><span class="op">(</span><span class="va">pvol_dhl</span><span class="op">)</span></span></code></pre></div>
<p>Plotting the same PPIs as before should now show a cleaned-up/precipitation-free scan next to the classifications.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">side_by_side_ppi</span><span class="op">(</span><span class="va">pvol_hrw</span>, <span class="va">pvol_dhl</span>, <span class="st">"Herwijnen"</span>, <span class="st">"Den Helder"</span>, params <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"DBZH"</span>, <span class="st">"VRADH"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><img src="02.Radar-data-preprocessing_files/figure-html/verify_precipitation_removal-1.png" width="100%"><img src="02.Radar-data-preprocessing_files/figure-html/verify_precipitation_removal-2.png" width="100%"></p>
<p>That looks very good for both Herwijnen and Den Helder radars, but for the latter we have a lot of sea clutter that still needs to be removed, which is next on the list when filtering ground clutter.</p>
</div>
<div id="filter-ground-clutter" class="section level2" number="2.5">
<h2>
<span class="header-section-number">2.5</span> Filter ground clutter<a class="anchor" aria-label="anchor" href="#filter-ground-clutter"><i class="fas fa-link"></i></a>
</h2>
<p>We will filter out ground clutter by calculating summary statistics of the rangegate reflectivities over:</p>
<ol style="list-style-type: decimal">
<li>The 36 scans preceding the scans selected for the study of the fireworks event (= 3 hours worth of scans).</li>
<li>A day of clear weather closest to the 31st of December 2017.</li>
</ol>
<p>For each we will filter ground clutter based on the <em>mean</em> <code>DBZH</code> values. Using the <em>variance</em> and <em>mad</em> of the <code>DBZH</code> was tested, but has a few difficulties:</p>
<ol style="list-style-type: decimal">
<li>
<em>variance</em> is very sensitive to the outliers caused by rangegates with <code>NA</code> values (detection below the ‘mds’, the <em>minimum detectable signal</em>) occasionally flipping over to a noisy measurement, resulting in very high variances.</li>
<li>
<em>mad</em> is much more robust to outliers, but to compute these values we need to set <code>NA</code> cells to the ‘mds’ (<em>minimum detectable signal</em>), which will result in <em>mad</em> values close to, or exactly 0 for cells that never reflected as well as true static clutter, so it’s difficult to separate those.</li>
</ol>
<p>Finally, a visual inspection showed the <em>mean</em> and <em>mad</em> of <code>DBZH</code> (assuming one could overcome the aforementioned problem with the latter) do not differ much, but the <em>mean</em> is somewhat more ‘aggressive’ in filtering, which in this case is quite good.</p>
<p>Combining the clutter removal based on a clear day as well as the 36 preceding scans lets us account for both truly static clutter (e.g. buildings) as well as clutter that is more dynamic such as sea and wind park clutter, without also requiring us to resort to filtering of dynamic clutter using a <code>VRADH</code> threshold. The quality of filtering is assessed visually.</p>
<div id="dynamic-clutter" class="section level3" number="2.5.1">
<h3>
<span class="header-section-number">2.5.1</span> Dynamic clutter<a class="anchor" aria-label="anchor" href="#dynamic-clutter"><i class="fas fa-link"></i></a>
</h3>
<p>We select 36 (3 hours worth of scans) preceding the start of the fireworks (23:00 UTC) and add an additional margin of 3 scans (15 minutes of scans) as the <code>VIR</code> plots in the previous chapter have shown numbers of birds aloft are very low and stable up to that period.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">available_scans_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/clutter-removal-20171231"</span>, <span class="st">"*NL62*20171231*"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">available_scans_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/clutter-removal-20171231"</span>, <span class="st">"*NL61*20171231*"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">fw_start_hrw_pvol_path</span> <span class="op">&lt;-</span> <span class="st">"data/raw/pvol/fireworks-2017-2018/RAD_NL62_VOL_NA_201712312300_ODIM.h5"</span></span>
<span><span class="va">fw_start_dhl_pvol_path</span> <span class="op">&lt;-</span> <span class="st">"data/raw/pvol/fireworks-2017-2018/RAD_NL61_VOL_NA_201712312300_ODIM.h5"</span></span>
<span><span class="va">selected_scan_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"fireworks-2017-2018"</span>, <span class="st">"clutter-removal-20171231"</span>, <span class="va">fw_start_hrw_pvol_path</span><span class="op">)</span></span>
<span><span class="va">selected_scan_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html">sub</a></span><span class="op">(</span><span class="st">"fireworks-2017-2018"</span>, <span class="st">"clutter-removal-20171231"</span>, <span class="va">fw_start_dhl_pvol_path</span><span class="op">)</span></span>
<span></span>
<span><span class="va">selected_scan_id_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">selected_scan_hrw</span>, <span class="va">available_scans_hrw</span><span class="op">)</span></span>
<span><span class="va">selected_scan_id_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html">match</a></span><span class="op">(</span><span class="va">selected_scan_dhl</span>, <span class="va">available_scans_dhl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">usable_scans_hrw</span> <span class="op">&lt;-</span> <span class="va">available_scans_hrw</span><span class="op">[</span><span class="op">(</span><span class="va">selected_scan_id_hrw</span><span class="op">-</span><span class="va">dynamic_time_margin</span><span class="op">-</span><span class="va">dynamic_nr_preceding_scans</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span></span>
<span>                                          <span class="op">(</span><span class="va">selected_scan_id_hrw</span><span class="op">-</span><span class="va">dynamic_time_margin</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="va">usable_scans_dhl</span> <span class="op">&lt;-</span> <span class="va">available_scans_dhl</span><span class="op">[</span><span class="op">(</span><span class="va">selected_scan_id_dhl</span><span class="op">-</span><span class="va">dynamic_time_margin</span><span class="op">-</span><span class="va">dynamic_nr_preceding_scans</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span></span>
<span>                                          <span class="op">(</span><span class="va">selected_scan_id_dhl</span><span class="op">-</span><span class="va">dynamic_time_margin</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>We can now loop over the files one by one and stack reflectivity data (<code>DBZH</code>) — after filtering out precipitation — in a multidimensional array.</p>
<p><em>Note: the following code chunk will only run in full-reproduction mode as it takes quite a lot of time. Results are saved, so the next iteration this chunk can be skipped.</em></p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/stack_rainfree_reflectivities.R"</span><span class="op">)</span></span>
<span><span class="fu">stack_rainfree_reflectivities</span><span class="op">(</span><span class="va">usable_scans_hrw</span>, outputfile <span class="op">=</span> <span class="st">"data/processed/clutter_dynamic_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="fu">stack_rainfree_reflectivities</span><span class="op">(</span><span class="va">usable_scans_dhl</span>, outputfile <span class="op">=</span> <span class="st">"data/processed/clutter_dynamic_dhl.RDS"</span><span class="op">)</span></span></code></pre></div>
<p>With all <code>DBZH</code> compiled in a single multidimensional array, we can calculate <em>mean</em> reflectivity, which we store as <code>DBZH_AVG</code> in a <code>pvol</code> that now contains the dynamic clutter map.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pvol_clutter_dynamic_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="va">pvol_clutter_dynamic_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_dhl.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/calculate_reflectivity_stack_mean.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pvol_clutter_dynamic_hrw</span> <span class="op">&lt;-</span> <span class="fu">calculate_reflectivity_stack_mean</span><span class="op">(</span><span class="va">pvol_clutter_dynamic_hrw</span>, <span class="va">mds</span><span class="op">)</span></span>
<span><span class="va">pvol_clutter_dynamic_dhl</span> <span class="op">&lt;-</span> <span class="fu">calculate_reflectivity_stack_mean</span><span class="op">(</span><span class="va">pvol_clutter_dynamic_dhl</span>, <span class="va">mds</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">pvol_clutter_dynamic_hrw</span>, <span class="st">"data/processed/clutter_dynamic_hrw_avg.RDS"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">pvol_clutter_dynamic_dhl</span>, <span class="st">"data/processed/clutter_dynamic_dhl_avg.RDS"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pvol_clutter_dynamic_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_hrw_avg.RDS"</span><span class="op">)</span></span>
<span><span class="va">pvol_clutter_dynamic_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_dhl_avg.RDS"</span><span class="op">)</span></span></code></pre></div>
<div id="verify-dynamic-clutter-map" class="section level4" number="2.5.1.1">
<h4>
<span class="header-section-number">2.5.1.1</span> Verify dynamic clutter map<a class="anchor" aria-label="anchor" href="#verify-dynamic-clutter-map"><i class="fas fa-link"></i></a>
</h4>
<p>Let’s see what that looks like on a basemap, using a <code>DBZH_AVG</code> threshold of <span class="math inline">\(-10dbZ\)</span>, following <span class="citation">(<a href="references.html#ref-dokter_bird_2011" role="doc-biblioref">Dokter et al. 2011</a>)</span>.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scan_hrw</span> <span class="op">&lt;-</span> <span class="va">pvol_clutter_dynamic_hrw</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">scan_dhl</span> <span class="op">&lt;-</span> <span class="va">pvol_clutter_dynamic_dhl</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">side_by_side_ppi</span><span class="op">(</span><span class="va">pvol_clutter_dynamic_hrw</span>, <span class="va">pvol_clutter_dynamic_dhl</span>, <span class="st">"Herwijnen dynamic clutter"</span>, <span class="st">"Den Helder dynamic clutter"</span>, </span>
<span>                 params <span class="op">=</span> <span class="st">"DBZH_AVG"</span>, range_max <span class="op">=</span> <span class="fl">50000</span>, scan_id <span class="op">=</span> <span class="fl">1</span>, basemap <span class="op">=</span> <span class="cn">TRUE</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">11</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/verify_dynamic_clutter_map-1.png" width="100%"></div>
<p>Visually assessing this clutter map shows that it works quite well, selecting e.g. areas with wind parks, sea clutter, high buildings, industry, etc. Exactly what we hoped to achieve.</p>
</div>
</div>
<div id="static-clutter" class="section level3" number="2.5.2">
<h3>
<span class="header-section-number">2.5.2</span> Static clutter<a class="anchor" aria-label="anchor" href="#static-clutter"><i class="fas fa-link"></i></a>
</h3>
<p>Now, let’s retry exactly the same procedure, but this time selecting a day with no precipitation, which can be done using <a href="https://www.knmi.nl/nederland-nu/klimatologie/geografische-overzichten">this tool</a> by KNMI, so we can filter for truly static clutter.</p>
<p>We select the following days:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Herwijnen:</strong> December 29th, 2017</li>
<li>
<strong>Den Helder:</strong> December 25th, 2017</li>
</ol>
<p><em>Note: the following code chunk will only run in full-reproduction mode as it takes a lot of time to run. Results are saved, so the next iteration this chunk can be skipped.</em></p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/stack_rainfree_reflectivities.R"</span><span class="op">)</span></span>
<span><span class="va">available_scans_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/clutter-removal-20171229-hrw"</span>, <span class="st">"*NL62*20171229*"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">available_scans_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/clutter-removal-20171225-dhl"</span>, <span class="st">"*NL61*20171225*"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">stack_rainfree_reflectivities</span><span class="op">(</span><span class="va">available_scans_hrw</span>, outputfile <span class="op">=</span> <span class="st">"data/processed/clutter_static_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="fu">stack_rainfree_reflectivities</span><span class="op">(</span><span class="va">available_scans_dhl</span>, outputfile <span class="op">=</span> <span class="st">"data/processed/clutter_static_dhl.RDS"</span><span class="op">)</span></span></code></pre></div>
<p>And we calculate mean <code>DBZH</code> values (<code>DBZH_AVG</code>).</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pvol_clutter_static_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="va">pvol_clutter_static_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_dhl.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/calculate_reflectivity_stack_mean.R"</span><span class="op">)</span> <span class="co"># Source because full_repro may be set to FALSE</span></span>
<span></span>
<span><span class="va">pvol_clutter_static_hrw</span> <span class="op">&lt;-</span> <span class="fu">calculate_reflectivity_stack_mean</span><span class="op">(</span><span class="va">pvol_clutter_static_hrw</span>, <span class="va">mds</span><span class="op">)</span></span>
<span><span class="va">pvol_clutter_static_dhl</span> <span class="op">&lt;-</span> <span class="fu">calculate_reflectivity_stack_mean</span><span class="op">(</span><span class="va">pvol_clutter_static_dhl</span>, <span class="va">mds</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">pvol_clutter_static_hrw</span>, <span class="st">"data/processed/clutter_static_hrw_avg.RDS"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">pvol_clutter_static_dhl</span>, <span class="st">"data/processed/clutter_static_dhl_avg.RDS"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pvol_clutter_static_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_hrw_avg.RDS"</span><span class="op">)</span></span>
<span><span class="va">pvol_clutter_static_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_dhl_avg.RDS"</span><span class="op">)</span></span></code></pre></div>
<div id="verify-static-clutter-map" class="section level4" number="2.5.2.1">
<h4>
<span class="header-section-number">2.5.2.1</span> Verify static clutter map<a class="anchor" aria-label="anchor" href="#verify-static-clutter-map"><i class="fas fa-link"></i></a>
</h4>
<p>Once again, let’s see what that looks like on a basemap, using a <code>DBZH_AVG</code> threshold of <span class="math inline">\(-10dbZ\)</span>, following <span class="citation">(<a href="references.html#ref-dokter_bird_2011" role="doc-biblioref">Dokter et al. 2011</a>)</span>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">scan_hrw</span> <span class="op">&lt;-</span> <span class="va">pvol_clutter_static_hrw</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span><span class="va">scan_dhl</span> <span class="op">&lt;-</span> <span class="va">pvol_clutter_static_dhl</span><span class="op">$</span><span class="va">scans</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span><span class="fu">side_by_side_ppi</span><span class="op">(</span><span class="va">pvol_clutter_static_hrw</span>, <span class="va">pvol_clutter_static_dhl</span>, <span class="st">"Herwijnen static clutter"</span>, <span class="st">"Den Helder static clutter"</span>, </span>
<span>                 params <span class="op">=</span> <span class="st">"DBZH_AVG"</span>, range_max <span class="op">=</span> <span class="fl">50000</span>, scan_id <span class="op">=</span> <span class="fl">1</span>, basemap <span class="op">=</span> <span class="cn">TRUE</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">11</span>, <span class="op">-</span><span class="fl">10</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/verify_static_clutter_map-1.png" width="100%"></div>
</div>
</div>
<div id="remove-dynamic-and-static-clutter" class="section level3" number="2.5.3">
<h3>
<span class="header-section-number">2.5.3</span> Remove dynamic and static clutter<a class="anchor" aria-label="anchor" href="#remove-dynamic-and-static-clutter"><i class="fas fa-link"></i></a>
</h3>
<p>Now that we have identified both dynamic and static clutter, we can create the final cleaned up polar volume.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/remove_groundclutter.R"</span><span class="op">)</span></span>
<span><span class="va">pvol_hrw</span> <span class="op">&lt;-</span> <span class="fu">remove_groundclutter</span><span class="op">(</span><span class="fu">remove_groundclutter</span><span class="op">(</span><span class="va">pvol_hrw</span>, <span class="va">pvol_clutter_dynamic_hrw</span><span class="op">)</span>, <span class="va">pvol_clutter_static_hrw</span><span class="op">)</span></span>
<span><span class="va">pvol_dhl</span> <span class="op">&lt;-</span> <span class="fu">remove_groundclutter</span><span class="op">(</span><span class="fu">remove_groundclutter</span><span class="op">(</span><span class="va">pvol_dhl</span>, <span class="va">pvol_clutter_dynamic_dhl</span><span class="op">)</span>, <span class="va">pvol_clutter_static_dhl</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">pvol_hrw</span>, file <span class="op">=</span> <span class="st">"data/processed/pvol_clean_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">pvol_dhl</span>, file <span class="op">=</span> <span class="st">"data/processed/pvol_clean_dhl.RDS"</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="range-bias-correction" class="section level2" number="2.6">
<h2>
<span class="header-section-number">2.6</span> Range-bias correction<a class="anchor" aria-label="anchor" href="#range-bias-correction"><i class="fas fa-link"></i></a>
</h2>
<p>With all identifiable sources of clutter removed from the raw polar volume, we can apply the range-bias correction <span class="citation">(<a href="references.html#ref-kranstauber2020" role="doc-biblioref">Kranstauber et al. 2020</a>)</span>. For this it is necessary to calculate the local vertical profile for each of the radars. Ideally, this would be done using the filtered <code>pvol</code> we have now generated, but the <code>vol2bird</code> algorithm <span class="citation">(<a href="references.html#ref-dokter_bird_2011" role="doc-biblioref">Dokter et al. 2011</a>)</span> only takes <code>pvol</code> files as input, rather than R objects. As there is no implementation of a converter yet, for now a <code>vp</code> of the raw <code>pvol</code> files will have to do. As there is no precipitation within the relevant distance to the radars (5-35km), the calculated <code>vp</code> based on the raw <code>pvol</code> files should not differ wildly from that of the filtered <code>pvol</code> R object we have generated in the previous steps.</p>
<p>For the Den Helder radar we calculate the <code>vp</code> by setting azimuthal limits to cover the mainland of North Holland, rather than the whole radar domain, as the latter will result in <code>vp</code>s that underestimate the true density of birds aloft. See [the corresponding appendix][generating-vps-for-den-helder-radar] for a more detailed explanation.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">vp_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/calculate_vp.html">calculate_vp</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">pvol_hrw_path</span>, vpfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"data/processed/vp/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">pvol_hrw_path</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="va">vp_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/calculate_vp.html">calculate_vp</a></span><span class="op">(</span>file <span class="op">=</span> <span class="va">pvol_dhl_path</span>, vpfile <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"data/processed/vp/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/basename.html">basename</a></span><span class="op">(</span><span class="va">pvol_dhl_path</span><span class="op">)</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>, </span>
<span>                       verbose <span class="op">=</span> <span class="cn">FALSE</span>, azim_min <span class="op">=</span> <span class="fl">90</span>, azim_max <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span>
<span></span>
<span><span class="va">corrected_ppi_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/integrate_to_ppi.html">integrate_to_ppi</a></span><span class="op">(</span><span class="va">pvol_hrw</span>, <span class="va">vp_hrw</span>, res <span class="op">=</span> <span class="fl">500</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">corrected_ppi_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/integrate_to_ppi.html">integrate_to_ppi</a></span><span class="op">(</span><span class="va">pvol_dhl</span>, <span class="va">vp_dhl</span>, res <span class="op">=</span> <span class="fl">500</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">corrected_ppi_hrw</span>, file <span class="op">=</span> <span class="st">"data/processed/corrected_ppi_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">corrected_ppi_dhl</span>, file <span class="op">=</span> <span class="st">"data/processed/corrected_ppi_dhl.RDS"</span><span class="op">)</span></span></code></pre></div>
<p>We can now plot the final range-corrected PPIs.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_vir_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">corrected_ppi_hrw</span>, param <span class="op">=</span> <span class="st">"VIR"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Herwijnen: VIR"</span><span class="op">)</span></span>
<span><span class="va">p_vir_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">corrected_ppi_dhl</span>, param <span class="op">=</span> <span class="st">"VIR"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">20000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Den Helder: VIR"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">ggarrange</a></span><span class="op">(</span><span class="va">p_vir_hrw</span>, <span class="va">p_vir_dhl</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">1</span>, common.legend <span class="op">=</span> <span class="cn">TRUE</span>, legend <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/plot_corrected_vir-1.png" width="100%"></div>
</div>
<div id="keep-biologymeteorology-classification" class="section level2" number="2.7">
<h2>
<span class="header-section-number">2.7</span> Keep biology/meteorology classification<a class="anchor" aria-label="anchor" href="#keep-biologymeteorology-classification"><i class="fas fa-link"></i></a>
</h2>
<p>By default the range-bias correction returns values from 0 upwards, so there is no way for us to distinguish anymore between ‘pixels’ that did not reflect and those that were filtered out as meteorology. That’s why we will additionally add the <code>class</code> parameter to the range-bias corrected PPIs. To avoid misalignment and differences in vertical integration compared with the range-bias correction, we can ‘trick’ the RBC by replacing the <code>DBZH</code> values it expects by the <code>BIOLD</code>(despeckled biology) values (either 0 for meteorology or 1 for biology) multiplied by 1000. This would result in very high integrated values of <code>VIR</code> where an area is classified as biology and very low values where it is classified as meteorology.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pvol_hrw_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/calculate_param.html">calculate_param</a></span><span class="op">(</span><span class="va">pvol_hrw</span>, DBZH <span class="op">=</span> <span class="va">BIOLD</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">pvol_dhl_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/calculate_param.html">calculate_param</a></span><span class="op">(</span><span class="va">pvol_dhl</span>, DBZH <span class="op">=</span> <span class="va">BIOLD</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="va">pvol_hrw_classified</span> <span class="op">&lt;-</span> <span class="fu">remove_groundclutter</span><span class="op">(</span><span class="fu">remove_groundclutter</span><span class="op">(</span><span class="va">pvol_hrw_classified</span>, <span class="va">pvol_clutter_dynamic_hrw</span><span class="op">)</span>, <span class="va">pvol_clutter_static_hrw</span><span class="op">)</span></span>
<span><span class="va">pvol_dhl_classified</span> <span class="op">&lt;-</span> <span class="fu">remove_groundclutter</span><span class="op">(</span><span class="fu">remove_groundclutter</span><span class="op">(</span><span class="va">pvol_dhl_classified</span>, <span class="va">pvol_clutter_dynamic_dhl</span><span class="op">)</span>, <span class="va">pvol_clutter_static_dhl</span><span class="op">)</span></span>
<span></span>
<span><span class="va">corrected_ppi_hrw_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/integrate_to_ppi.html">integrate_to_ppi</a></span><span class="op">(</span><span class="va">pvol_hrw_classified</span>, <span class="va">vp_hrw</span>, res <span class="op">=</span> <span class="fl">500</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">corrected_ppi_dhl_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adriaandokter.com/bioRad/reference/integrate_to_ppi.html">integrate_to_ppi</a></span><span class="op">(</span><span class="va">pvol_dhl_classified</span>, <span class="va">vp_dhl</span>, res <span class="op">=</span> <span class="fl">500</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="op">-</span><span class="fl">150000</span>, <span class="fl">150000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_vir_hrw_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">corrected_ppi_hrw_classified</span>, param <span class="op">=</span> <span class="st">"VIR"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Herwijnen: VIR"</span><span class="op">)</span></span>
<span><span class="va">p_vir_dhl_classified</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/plot.html">plot</a></span><span class="op">(</span><span class="va">corrected_ppi_dhl_classified</span>, param <span class="op">=</span> <span class="st">"VIR"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50000</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Den Helder: VIR"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rpkgs.datanovia.com/ggpubr/reference/ggarrange.html">ggarrange</a></span><span class="op">(</span><span class="va">p_vir_hrw_classified</span>, <span class="va">p_vir_dhl_classified</span>, ncol <span class="op">=</span> <span class="fl">2</span>, nrow <span class="op">=</span> <span class="fl">1</span>, common.legend <span class="op">=</span> <span class="cn">TRUE</span>, legend <span class="op">=</span> <span class="st">"right"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="02.Radar-data-preprocessing_files/figure-html/plot_classification-1.png" width="672"></div>
<p>That looks good, so now we add it to the corrected PPIs. We reclassify the <code>VIR</code> as follows:</p>
<ol style="list-style-type: decimal">
<li>Biology gets <code>class = 2</code>,</li>
<li>Meteorology gets <code>class = 1</code>,</li>
<li>Background gets <code>class = 0</code>.</li>
</ol>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">corrected_ppi_hrw_classified</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">VIR</span> <span class="op">&gt;</span> <span class="fl">40000</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>    <span class="va">VIR</span> <span class="op">&lt;=</span> <span class="fl">40000</span> <span class="op">&amp;</span> <span class="va">VIR</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    <span class="va">VIR</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">class_hrw</span></span>
<span></span>
<span><span class="va">corrected_ppi_dhl_classified</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>class <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/case_when.html">case_when</a></span><span class="op">(</span></span>
<span>    <span class="va">VIR</span> <span class="op">&gt;</span> <span class="fl">40000</span> <span class="op">~</span> <span class="fl">2</span>,</span>
<span>    <span class="va">VIR</span> <span class="op">&lt;=</span> <span class="fl">40000</span> <span class="op">&amp;</span> <span class="va">VIR</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">1</span>,</span>
<span>    <span class="va">VIR</span> <span class="op">==</span> <span class="fl">0</span> <span class="op">~</span> <span class="fl">0</span></span>
<span>  <span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">class</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">class_dhl</span></span>
<span></span>
<span></span>
<span><span class="va">corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">class_hrw</span><span class="op">)</span></span>
<span><span class="va">corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">class</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="va">class_dhl</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="distance-to-radar" class="section level2" number="2.8">
<h2>
<span class="header-section-number">2.8</span> Distance to radar<a class="anchor" aria-label="anchor" href="#distance-to-radar"><i class="fas fa-link"></i></a>
</h2>
<p>To account for remaining range-bias effects, it is also useful to calculate the distance to the radar from a given PPI pixel. We can then include it in our modelling efforts later on.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/calculate_distance_to_radar.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">corrected_ppi_hrw</span> <span class="op">&lt;-</span> <span class="fu">calculate_distance_to_radar</span><span class="op">(</span><span class="va">corrected_ppi_hrw</span><span class="op">)</span></span>
<span><span class="va">corrected_ppi_dhl</span> <span class="op">&lt;-</span> <span class="fu">calculate_distance_to_radar</span><span class="op">(</span><span class="va">corrected_ppi_dhl</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="spatial-coordinates" class="section level2" number="2.9">
<h2>
<span class="header-section-number">2.9</span> Spatial coordinates<a class="anchor" aria-label="anchor" href="#spatial-coordinates"><i class="fas fa-link"></i></a>
</h2>
<p>Furthermore, it can be useful to keep spatial coordinates to correct for spatial autocorrelation should this be necessary, so we calculate these as well.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">coords_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html">coordinates</a></span><span class="op">(</span><span class="va">corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">coords_hrw</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">coords_hrw</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="va">coords_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/sp/man/coordinates.html">coordinates</a></span><span class="op">(</span><span class="va">corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span>
<span><span class="va">corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">coords_dhl</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span></span>
<span><span class="va">corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">coords_dhl</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">corrected_ppi_hrw</span>, file <span class="op">=</span> <span class="st">"data/processed/corrected_ppi_hrw.RDS"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">corrected_ppi_dhl</span>, file <span class="op">=</span> <span class="st">"data/processed/corrected_ppi_dhl.RDS"</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="visualising-range-bias-correction" class="section level2" number="2.10">
<h2>
<span class="header-section-number">2.10</span> Visualising range-bias correction<a class="anchor" aria-label="anchor" href="#visualising-range-bias-correction"><i class="fas fa-link"></i></a>
</h2>
<p>Now we can finally have a proper look at the range-corrected versions of the PPI overlaid on an interactive map. It’s a little hard to interpret with the PPI pixels that contain no birds set to <code>0</code> and no landscape below, so let’s see what it looks like on a basemap with those removed. As there are some ships out at the North Sea causing reflectivities orders of magnitude higher and thus stretching the colormap, we — for now — need to ‘clip’ these values to a maximum set at the value of the 99th percentile.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/clip.R"</span><span class="op">)</span></span>
<span><span class="va">filtered_corrected_ppi_hrw</span> <span class="op">&lt;-</span> <span class="va">corrected_ppi_hrw</span></span>
<span><span class="va">filtered_corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">filtered_corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span>, <span class="fl">2</span>, <span class="va">clip</span>, bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">filtered_corrected_ppi_dhl</span> <span class="op">&lt;-</span> <span class="va">corrected_ppi_dhl</span></span>
<span><span class="va">filtered_corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">filtered_corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span>, <span class="fl">2</span>, <span class="va">clip</span>, bounds <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.99</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p><em>Unfortunately, due to <a href="https://github.com/rstudio/bookdown/issues/15#issuecomment-573776659">the way <code>leaflet</code> stores maps it produces</a>, we cannot plot them here using K-M knitting to generate this document. Run these chunks interactively and they should work fine.</em></p>
<div id="range-corrected-ppi-of-herwijnen-radar" class="section level3" number="2.10.1">
<h3>
<span class="header-section-number">2.10.1</span> Range-corrected PPI of Herwijnen radar<a class="anchor" aria-label="anchor" href="#range-corrected-ppi-of-herwijnen-radar"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">corrected_ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="range-corrected-ppi-of-den-helder-radar" class="section level3" number="2.10.2">
<h3>
<span class="header-section-number">2.10.2</span> Range-corrected PPI of Den Helder radar<a class="anchor" aria-label="anchor" href="#range-corrected-ppi-of-den-helder-radar"><i class="fas fa-link"></i></a>
</h3>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/pkg/mapview/man/mapView.html">mapview</a></span><span class="op">(</span><span class="va">corrected_ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
<div id="preprocess-additional-scans" class="section level2" number="2.11">
<h2>
<span class="header-section-number">2.11</span> Preprocess additional scans<a class="anchor" aria-label="anchor" href="#preprocess-additional-scans"><i class="fas fa-link"></i></a>
</h2>
<p>Now that the processing steps have been explained in detail, we can process the additional scans in our dataset in a similar fashion. For that we will focus on all scans from 22:00 CET until 01:00 CET, which corresponds with 23:00 until 02:00 in local Amsterdam time, as that should ‘cover’ most of the fireworks disturbance that occurs (based on the plots in <a href="selecting-firework-take-off-moment.html#selecting-firework-take-off-moment">Selecting firework take-off moment</a>).</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/preprocess_radar_data.R"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hrw_pvols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/fireworks-2017-2018"</span>, <span class="st">"*NL62*"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dhl_pvols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/fireworks-2017-2018"</span>, <span class="st">"*NL61*"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dynamic_groundclutter_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_hrw_avg.RDS"</span><span class="op">)</span></span>
<span><span class="va">static_groundclutter_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_hrw_avg.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dynamic_groundclutter_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_dhl_avg.RDS"</span><span class="op">)</span></span>
<span><span class="va">static_groundclutter_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_dhl_avg.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">pvol</span> <span class="kw">in</span> <span class="va">hrw_pvols</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">preprocess_radar_data</span><span class="op">(</span>pvol_path <span class="op">=</span> <span class="va">pvol</span>, </span>
<span>                        ei_rays <span class="op">=</span> <span class="va">ei_rays_hrw</span>, </span>
<span>                        pvol_dynamic_groundclutter <span class="op">=</span> <span class="va">dynamic_groundclutter_hrw</span>,</span>
<span>                        pvol_static_groundclutter <span class="op">=</span> <span class="va">static_groundclutter_hrw</span>,</span>
<span>                        dir_out <span class="op">=</span> <span class="st">"data/processed/corrected-ppis/"</span>,</span>
<span>                        res <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">pvol</span> <span class="kw">in</span> <span class="va">dhl_pvols</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">preprocess_radar_data</span><span class="op">(</span>pvol_path <span class="op">=</span> <span class="va">pvol</span>,</span>
<span>                        ei_rays <span class="op">=</span> <span class="va">ei_rays_dhl</span>,</span>
<span>                        pvol_dynamic_groundclutter <span class="op">=</span> <span class="va">dynamic_groundclutter_dhl</span>,</span>
<span>                        pvol_static_groundclutter <span class="op">=</span> <span class="va">static_groundclutter_dhl</span>,</span>
<span>                        dir_out <span class="op">=</span> <span class="st">"data/processed/corrected-ppis/"</span>,</span>
<span>                        azim_limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>                        res <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div id="preprocess-baseline-disturbance-scans" class="section level2" number="2.12">
<h2>
<span class="header-section-number">2.12</span> Preprocess baseline disturbance scans<a class="anchor" aria-label="anchor" href="#preprocess-baseline-disturbance-scans"><i class="fas fa-link"></i></a>
</h2>
<p>As we want to be able to compare the disturbance to the baseline level of reflectivity on other nights at the same time, we have downloaded about 20 days of polar volumes surrounding, but not directly adjacent to the nights near NYE. In particular, we’ve downloaded polar volumes from December 15th til 25th and January 5th til 15th. To compare all these polar volumes, we have to treat them all the same, so here we will process the files for the disturbance baseline as well.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hrw_pvols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/disturbance-baseline"</span>, <span class="st">"NLHRW*"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">dhl_pvols</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/raw/pvol/disturbance-baseline"</span>, <span class="st">"NLDHL*"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dynamic_groundclutter_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_hrw_avg.RDS"</span><span class="op">)</span></span>
<span><span class="va">static_groundclutter_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_hrw_avg.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">dynamic_groundclutter_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_dynamic_dhl_avg.RDS"</span><span class="op">)</span></span>
<span><span class="va">static_groundclutter_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/clutter_static_dhl_avg.RDS"</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">pvol</span> <span class="kw">in</span> <span class="va">hrw_pvols</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">preprocess_radar_data</span><span class="op">(</span>pvol_path <span class="op">=</span> <span class="va">pvol</span>, </span>
<span>                        ei_rays <span class="op">=</span> <span class="va">ei_rays_hrw</span>, </span>
<span>                        pvol_dynamic_groundclutter <span class="op">=</span> <span class="va">dynamic_groundclutter_hrw</span>,</span>
<span>                        pvol_static_groundclutter <span class="op">=</span> <span class="va">static_groundclutter_hrw</span>,</span>
<span>                        dir_out <span class="op">=</span> <span class="st">"data/processed/baseline-ppis/"</span>,</span>
<span>                        res <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">pvol</span> <span class="kw">in</span> <span class="va">dhl_pvols</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">preprocess_radar_data</span><span class="op">(</span>pvol_path <span class="op">=</span> <span class="va">pvol</span>,</span>
<span>                        ei_rays <span class="op">=</span> <span class="va">ei_rays_dhl</span>,</span>
<span>                        pvol_dynamic_groundclutter <span class="op">=</span> <span class="va">dynamic_groundclutter_dhl</span>,</span>
<span>                        pvol_static_groundclutter <span class="op">=</span> <span class="va">static_groundclutter_dhl</span>,</span>
<span>                        dir_out <span class="op">=</span> <span class="st">"data/processed/baseline-ppis/"</span>,</span>
<span>                        azim_limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">90</span>, <span class="fl">200</span><span class="op">)</span>,</span>
<span>                        res <span class="op">=</span> <span class="fl">500</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>

</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="selecting-firework-take-off-moment.html"><span class="header-section-number">1</span> Selecting firework take-off moment</a></div>
<div class="next"><a href="annotating-land-use.html"><span class="header-section-number">3</span> Annotating land use</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#radar-data-preprocessing"><span class="header-section-number">2</span> Radar Data Preprocessing</a></li>
<li><a class="nav-link" href="#processing-environment-1"><span class="header-section-number">2.1</span> Processing environment</a></li>
<li>
<a class="nav-link" href="#removing-electromagnetic-interference"><span class="header-section-number">2.2</span> Removing electromagnetic interference</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#verify-removal-of-rays-with-em-interference"><span class="header-section-number">2.2.1</span> Verify removal of rays with EM interference</a></li></ul>
</li>
<li>
<a class="nav-link" href="#filter-meteorology-using-the-depolarization-ratio"><span class="header-section-number">2.3</span> Filter meteorology using the depolarization ratio</a><ul class="nav navbar-nav"><li><a class="nav-link" href="#verify-dpr-based-classification"><span class="header-section-number">2.3.1</span> Verify DPR-based classification</a></li></ul>
</li>
<li><a class="nav-link" href="#remove-classified-precipitation-from-polar-volumes"><span class="header-section-number">2.4</span> Remove classified precipitation from polar volumes</a></li>
<li>
<a class="nav-link" href="#filter-ground-clutter"><span class="header-section-number">2.5</span> Filter ground clutter</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#dynamic-clutter"><span class="header-section-number">2.5.1</span> Dynamic clutter</a></li>
<li><a class="nav-link" href="#static-clutter"><span class="header-section-number">2.5.2</span> Static clutter</a></li>
<li><a class="nav-link" href="#remove-dynamic-and-static-clutter"><span class="header-section-number">2.5.3</span> Remove dynamic and static clutter</a></li>
</ul>
</li>
<li><a class="nav-link" href="#range-bias-correction"><span class="header-section-number">2.6</span> Range-bias correction</a></li>
<li><a class="nav-link" href="#keep-biologymeteorology-classification"><span class="header-section-number">2.7</span> Keep biology/meteorology classification</a></li>
<li><a class="nav-link" href="#distance-to-radar"><span class="header-section-number">2.8</span> Distance to radar</a></li>
<li><a class="nav-link" href="#spatial-coordinates"><span class="header-section-number">2.9</span> Spatial coordinates</a></li>
<li>
<a class="nav-link" href="#visualising-range-bias-correction"><span class="header-section-number">2.10</span> Visualising range-bias correction</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#range-corrected-ppi-of-herwijnen-radar"><span class="header-section-number">2.10.1</span> Range-corrected PPI of Herwijnen radar</a></li>
<li><a class="nav-link" href="#range-corrected-ppi-of-den-helder-radar"><span class="header-section-number">2.10.2</span> Range-corrected PPI of Den Helder radar</a></li>
</ul>
</li>
<li><a class="nav-link" href="#preprocess-additional-scans"><span class="header-section-number">2.11</span> Preprocess additional scans</a></li>
<li><a class="nav-link" href="#preprocess-baseline-disturbance-scans"><span class="header-section-number">2.12</span> Preprocess baseline disturbance scans</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/barthoekstra/fireworks/blob/master/02.Radar-data-preprocessing.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/barthoekstra/fireworks/edit/master/02.Radar-data-preprocessing.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Fireworks</strong>" was written by Bart Hoekstra. It was last built on 2022-07-20.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
