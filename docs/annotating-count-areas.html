<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>4 Annotating count areas | Fireworks</title>
<meta name="author" content="Bart Hoekstra">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4.9002/tabs.js"></script><script src="libs/bs3compat-0.2.4.9002/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Fireworks</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li class="book-part">Weather radar data</li>
<li><a class="" href="selecting-firework-take-off-moment.html"><span class="header-section-number">1</span> Selecting firework take-off moment</a></li>
<li><a class="" href="radar-data-preprocessing.html"><span class="header-section-number">2</span> Radar Data Preprocessing</a></li>
<li class="book-part">Land use</li>
<li><a class="" href="annotating-land-use.html"><span class="header-section-number">3</span> Annotating land use</a></li>
<li class="book-part">Sovon counts</li>
<li><a class="active" href="annotating-count-areas.html"><span class="header-section-number">4</span> Annotating count areas</a></li>
<li><a class="" href="processing-count-results.html"><span class="header-section-number">5</span> Processing count results</a></li>
<li><a class="" href="apply-processing-to-all-ppis.html"><span class="header-section-number">6</span> Apply processing to all PPIs</a></li>
<li><a class="" href="composite-all-ppis.html"><span class="header-section-number">7</span> Composite all PPIs</a></li>
<li class="book-part">Fireworks disturbance</li>
<li><a class="" href="modelling-fireworks-disturbance.html"><span class="header-section-number">8</span> Modelling fireworks disturbance</a></li>
<li><a class="" href="quantifying-model-uncertainty.html"><span class="header-section-number">9</span> Quantifying model uncertainty</a></li>
<li class="book-part">Figures</li>
<li><a class="" href="figure-1-data-overview.html"><span class="header-section-number">10</span> Figure 1: Data overview</a></li>
<li><a class="" href="figure-2-model-output.html"><span class="header-section-number">11</span> Figure 2: Model output</a></li>
<li><a class="" href="figure-3-species-composition.html"><span class="header-section-number">12</span> Figure 3: Species composition</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="generating-vps-for-den-helder-radar.html"><span class="header-section-number">13</span> Generating vertical profiles for Den Helder radar</a></li>
<li class="book-part">Other</li>
<li><a class="" href="references.html"><span class="header-section-number">14</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/barthoekstra/fireworks">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="annotating-count-areas" class="section level1">
<h1>
<span class="header-section-number">4</span> Annotating count areas<a class="anchor" aria-label="anchor" href="#annotating-count-areas"><i class="fas fa-link"></i></a>
</h1>
<p>We have data for the following counts provided by Sovon:</p>
<ol style="list-style-type: decimal">
<li>Waterbird counts with a shapefile containing the surveyed areas and an <code>xlsx</code> file with the count results. Both can be linked using the identifiers contained in both datasets.</li>
<li>PTT counts, or point transect counts, contained within an <code>xlsx</code> file with the routes and all bird observations at an <span class="math inline">\((X, Y)\)</span> location.</li>
</ol>
<p>To make processing efficient, we will ‘annotate’ the PPIs with the corresponding area codes for the waterbird counts and some identifier for the PTT counts. Doing so, we can later on calculate relevant count-based parameters (e.g. bird biomass, etc.) and ‘join’ these by the corresponding identifiers.</p>
<div id="processing-environment-3" class="section level2">
<h2>
<span class="header-section-number">4.1</span> Processing environment<a class="anchor" aria-label="anchor" href="#processing-environment-3"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb78"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/adokter/bioRad">bioRad</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/stars/">stars</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://readr.tidyverse.org">readr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://readxl.tidyverse.org">readxl</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sjmgarnier/viridis">viridis</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ecohealthalliance/fasterize">fasterize</a></span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ppi_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/corrected_ppi_hrw_lu.RDS"</span><span class="op">)</span>
<span class="va">ppi_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="st">"data/processed/corrected_ppi_dhl_lu.RDS"</span><span class="op">)</span></code></pre></div>
</div>
<div id="annotate-ppis-with-waterbird-area-codes" class="section level2">
<h2>
<span class="header-section-number">4.2</span> Annotate PPIs with waterbird area codes<a class="anchor" aria-label="anchor" href="#annotate-ppis-with-waterbird-area-codes"><i class="fas fa-link"></i></a>
</h2>
<p>We rename the veriables retained in the shapefile to English and add a numerical <code>wb_area_id</code> which we can use to link the information retained in the shapefiles with the rasterized waterbird areas. All shapefiles are transformed to the CRS of the PPIs.</p>
<div class="sourceCode" id="cb80"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">wb_areas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="st">"data/raw/sovon/wavo_telgebieden.shp"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>wb_area_nr <span class="op">=</span> <span class="va">GEBIEDNR</span>, wb_area_ha <span class="op">=</span> <span class="va">OPPHA</span>, xcoor <span class="op">=</span> <span class="va">XCOOR</span>, ycoor <span class="op">=</span> <span class="va">YCOOR</span><span class="op">)</span>
<span class="va">wb_areas</span><span class="op">$</span><span class="va">wb_area_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">wb_areas</span><span class="op">$</span><span class="va">wb_area_nr</span><span class="op">)</span><span class="op">)</span>

<span class="va">wb_areas_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">wb_areas</span>, <span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">proj4string</span><span class="op">)</span>
<span class="va">wb_areas_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">wb_areas</span>, <span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">proj4string</span><span class="op">)</span></code></pre></div>
<pre><code>## Reading layer `wavo_telgebieden' from data source `/mnt/fireworks/raw/sovon/wavo_telgebieden.shp' using driver `ESRI Shapefile'
## Simple feature collection with 4131 features and 4 fields
## geometry type:  MULTIPOLYGON
## dimension:      XY
## bbox:           xmin: 13551.48 ymin: 307546.8 xmax: 278027 ymax: 622790
## proj4string:    +proj=sterea +lat_0=52.15616055555555 +lon_0=5.38763888888889 +k=0.9999079 +x_0=155000 +y_0=463000 +ellps=bessel +units=m +no_defs</code></pre>
<p>We rasterize specifically the newly created <code>wb_area_id</code> (as this is already a numerical and not categorical value like <code>wb_area_nr</code>) following the ‘template’ of the existing PPIs.</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tpl_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, dx <span class="op">=</span> <span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">grid</span><span class="op">@</span><span class="va">cellsize</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, dy <span class="op">=</span> <span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">grid</span><span class="op">@</span><span class="va">cellsize</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, values <span class="op">=</span> <span class="cn">NA_real_</span><span class="op">)</span>
<span class="va">tpl_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_as_stars.html">st_as_stars</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_bbox.html">st_bbox</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>, dx <span class="op">=</span> <span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">grid</span><span class="op">@</span><span class="va">cellsize</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, dy <span class="op">=</span> <span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">grid</span><span class="op">@</span><span class="va">cellsize</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, values <span class="op">=</span> <span class="cn">NA_real_</span><span class="op">)</span>

<span class="va">wb_areas_rasterized_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">st_rasterize</a></span><span class="op">(</span><span class="va">wb_areas_hrw</span><span class="op">[</span><span class="st">"wb_area_id"</span><span class="op">]</span>, template <span class="op">=</span> <span class="va">tpl_hrw</span><span class="op">)</span>
<span class="va">wb_areas_rasterized_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://r-spatial.github.io/stars/reference/st_rasterize.html">st_rasterize</a></span><span class="op">(</span><span class="va">wb_areas_dhl</span><span class="op">[</span><span class="st">"wb_area_id"</span><span class="op">]</span>, template <span class="op">=</span> <span class="va">tpl_dhl</span><span class="op">)</span></code></pre></div>
<p>Let’s see how that’s gone so far.</p>
<div class="sourceCode" id="cb83"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/graphics/par.html">par</a></span><span class="op">(</span>pty <span class="op">=</span> <span class="st">"s"</span>, mfrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">wb_areas_rasterized_hrw</span>, main <span class="op">=</span> <span class="st">"Herwijnen: wb_area_id"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">wb_areas_rasterized_dhl</span>, main <span class="op">=</span> <span class="st">"Den Helder: wb_area_id"</span><span class="op">)</span></code></pre></div>
<p><img src="04.Annotate-count-areas_files/figure-html/show_rasterized_waterbird_areas-1.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/show_rasterized_waterbird_areas-2.png" width="672"></p>
<p>Visually that seems to have gone well, now let’s make sure the rasterized waterbird areas share the same grid as the PPI ‘rasters’.</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/compare.html">compareRaster</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">wb_areas_rasterized_hrw</span>, <span class="st">"Raster"</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span>, <span class="st">"RasterLayer"</span><span class="op">)</span>, extent <span class="op">=</span> <span class="cn">TRUE</span>, rowcol <span class="op">=</span> <span class="cn">TRUE</span>, crs <span class="op">=</span> <span class="cn">TRUE</span>, res <span class="op">=</span> <span class="cn">TRUE</span>, orig <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/compare.html">compareRaster</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">wb_areas_rasterized_dhl</span>, <span class="st">"Raster"</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span>, <span class="st">"RasterLayer"</span><span class="op">)</span>, extent <span class="op">=</span> <span class="cn">TRUE</span>, rowcol <span class="op">=</span> <span class="cn">TRUE</span>, crs <span class="op">=</span> <span class="cn">TRUE</span>, res <span class="op">=</span> <span class="cn">TRUE</span>, orig <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE
## [1] TRUE</code></pre>
<p>Twice a <code>TRUE</code>, so the rasters are identical (except for the values), so we can merge the datasets using a <code>join</code> on the <code>wb_area_id</code>.</p>
<div class="sourceCode" id="cb86"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Add the wb_area_id to the PPIs</span>
<span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">wb_area_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">wb_areas_rasterized_hrw</span>, <span class="st">"Raster"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">wb_area_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">wb_areas_rasterized_dhl</span>, <span class="st">"Raster"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>

<span class="co"># Join the additional contents of the shapefiles</span>
<span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">wb_areas_hrw</span><span class="op">)</span>, <span class="va">wb_area_id</span>, <span class="va">wb_area_nr</span>, <span class="va">wb_area_ha</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wb_area_id"</span> <span class="op">=</span> <span class="st">"wb_area_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span>
<span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>

<span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">wb_areas_dhl</span><span class="op">)</span>, <span class="va">wb_area_id</span>, <span class="va">wb_area_nr</span>, <span class="va">wb_area_ha</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"wb_area_id"</span> <span class="op">=</span> <span class="st">"wb_area_id"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span>
<span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">geometry</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></code></pre></div>
<p>Let’s verify if that occurred as planned.</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ppi_hrw</span>, param <span class="op">=</span> <span class="st">"wb_area_id"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">wb_area_id</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">wb_area_id</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ppi_dhl</span>, param <span class="op">=</span> <span class="st">"wb_area_id"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">wb_area_id</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">wb_area_id</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="04.Annotate-count-areas_files/figure-html/plot_waterbirds_ppis-1.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/plot_waterbirds_ppis-2.png" width="672"></p>
<p>This looks very comparable to the plots of the rasterized scans above and <code>wb_area_id</code> shows similar areas in similar colors, so this worked fine.</p>
</div>
<div id="annotate-ppis-with-point-transect-counts" class="section level2">
<h2>
<span class="header-section-number">4.3</span> Annotate PPIs with point-transect-counts<a class="anchor" aria-label="anchor" href="#annotate-ppis-with-point-transect-counts"><i class="fas fa-link"></i></a>
</h2>
<p>The PTT point transect counts are organized by routes, which consist of a few points along a transect/route. We can follow the same approach as above with the waterbird counts, by first creating coverage shapes (like the shapefile features for the waterbird areas) for each of the routes. Using the convex hull of the points within a route seems like a good starting point to convert these points to areas. However, in that case it would appear as if birds are only counted when looking ‘inwards’ to this shape. By buffering these convex hulls with a radius of the average distance between successive points, a more representative coverage area can be generated that generalises well across landscapes (e.g. the area covered in a dense forest would tend to be smaller than in open agricultural areas).</p>
<div id="loading-ptt-points" class="section level3">
<h3>
<span class="header-section-number">4.3.1</span> Loading PTT points<a class="anchor" aria-label="anchor" href="#loading-ptt-points"><i class="fas fa-link"></i></a>
</h3>
<p>We load the PTT data directly from the <code>xlsx</code> file provided by Sovon and rename the variables to English.</p>
<div class="sourceCode" id="cb88"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://readxl.tidyverse.org/reference/read_excel.html">read_excel</a></span><span class="op">(</span><span class="st">"data/raw/sovon/tel_dec_jan_1718.xlsx"</span>, sheet <span class="op">=</span> <span class="st">"ptt"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>count_id <span class="op">=</span> <span class="va">tellingid</span>, route <span class="op">=</span> <span class="va">route</span>, count_point <span class="op">=</span> <span class="va">telpunt</span>, season <span class="op">=</span> <span class="va">seizoen</span>, year <span class="op">=</span> <span class="va">teljaar</span>, month <span class="op">=</span> <span class="va">maand</span>, day <span class="op">=</span> <span class="va">dag</span>, species <span class="op">=</span> <span class="va">soort</span>, number <span class="op">=</span> <span class="va">aantal</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="va">ptt</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">count_id</th>
<th align="right">route</th>
<th align="right">count_point</th>
<th align="right">season</th>
<th align="right">year</th>
<th align="right">month</th>
<th align="right">day</th>
<th align="right">euring</th>
<th align="left">species</th>
<th align="right">number</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">720</td>
<td align="left">Aalscholver</td>
<td align="right">2</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">5920</td>
<td align="left">Zilvermeeuw</td>
<td align="right">18</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">6700</td>
<td align="left">Houtduif</td>
<td align="right">1</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">11870</td>
<td align="left">Merel</td>
<td align="right">4</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">1</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15630</td>
<td align="left">Roek</td>
<td align="right">24</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">6700</td>
<td align="left">Houtduif</td>
<td align="right">1</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">11870</td>
<td align="left">Merel</td>
<td align="right">1</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15600</td>
<td align="left">Kauw</td>
<td align="right">6</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="odd">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">2</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">15630</td>
<td align="left">Roek</td>
<td align="right">78</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="even">
<td align="right">80917</td>
<td align="right">4</td>
<td align="right">3</td>
<td align="right">2017</td>
<td align="right">2017</td>
<td align="right">12</td>
<td align="right">23</td>
<td align="right">14620</td>
<td align="left">Pimpelmees</td>
<td align="right">2</td>
<td align="right">246692</td>
<td align="right">523139</td>
</tr>
</tbody>
</table></div>
</div>
<p>As we’re not interested in all the data here, we will load a subset of the columns, specifically all unique combinations of routes and points, which will yield the corresponding <code>xcoor</code> and <code>ycoor</code> coordinates for each <code>count_point</code> within a <code>route</code>.</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptt</span> <span class="op">%&gt;%</span>
  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">route</span>, <span class="va">count_point</span>, <span class="va">xcoor</span>, <span class="va">ycoor</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">route</span>, <span class="va">count_point</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="va">ptt</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">route</th>
<th align="right">count_point</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">4</td>
<td align="right">1</td>
<td align="right">246342</td>
<td align="right">520763</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">2</td>
<td align="right">246357</td>
<td align="right">522178</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">3</td>
<td align="right">246692</td>
<td align="right">523139</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">4</td>
<td align="right">248122</td>
<td align="right">522563</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">5</td>
<td align="right">248249</td>
<td align="right">521818</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">6</td>
<td align="right">248649</td>
<td align="right">523073</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">7</td>
<td align="right">249142</td>
<td align="right">523614</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">8</td>
<td align="right">250073</td>
<td align="right">523534</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">9</td>
<td align="right">252142</td>
<td align="right">523524</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">10</td>
<td align="right">253056</td>
<td align="right">523458</td>
</tr>
</tbody>
</table></div>
</div>
</div>
<div id="calculate-interpoint-distances" class="section level3">
<h3>
<span class="header-section-number">4.3.2</span> Calculate interpoint distances<a class="anchor" aria-label="anchor" href="#calculate-interpoint-distances"><i class="fas fa-link"></i></a>
</h3>
<p>For each of the routes within the PTT dataset, we will calculate the average distance between the subsequent points, to buffer our convex hull by this value.</p>
<div class="sourceCode" id="cb90"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptt</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>xcoor2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">xcoor</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span>,
         ycoor2 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">ycoor</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rowwise.html">rowwise</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>interpoint_distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/pointDistance.html">pointDistance</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">xcoor</span>, <span class="va">ycoor</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span><span class="va">xcoor2</span>, <span class="va">ycoor2</span><span class="op">)</span>, lonlat <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">xcoor2</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="co"># Throw out last point from route where distance to next point is not relevant</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">route</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html">summarise</a></span><span class="op">(</span>avg_interpoint_distance <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">interpoint_distance</span><span class="op">)</span>, .groups <span class="op">=</span> <span class="st">"keep"</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt_interpoint_distances</span>
  
<span class="va">ptt</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ptt_interpoint_distances</span>, by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"route"</span> <span class="op">=</span> <span class="st">"route"</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt</span>

<span class="fu"><a href="https://rdrr.io/pkg/raster/man/headtail.html">head</a></span><span class="op">(</span><span class="va">ptt</span>, <span class="fl">10</span><span class="op">)</span></code></pre></div>
<div class="kable-table">
<div class="inline-table"><table class="table table-sm">
<thead><tr class="header">
<th align="right">route</th>
<th align="right">count_point</th>
<th align="right">xcoor</th>
<th align="right">ycoor</th>
<th align="right">avg_interpoint_distance</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="right">4</td>
<td align="right">1</td>
<td align="right">246342</td>
<td align="right">520763</td>
<td align="right">1162.042</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">2</td>
<td align="right">246357</td>
<td align="right">522178</td>
<td align="right">1162.042</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">3</td>
<td align="right">246692</td>
<td align="right">523139</td>
<td align="right">1162.042</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">4</td>
<td align="right">248122</td>
<td align="right">522563</td>
<td align="right">1162.042</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">5</td>
<td align="right">248249</td>
<td align="right">521818</td>
<td align="right">1162.042</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">6</td>
<td align="right">248649</td>
<td align="right">523073</td>
<td align="right">1162.042</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">7</td>
<td align="right">249142</td>
<td align="right">523614</td>
<td align="right">1162.042</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">8</td>
<td align="right">250073</td>
<td align="right">523534</td>
<td align="right">1162.042</td>
</tr>
<tr class="odd">
<td align="right">4</td>
<td align="right">9</td>
<td align="right">252142</td>
<td align="right">523524</td>
<td align="right">1162.042</td>
</tr>
<tr class="even">
<td align="right">4</td>
<td align="right">10</td>
<td align="right">253056</td>
<td align="right">523458</td>
<td align="right">1162.042</td>
</tr>
</tbody>
</table></div>
</div>
<p>We can now calculate the convex hulls of the points grouped by <code>route</code>.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptt</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"xcoor"</span>, <span class="st">"ycoor"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">28992</span><span class="op">)</span> <span class="op">%&gt;%</span>  <span class="co"># original CRS = EPSG:28992 (RD New)</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">proj4string</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">route</span>, <span class="va">avg_interpoint_distance</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html">summarise</a></span><span class="op">(</span>.groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt_convex_hulls_hrw</span>  <span class="co"># Somehow it's necessary to reconvert to sf?</span>

<span class="va">ptt</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">ungroup</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span>coords <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"xcoor"</span>, <span class="st">"ycoor"</span><span class="op">)</span>, crs <span class="op">=</span> <span class="fl">28992</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span>crs <span class="op">=</span> <span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">proj4string</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">route</span>, <span class="va">avg_interpoint_distance</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/tidyverse.html">summarise</a></span><span class="op">(</span>.groups <span class="op">=</span> <span class="st">"drop"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_convex_hull</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_as_sf.html">st_as_sf</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt_convex_hulls_dhl</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_hrw</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"PTT Routes Herwijnen: Route"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_hrw</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"PTT Routes Herwijnen: Avg interpoint dist."</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_dhl</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"PTT Routes Den Helder: Route"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_dhl</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"PTT Routes Den Helder: Avg interpoint dist."</span><span class="op">)</span></code></pre></div>
<p><img src="04.Annotate-count-areas_files/figure-html/calculate_route_convex_hulls-1.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/calculate_route_convex_hulls-2.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/calculate_route_convex_hulls-3.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/calculate_route_convex_hulls-4.png" width="672"></p>
<p>As we have calculated the average distance between the points, we can now buffer the convex hulls by this value to attain more representative sizes of the covered areas.</p>
<div class="sourceCode" id="cb92"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptt_convex_hulls_hrw</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_hrw</span><span class="op">$</span><span class="va">avg_interpoint_distance</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt_convex_hulls_hrw</span>

<span class="va">ptt_convex_hulls_dhl</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://r-spatial.github.io/sf/reference/geos_unary.html">st_buffer</a></span><span class="op">(</span>dist <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html">as.double</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_dhl</span><span class="op">$</span><span class="va">avg_interpoint_distance</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">ptt_convex_hulls_dhl</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_hrw</span>, <span class="st">"data/processed/sovon/ptt_convex_hulls_hrw.shp"</span>, delete_dsn <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_write.html">st_write</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_dhl</span>, <span class="st">"data/processed/sovon/ptt_convex_hulls_dhl.shp"</span>, delete_dsn <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_hrw</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Buffered PTT Routes Herwijnen"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_dhl</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, main <span class="op">=</span> <span class="st">"Buffered PTT Routes Den Helder"</span><span class="op">)</span></code></pre></div>
<pre><code>## Deleting source `data/processed/sovon/ptt_convex_hulls_hrw.shp' using driver `ESRI Shapefile'
## Writing layer `ptt_convex_hulls_hrw' to data source `data/processed/sovon/ptt_convex_hulls_hrw.shp' using driver `ESRI Shapefile'
## Writing 591 features with 2 fields and geometry type Polygon.
## Deleting source `data/processed/sovon/ptt_convex_hulls_dhl.shp' using driver `ESRI Shapefile'
## Writing layer `ptt_convex_hulls_dhl' to data source `data/processed/sovon/ptt_convex_hulls_dhl.shp' using driver `ESRI Shapefile'
## Writing 591 features with 2 fields and geometry type Polygon.</code></pre>
<p><img src="04.Annotate-count-areas_files/figure-html/buffer_convex_hulls_with_interpoint_distance-1.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/buffer_convex_hulls_with_interpoint_distance-2.png" width="672"></p>
<p>Now that is taken care of, we can rasterize the polygons using the <code>fasterize</code> package. As there is overlap between the areas covered by the routes using the convex hulls and a raster can only contain a single value for every pixel, we need to resolve this overlap. In this case we will compare overlapping areas and pick those where the average distance between the points for that area is lowest. This biases towards counts that cover a smaller area, so probably resulting in more accurate estimates of birds around.</p>
<div class="sourceCode" id="cb94"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ptt_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
<span class="va">ptt_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>

<span class="va">ptt_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/fasterize/man/fasterize.html">fasterize</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_hrw</span>, <span class="va">ptt_hrw</span>, field <span class="op">=</span> <span class="st">"route"</span>, by <span class="op">=</span> <span class="st">"avg_interpoint_distance"</span><span class="op">)</span>
<span class="va">ptt_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/fasterize/man/fasterize.html">fasterize</a></span><span class="op">(</span><span class="va">ptt_convex_hulls_dhl</span>, <span class="va">ptt_dhl</span>, field <span class="op">=</span> <span class="st">"route"</span>, by <span class="op">=</span> <span class="st">"avg_interpoint_distance"</span><span class="op">)</span>

<span class="va">ptt_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stackApply.html">stackApply</a></span><span class="op">(</span><span class="va">ptt_hrw</span>, indices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ptt_hrw</span><span class="op">)</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">min</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">ptt_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/warning.html">suppressWarnings</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stackApply.html">stackApply</a></span><span class="op">(</span><span class="va">ptt_dhl</span>, indices <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="va">ptt_dhl</span><span class="op">)</span><span class="op">)</span>, fun <span class="op">=</span> <span class="va">min</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_hrw</span>, main <span class="op">=</span> <span class="st">"Rasterized PTT routes Herwijnen"</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ptt_dhl</span>, main <span class="op">=</span> <span class="st">"Rasterized PTT routes Den Helder"</span><span class="op">)</span></code></pre></div>
<p><img src="04.Annotate-count-areas_files/figure-html/rasterize_convex_hulls-1.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/rasterize_convex_hulls-2.png" width="672"></p>
<p>With the rasterization done, let’s compare the resultant raster and see if it is identical to the PPIs.</p>
<div class="sourceCode" id="cb95"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/compare.html">compareRaster</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ptt_hrw</span>, <span class="st">"Raster"</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span>, <span class="st">"RasterLayer"</span><span class="op">)</span>, extent <span class="op">=</span> <span class="cn">TRUE</span>, rowcol <span class="op">=</span> <span class="cn">TRUE</span>, crs <span class="op">=</span> <span class="cn">TRUE</span>, res <span class="op">=</span> <span class="cn">TRUE</span>, orig <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/compare.html">compareRaster</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ptt_dhl</span>, <span class="st">"Raster"</span><span class="op">)</span>, <span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span>, <span class="st">"RasterLayer"</span><span class="op">)</span>, extent <span class="op">=</span> <span class="cn">TRUE</span>, rowcol <span class="op">=</span> <span class="cn">TRUE</span>, crs <span class="op">=</span> <span class="cn">TRUE</span>, res <span class="op">=</span> <span class="cn">TRUE</span>, orig <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></code></pre></div>
<pre><code>## [1] TRUE
## [1] TRUE</code></pre>
<p>Two TRUEs, so that’s excellent. We can now add the <code>ptt_route</code> to the PPIs.</p>
<div class="sourceCode" id="cb97"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ptt_route</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ptt_hrw</span>, <span class="st">"Raster"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">ptt_route</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://r-spatial.github.io/sf/reference/coerce-methods.html">as</a></span><span class="op">(</span><span class="va">ptt_dhl</span>, <span class="st">"Raster"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p>Let’s verify once again if that occurred as planned.</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ppi_hrw</span>, param <span class="op">=</span> <span class="st">"ptt_route"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">ptt_route</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">ptt_route</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="fu"><a href="https://r-spatial.github.io/sf/reference/plot.html">plot</a></span><span class="op">(</span><span class="va">ppi_dhl</span>, param <span class="op">=</span> <span class="st">"ptt_route"</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">ptt_route</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">ptt_route</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="04.Annotate-count-areas_files/figure-html/plot_ptt_ppis-1.png" width="672"><img src="04.Annotate-count-areas_files/figure-html/plot_ptt_ppis-2.png" width="672"></p>
<p>That seems fine, we can now save the PPIs, so we can start linking actual count data.</p>
<div class="sourceCode" id="cb99"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">ppi_hrw</span>, file <span class="op">=</span> <span class="st">"data/processed/corrected-ppis-lu-sovon/corrected_ppi_hrw_lu_sovon.RDS"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">ppi_dhl</span>, file <span class="op">=</span> <span class="st">"data/processed/corrected-ppis-lu-sovon/corrected_ppi_dhl_lu_sovon.RDS"</span><span class="op">)</span></code></pre></div>

</div>
</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="annotating-land-use.html"><span class="header-section-number">3</span> Annotating land use</a></div>
<div class="next"><a href="processing-count-results.html"><span class="header-section-number">5</span> Processing count results</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#annotating-count-areas"><span class="header-section-number">4</span> Annotating count areas</a></li>
<li><a class="nav-link" href="#processing-environment-3"><span class="header-section-number">4.1</span> Processing environment</a></li>
<li><a class="nav-link" href="#annotate-ppis-with-waterbird-area-codes"><span class="header-section-number">4.2</span> Annotate PPIs with waterbird area codes</a></li>
<li>
<a class="nav-link" href="#annotate-ppis-with-point-transect-counts"><span class="header-section-number">4.3</span> Annotate PPIs with point-transect-counts</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#loading-ptt-points"><span class="header-section-number">4.3.1</span> Loading PTT points</a></li>
<li><a class="nav-link" href="#calculate-interpoint-distances"><span class="header-section-number">4.3.2</span> Calculate interpoint distances</a></li>
</ul>
</li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/barthoekstra/fireworks/blob/master/04.Annotate-count-areas.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/barthoekstra/fireworks/edit/master/04.Annotate-count-areas.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Fireworks</strong>" was written by Bart Hoekstra. It was last built on 2021-03-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
