<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>7 Composite all PPIs | Fireworks</title>
<meta name="author" content="Bart Hoekstra">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdn.jsdelivr.net/npm/fuse.js@6.4.2"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.5.1/jquery-3.5.1.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.2.4.9002/tabs.js"></script><script src="libs/bs3compat-0.2.4.9002/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/accessible-code-block-0.0.1/empty-anchor.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><script src="https://cdn.jsdelivr.net/autocomplete.js/0/autocomplete.jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/mark.js@8.11.1/dist/mark.min.js"></script><!-- CSS -->
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Fireworks</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html">Preface</a></li>
<li class="book-part">Weather radar data</li>
<li><a class="" href="selecting-firework-take-off-moment.html"><span class="header-section-number">1</span> Selecting firework take-off moment</a></li>
<li><a class="" href="radar-data-preprocessing.html"><span class="header-section-number">2</span> Radar Data Preprocessing</a></li>
<li class="book-part">Land use</li>
<li><a class="" href="annotating-land-use.html"><span class="header-section-number">3</span> Annotating land use</a></li>
<li class="book-part">Sovon counts</li>
<li><a class="" href="annotating-count-areas.html"><span class="header-section-number">4</span> Annotating count areas</a></li>
<li><a class="" href="processing-count-results.html"><span class="header-section-number">5</span> Processing count results</a></li>
<li><a class="" href="apply-processing-to-all-ppis.html"><span class="header-section-number">6</span> Apply processing to all PPIs</a></li>
<li><a class="active" href="composite-all-ppis.html"><span class="header-section-number">7</span> Composite all PPIs</a></li>
<li class="book-part">Fireworks disturbance</li>
<li><a class="" href="modelling-fireworks-disturbance.html"><span class="header-section-number">8</span> Modelling fireworks disturbance</a></li>
<li><a class="" href="quantifying-model-uncertainty.html"><span class="header-section-number">9</span> Quantifying model uncertainty</a></li>
<li class="book-part">Figures</li>
<li><a class="" href="figure-1-data-overview.html"><span class="header-section-number">10</span> Figure 1: Data overview</a></li>
<li><a class="" href="figure-2-model-output.html"><span class="header-section-number">11</span> Figure 2: Model output</a></li>
<li><a class="" href="figure-3-species-composition.html"><span class="header-section-number">12</span> Figure 3: Species composition</a></li>
<li class="book-part">Appendix</li>
<li><a class="" href="generating-vps-for-den-helder-radar.html"><span class="header-section-number">13</span> Generating vertical profiles for Den Helder radar</a></li>
<li class="book-part">Other</li>
<li><a class="" href="references.html"><span class="header-section-number">14</span> References</a></li>
</ul>

        <div class="book-extra">
          <p><a id="book-repo" href="https://github.com/barthoekstra/fireworks">View book source <i class="fab fa-github"></i></a></p>
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="composite-all-ppis" class="section level1">
<h1>
<span class="header-section-number">7</span> Composite all PPIs<a class="anchor" aria-label="anchor" href="#composite-all-ppis"><i class="fas fa-link"></i></a>
</h1>
<p>With all the preprocessing done, we can now make composites of the PPIs to ‘solve’ the overlapping areas of the Den Helder and Herwijnen radars. While we’re at it, we will also render out these composites for <code>VIR</code>, to visualise the en-masse take-off of birds.</p>
<div id="processing-environment-6" class="section level2">
<h2>
<span class="header-section-number">7.1</span> Processing environment<a class="anchor" aria-label="anchor" href="#processing-environment-6"><i class="fas fa-link"></i></a>
</h2>
<div class="sourceCode" id="cb133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/adokter/bioRad">bioRad</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://docs.ropensci.org/magick">magick</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://purrr.tidyverse.org">purrr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/sjmgarnier/viridis">viridis</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span></code></pre></div>
</div>
<div id="generating-the-composite-ppis" class="section level2">
<h2>
<span class="header-section-number">7.2</span> Generating the composite PPIs<a class="anchor" aria-label="anchor" href="#generating-the-composite-ppis"><i class="fas fa-link"></i></a>
</h2>
<p>We will loop over all the Herwijnen and Den Helder PPIs we have generated so far to create composite PPIs for all included parameters. We generate these composites at a 500m, 1000m and 2000m resolution to later test at which resolution the models perform best. Additionally we will save the composites as a bunch of .png files that we can then use separately or inclued in the animated GIF below.</p>
<div class="sourceCode" id="cb134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/source.html">source</a></span><span class="op">(</span><span class="st">"R/comp_ppi.R"</span><span class="op">)</span>
<span class="va">hrw_ppis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/processed/final-ppis"</span>, <span class="st">"*NL62*"</span><span class="op">)</span><span class="op">)</span>
<span class="va">dhl_ppis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.glob.html">Sys.glob</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html">file.path</a></span><span class="op">(</span><span class="st">"data/processed/final-ppis"</span>, <span class="st">"*NL61*"</span><span class="op">)</span><span class="op">)</span>

<span class="va">generate_composites</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">hrw_ppis</span>, <span class="va">dhl_ppis</span>, <span class="va">res</span>, <span class="va">maxrange</span><span class="op">)</span> <span class="op">{</span>
  <span class="co"># Make a new empty PPI to store all composites in</span>
  <span class="va">template_ppi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">hrw_ppis</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span>
  <span class="va">all</span> <span class="op">&lt;-</span> <span class="va">template_ppi</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span>
  
  <span class="va">basemap</span> <span class="op">&lt;-</span> <span class="cn">NULL</span>
  
  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq_along</a></span><span class="op">(</span><span class="va">hrw_ppis</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
    <span class="va">ppi_hrw</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">hrw_ppis</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    <span class="va">ppi_dhl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">readRDS</a></span><span class="op">(</span><span class="va">dhl_ppis</span><span class="op">[</span><span class="va">i</span><span class="op">]</span><span class="op">)</span>
    
    <span class="co"># Set all columns to NA if further than maxrange from radar</span>
    <span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">dist_radar</span> <span class="op">&gt;</span> <span class="va">maxrange</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    <span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">ppi_dhl</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">$</span><span class="va">dist_radar</span> <span class="op">&gt;</span> <span class="va">maxrange</span>, <span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    
    <span class="va">params</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"VIR"</span>, <span class="st">"VID"</span>, <span class="st">"R"</span>, <span class="st">"overlap"</span>, <span class="st">"eta_sum"</span>, <span class="st">"eta_sum_expected"</span>, <span class="st">"dist_radar"</span>, <span class="st">"class"</span>,
                <span class="st">"urban"</span>, <span class="st">"agricultural"</span>, <span class="st">"semiopen"</span>, <span class="st">"forests"</span>, <span class="st">"wetlands"</span>, <span class="st">"waterbodies"</span>, <span class="st">"dist_urban"</span>, <span class="st">"human_pop"</span>,
                <span class="st">"wb_area_id"</span>, <span class="st">"wb_area_nr"</span>, <span class="st">"ptt_route"</span>, <span class="st">"wb_area_ha"</span>, <span class="st">"wb_total_biomass"</span>, <span class="st">"ptt_total_biomass"</span>, <span class="st">"total_biomass"</span>, 
                <span class="st">"wb_weighted_mean_weight"</span>, <span class="st">"ptt_weighted_mean_weight"</span>, <span class="st">"weighted_mean_weight"</span><span class="op">)</span>
    <span class="co"># All mean methods except for factors and urban area (set to max), because we want to strictly filter out fireworks</span>
    <span class="va">methods</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"min"</span>, <span class="st">"min"</span>,
                 <span class="st">"max"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, 
                 <span class="st">"factor"</span>, <span class="st">"factor"</span>, <span class="st">"factor"</span>, <span class="st">"factor"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span>,
                 <span class="st">"mean"</span>, <span class="st">"mean"</span>, <span class="st">"mean"</span><span class="op">)</span>
    <span class="va">cppi</span> <span class="op">&lt;-</span> <span class="fu">comp_ppi</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">ppi_hrw</span>, <span class="va">ppi_dhl</span><span class="op">)</span>, param <span class="op">=</span> <span class="va">params</span>, method <span class="op">=</span> <span class="va">methods</span>, res <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">res</span>, <span class="va">res</span><span class="op">)</span>, coverage <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span>
    
    <span class="co"># Set rain and background pixels to NA</span>
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">VIR</span><span class="op">[</span><span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">class</span> <span class="op">&lt;</span> <span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
    
    <span class="co"># Add coordinates</span>
    <span class="va">coords_cppi</span> <span class="op">&lt;-</span> <span class="fu">raster</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/xyFromCell.html">coordinates</a></span><span class="op">(</span><span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">coords_cppi</span><span class="op">[</span>, <span class="fl">1</span><span class="op">]</span>
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">coords_cppi</span><span class="op">[</span>, <span class="fl">2</span><span class="op">]</span>
    
    <span class="co"># Add pixel ID</span>
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>pixel <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/ranking.html">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span>
    
    <span class="co"># Solve different factors</span>
    <span class="va">solve_factors</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="va">r</span> <span class="op">&lt;-</span> <span class="cn">NA</span> <span class="op">}</span>
      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">}</span>
      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">}</span>
      <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">&amp;&amp;</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
        <span class="kw">if</span> <span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="va">x</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span> <span class="op">{</span>
          <span class="va">r</span> <span class="op">&lt;-</span> <span class="cn">NA</span>
        <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span>
          <span class="va">r</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>
        <span class="op">}</span>
      <span class="op">}</span>
      <span class="va">r</span>
    <span class="op">}</span>
    
    <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">methods</span> <span class="op">==</span> <span class="st">"factor"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">params</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html">apply</a></span><span class="op">(</span><span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span><span class="op">[</span><span class="va">params</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span>, <span class="fl">1</span>, <span class="va">solve_factors</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">cppi</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"data/processed/composite-ppis/"</span>, <span class="va">res</span>, <span class="st">"m/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/strptime.html">strftime</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">datetime</span>, format <span class="op">=</span> <span class="st">"%Y%m%d%H%M"</span><span class="op">)</span>, <span class="st">".RDS"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
    
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">@</span><span class="va">data</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>datetime <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.POSIXlt.html">as.POSIXct</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">datetime</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
      <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind.html">bind_rows</a></span><span class="op">(</span><span class="va">all</span><span class="op">)</span> <span class="op">-&gt;</span> <span class="va">all</span>
    
    <span class="kw">if</span> <span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span> <span class="op">{</span>
      <span class="va">basemap</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://adokter.github.io/bioRad/reference/download_basemap.html">download_basemap</a></span><span class="op">(</span><span class="va">cppi</span>, alpha <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>
    <span class="op">}</span>
    
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">VIR</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log10</a></span><span class="op">(</span><span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">VIR</span><span class="op">)</span>
    <span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">VIR</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">cppi</span><span class="op">$</span><span class="va">data</span><span class="op">$</span><span class="va">VIR</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span>
    
    <span class="fu">bioRad</span><span class="fu">::</span><span class="fu"><a href="https://adokter.github.io/bioRad/reference/map.html">map</a></span><span class="op">(</span><span class="va">cppi</span>, map <span class="op">=</span> <span class="va">basemap</span>, radar_size <span class="op">=</span> <span class="fl">1</span>, xlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">3.1</span>, <span class="fl">6.8</span><span class="op">)</span>, ylim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">51</span>, <span class="fl">54</span><span class="op">)</span>, zlim <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4.5</span><span class="op">)</span>,
                palette <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/viridisLite/man/viridis.html">viridis</a></span><span class="op">(</span><span class="fl">256</span>, option <span class="op">=</span> <span class="st">"viridis"</span>, alpha <span class="op">=</span> <span class="fl">0.6</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>title <span class="op">=</span> <span class="st">"Fireworks NYE 2017-2018"</span>,
           subtitle <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">datetime</span>, <span class="st">' UTC'</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>

    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsave.html">ggsave</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"data/plots/vir-ppis/"</span>, <span class="va">res</span>, <span class="st">"m/"</span>, <span class="fu"><a href="https://rdrr.io/r/base/strptime.html">strftime</a></span><span class="op">(</span><span class="va">ppi_hrw</span><span class="op">$</span><span class="va">datetime</span>, format <span class="op">=</span> <span class="st">"%Y%m%d%H%M"</span><span class="op">)</span>, <span class="st">".png"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
  <span class="op">}</span>
  
  <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html">saveRDS</a></span><span class="op">(</span><span class="va">all</span>, file <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"data/processed/all_"</span>, <span class="va">res</span>, <span class="st">"m.RDS"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>

<span class="co"># Somehow this often hangs despite ample memory available, in which case better executed serially.</span>
<span class="co"># r &lt;- parallel::mclapply(c(500, 1000, 2000), function(x) { generate_composites(hrw_ppis, dhl_ppis, res = x, maxrange = 66000)},</span>
<span class="co">#                         mc.cores = 3, mc.preschedule = FALSE)</span>
<span class="va">r</span> <span class="op">&lt;-</span> <span class="fu">parallel</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/parallel/mclapply.html">mclapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">2000</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span> <span class="fu">generate_composites</span><span class="op">(</span><span class="va">hrw_ppis</span>, <span class="va">dhl_ppis</span>, res <span class="op">=</span> <span class="va">x</span>, maxrange <span class="op">=</span> <span class="fl">66000</span><span class="op">)</span><span class="op">}</span>,
                        mc.cores <span class="op">=</span> <span class="fl">3</span>, mc.preschedule <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></code></pre></div>
</div>
<div id="visualising-the-composites" class="section level2">
<h2>
<span class="header-section-number">7.3</span> Visualising the composites<a class="anchor" aria-label="anchor" href="#visualising-the-composites"><i class="fas fa-link"></i></a>
</h2>
<p>In order to run this <em>comparatively simple</em> conversion to a GIF of the PPIs, it may be necessary to increase the memory available to ImageMagick by changing the memory policy in <code>/etc/ImageMagick-6/policy.xml</code>. Additionally, we will reduce the resolution of the animated GIF and we’ll stick to the 1000m resolution PPIs.</p>
<div class="sourceCode" id="cb135"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">width</span> <span class="op">&lt;-</span> <span class="fl">800</span>

<span class="va">composites</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"data/plots/vir-ppis/1000m/"</span>, pattern <span class="op">=</span> <span class="st">"*.png"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>

<span class="va">process_image</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">img_path</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_read</a></span><span class="op">(</span><span class="va">img_path</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/transform.html">image_resize</a></span><span class="op">(</span><span class="fu"><a href="https://docs.ropensci.org/magick/reference/geometry.html">geometry_size_pixels</a></span><span class="op">(</span>width <span class="op">=</span> <span class="va">width</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_write</a></span><span class="op">(</span>path <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="fu">tools</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/tools/fileutils.html">file_path_sans_ext</a></span><span class="op">(</span><span class="va">img_path</span><span class="op">)</span>, <span class="st">".jpeg"</span>, sep <span class="op">=</span> <span class="st">""</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"jpeg"</span><span class="op">)</span>
<span class="op">}</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">file</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"data/plots/vir-ppis/"</span>, pattern <span class="op">=</span> <span class="st">"*.png"</span>, full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span>
  <span class="fu">process_image</span><span class="op">(</span><span class="va">file</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span>path <span class="op">=</span> <span class="st">"data/plots/vir-ppis/"</span>, pattern <span class="op">=</span> <span class="st">"*.jpeg"</span>, full.names <span class="op">=</span> <span class="cn">T</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="va">image_read</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_join</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/animation.html">image_animate</a></span><span class="op">(</span>fps <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://docs.ropensci.org/magick/reference/editing.html">image_write</a></span><span class="op">(</span><span class="st">"data/plots/vir-ppis/NYE-2017-2018.gif"</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/include_graphics.html">include_graphics</a></span><span class="op">(</span><span class="st">"data/plots/vir-ppis/NYE-2017-2018.gif"</span><span class="op">)</span></code></pre></div>
<div class="figure">
<img src="/mnt/fireworks/plots/vir-ppis/NYE-2017-2018.gif" alt="Animation of VIRs during NYE 2017-2018"><p class="caption">
(#fig:composite_ppi_animation)Animation of VIRs during NYE 2017-2018
</p>
</div>

</div>
</div>



  <div class="chapter-nav">
<div class="prev"><a href="apply-processing-to-all-ppis.html"><span class="header-section-number">6</span> Apply processing to all PPIs</a></div>
<div class="next"><a href="modelling-fireworks-disturbance.html"><span class="header-section-number">8</span> Modelling fireworks disturbance</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#composite-all-ppis"><span class="header-section-number">7</span> Composite all PPIs</a></li>
<li><a class="nav-link" href="#processing-environment-6"><span class="header-section-number">7.1</span> Processing environment</a></li>
<li><a class="nav-link" href="#generating-the-composite-ppis"><span class="header-section-number">7.2</span> Generating the composite PPIs</a></li>
<li><a class="nav-link" href="#visualising-the-composites"><span class="header-section-number">7.3</span> Visualising the composites</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
<li><a id="book-source" href="https://github.com/barthoekstra/fireworks/blob/master/07.Composite-all-PPIs.Rmd">View source <i class="fab fa-github"></i></a></li>
          <li><a id="book-edit" href="https://github.com/barthoekstra/fireworks/edit/master/07.Composite-all-PPIs.Rmd">Edit this page <i class="fab fa-github"></i></a></li>
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Fireworks</strong>" was written by Bart Hoekstra. It was last built on 2021-03-22.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>
</html>
