# Composite all PPIs

With all the preprocessing done, we can now make composites of the PPIs to 'solve' the overlapping areas of the Den Helder and Herwijnen radars. While we're at it, we will also render out these composites, to visualise the en-masse take-off of birds.

## Setting-up the environment

```{r setup-image-processing-environment}
library(bioRad)
library(ggplot2)
library(magick)
library(purrr)
library(viridis)
library(dplyr)
```

## Generating the composite PPIs

We will loop over all the Herwijnen and Den Helder PPIs we have generated so far, create composite PPIs for these and additionally save these as a bunch of .png files we can use separately or include in the animated GIF below.

```{r generating_composites, fig.width=10, fig.height=10, message=FALSE, warning=FALSE, eval=full_repro}
source("R/comp_ppi.R")
hrw_ppis <- Sys.glob(file.path("data/processed/final-ppis", "*NL62*"))
dhl_ppis <- Sys.glob(file.path("data/processed/final-ppis", "*NL61*"))

# Make a new empty PPI to store all composites in
template_ppi <- readRDS(hrw_ppis[1])
all <- template_ppi$data@data %>%
  filter(row_number() == 0)

basemap <- NULL

for (i in seq_along(hrw_ppis)) {
  ppi_hrw <- readRDS(hrw_ppis[i])
  ppi_dhl <- readRDS(dhl_ppis[i])
  
  ppi_hrw$data$VID[ppi_hrw$data$VIR == 0] <- NA
  ppi_hrw$data$VIR[ppi_hrw$data$VIR == 0] <- NA
  ppi_dhl$data$VID[ppi_dhl$data$VIR == 0] <- NA
  ppi_dhl$data$VIR[ppi_dhl$data$VIR == 0] <- NA
  
  params <- c("VIR", "VID", "R", "overlap", "eta_sum", "eta_sum_expected", "dist_radar", 
              "urban", "agricultural", "semiopen", "forests", "wetlands", "waterbodies", "dist_urban", "human_pop",
              "wb_area_id", "wb_area_nr", "ptt_route", "wb_area_ha", "wb_total_biomass", "ptt_total_biomass", "total_biomass")
  methods <- c("mean", "mean", "mean", "mean", "mean", "mean", "min",
               "max", "mean", "mean", "mean", "mean", "mean", "mean", "mean", 
               "factor", "factor", "factor", "factor", "mean", "mean", "mean")
  cppi <- comp_ppi(list(ppi_hrw, ppi_dhl), param = params, method = methods, res = c(500, 500), coverage = "count")
  
  # Add coordinates
  coords_cppi <- raster::coordinates(cppi$data)
  cppi$data$x <- coords_cppi[, 1]
  cppi$data$y <- coords_cppi[, 2]
  
  # Add pixel ID
  cppi$data@data %>%
    mutate(pixel = row_number()) -> cppi$data@data
  
  saveRDS(cppi, file = paste("data/processed/composite-ppis/", strftime(ppi_hrw$datetime, format = "%Y%m%d%H%M"), ".RDS", sep = ""))
  
  cppi$data@data %>%
    mutate(datetime = as.POSIXct(ppi_hrw$datetime)) %>%
    bind_rows(all) -> all
  
  if (i == 1) {
    basemap <- download_basemap(cppi, alpha = 0.3)
  }
  
  cppi$data$VIR <- log10(cppi$data$VIR)
  cppi$data$VIR[is.na(cppi$data$VIR)] <- 0
  
  bioRad::map(cppi, map = basemap, radar_size = 1, xlim = c(3.1, 6.8), ylim = c(51, 54), zlim = c(0, 4.5), 
      palette = viridis(256, option = "viridis", alpha = 0.6)) + 
    labs(title = "Fireworks NYE 2017-2018",
         subtitle = paste(ppi_hrw$datetime, ' UTC', sep = ""))
  
  ggsave(paste("data/plots/vir-ppis/", strftime(ppi_hrw$datetime, format = "%Y%m%d%H%M"), ".png", sep = ""))
}

saveRDS(all, file = "data/processed/all.RDS")
```

## Visualising the composites

In order to run this _comparatively simple_ conversion to a GIF of the PPIs, it may be necessary to increase the memory available to ImageMagick by changing the memory policy in `/etc/ImageMagick-6/policy.xml`. Additionally, we will reduce the resolution of the animated GIF.

```{r process-large-composites-to-animated-gif, eval=full_repro}
width <- 800

composites <- list.files(path = "data/plots/vir-ppis/", pattern = "*.png", full.names = TRUE)

process_image <- function(img_path) {
  image_read(img_path) %>%
    image_resize(geometry_size_pixels(width = width)) %>%
    # image_convert(format = "jpeg") %>%
    image_write(path = paste(tools::file_path_sans_ext(img_path), ".jpeg", sep = ""), format = "jpeg")
}

for (file in list.files(path = "data/plots/vir-ppis/", pattern = "*.png", full.names = TRUE)) {
  process_image(file)
}

list.files(path = "data/plots/vir-ppis/", pattern = "*.jpeg", full.names = T) %>%
  purrr::map(image_read) %>%
  image_join() %>%
  image_animate(fps = 2) %>%
  image_write("data/plots/vir-ppis/NYE-2017-2018.gif")
```

```{r composite_ppi_animation, fig.cap='Animation of VIRs during NYE 2017-2018'}
knitr::include_graphics("data/plots/vir-ppis/NYE-2017-2018.gif")
```

